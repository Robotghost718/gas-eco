<script>
  /* global Inventory */
  /* exported Form */
  /**
   * @param {obj} - passing in an existing form makes a copy of that form
   * @param {Boolean} duplicating Indicates the obj is a Form we want to duplicate
   */
  function Form(
    {
      bookedStudents = null,
      bookingId = null,
      contact = null,
      endTime = null,
      id = null,
      location = null,
      overnight = null,
      project = null,
      startTime = null,
      tape = null,
      hash = null,
      items = null,
      notes = [],
      students = [],
    },
    duplicating = false
  ) {
    if (duplicating && items) {
      this.items = new Inventory();
      items.forEach((item) => {
        item.quantity = item.getQuantity();
        const copy = new Item(item);
        item.quantity = undefined;
        copy.checkIn = copy.checkOut = copy.notes = "";
        copy.checkedOut = copy.missing = false;
        this.items.push(copy);
      });
    } else this.items = new Inventory().setItems(items);
    this.bookedStudents = duplicating ? null : bookedStudents;
    this.bookingId = duplicating ? null : bookingId;
    this.contact = duplicating ? null : contact;
    this.endTime = endTime;
    this.id = duplicating ? null : id;
    this.location = location;
    this.project = duplicating ? null : project;
    this.overnight = duplicating ? null : overnight;
    this.startTime = startTime;
    this.tape = duplicating ? null : tape;
    this.hash = duplicating ? null : hash;
    this.notes = duplicating
      ? [
          {
            timestamp: Date.now(),
            author: "unknown",
            body: JSON.stringify([
              {
                name: "duplicated",
                value: id,
                timestamp: Date.now(),
              },
            ]),
          },
        ]
      : notes.slice();
    if (this.notes.length > 0) {
      // copy
      this.notes = this.notes.map((note) => {
        return typeof note === "object" ? { ...note } : note;
      });
    }
    this.students = students.slice();
    if (this.students.length > 0) {
      // copy
      this.students = this.students.map((student) => {
        return duplicating
          ? {
              ...student,
              checkIn: null,
              checkOut: null,
              left: false,
            }
          : { ...student };
      });
    }
  }
  Form.prototype.hasActiveStudent = function () {
    const studentCounter = function (count, student) {
      if (student.checkIn && !(student.checkOut || student.left)) {
        return count + 1;
      } else {
        return count;
      }
    };
    const activeStudents = this.students.reduce(studentCounter, 0);
    return activeStudents > 1;
  };
  Form.prototype.hasItemsOut = function () {
    return this.items.every((item) => {
      return item.checkOut && (!item.checkIn || !item.missing);
    });
  };
  Form.prototype.hasStudent = function (student) {
    return Boolean(this.students.find((s) => s.id == student.id));
  };
  /**
   * isBlank determines if a form is a new, blank form (could be called `isNew`)
   */
  Form.prototype.isBlank = function () {
    return this.id === null;
  };
  Form.prototype.isNoShow = function () {
    if (!this.id) return false;
    const gracePeriod = 30, // minutes
      start = new Date(this.startTime),
      now = Date.now();

    start.setMinutes(start.getMinutes() + gracePeriod);

    return (
      now > start.getTime() && !this.students.some((student) => student.checkIn)
    );
  };
  Form.prototype.isReadyToClose = function () {
    // Need at least 1 check-in, and everyone checked-in must be checked-out
    return (
      this.students.some((student) => student.checkIn) &&
      this.students.every((student) => {
        if (student.checkIn) {
          return student.checkOut || student.left;
        }
        return true;
      })
    );
  };
  Form.prototype.isReadyToPost = function () {
    if (!this.location) {
      return false;
    }
    if (this.startTime === this.endTime) {
      return false;
    }
    const someStudentsAreActive = this.students.some(
      (s) => s.checkIn && !(s.checkOut || s.left)
    );
    const someItemsAreOut = this.items.some(
      (i) => i.checkOut && !(i.checkIn || i.missing)
    );
    if (someItemsAreOut && !someStudentsAreActive) {
      return false;
    }
    if (this.students.length == 0) {
      // finally, is anybody on the form?
      return false;
    }
    return true;
  };
  Form.prototype.makeAdvanceBooking = function () {
    if (!this.isBlank()) {
      throw new Error("advance booking only allowed with new, unsaved forms");
    }
    // remove check-ins from students
    this.students.forEach((student) => {
      student.checkIn = null;
    });
    this.items.forEach((item) => {
      item.checkOut = "";
      item.checkedOut = false;
    });
  };
  Form.prototype.stringify = function () {
    const copy = Object.assign({}, this);
    copy.items = this.items.archive();
    return JSON.stringify(copy);
  };
</script>
