<script>
  "use strict";
  /* global DateUtils Item FormItem */
  /* exported Form */
  class Form {
    constructor({
      bookedStudents = "",
      bookingId = null,
      contact = "",
      endTime = "",
      id = null,
      location = "",
      overnight = false,
      project = "",
      startTime = "",
      tape = false,
      hash = "",
      items = [], // FormItem[], **not atomic Item[]**
      notes = [],
      students = [],
    }) {
      this.items = Object.freeze(items.map((item) => new FormItem(item)));
      this.bookedStudents = String(bookedStudents);
      this.bookingId = bookingId;
      this.contact = String(contact);
      this.endTime = String(endTime);
      this.id = id;
      this.location = String(location);
      this.project = String(project);
      this.overnight = Boolean(overnight);
      this.startTime = String(startTime);
      this.tape = Boolean(tape);
      this.hash = hash;
      this.notes = Object.freeze(
        notes.map((note) => (typeof note === "object" ? { ...note } : note))
      );
      this.students = Object.freeze(
        students.slice().map((student) => ({ ...student }))
      );

      return Object.freeze(this);
    }

    duplicate() {
      const { copyTime, getFormattedDateTime } = DateUtils;
      const copy = this.makeAdvanceBooking();
      return new Form({
        ...copy,
        startTime: getFormattedDateTime(copyTime(new Date(this.startTime))),
        endTime: getFormattedDateTime(copyTime(new Date(this.endTime))),
      });
    }

    hasActiveStudent() {
      const studentCounter = function (count, student) {
        if (student.checkIn && !(student.checkOut || student.left)) {
          return count + 1;
        } else {
          return count;
        }
      };
      const activeStudents = this.students.reduce(studentCounter, 0);
      return activeStudents > 1;
    }

    hasItemsOut() {
      if (!this.items.length) return false;
      return this.items.every(
        ({ timeCheckedOutByServer, timeCheckedInByClient, missing }) => {
          return timeCheckedOutByServer && !timeCheckedInByClient && !missing;
        }
      );
    }

    hasStudent(student) {
      return Boolean(this.students.find((s) => s.id == student.id));
    }

    isAdvanceBooking() {
      return (
        this.students.length &&
        this.students.every(({ checkIn }) => checkIn === null)
      );
    }

    // is this a new, unsaved (in Sheets) form?
    isBlank() {
      return this.id === null;
    }

    isNoShow() {
      if (!this.id) return false;
      const gracePeriod = 30, // minutes
        start = new Date(this.startTime),
        now = Date.now();

      start.setMinutes(start.getMinutes() + gracePeriod);

      return (
        now > start.getTime() && !this.students.some(({ checkIn }) => checkIn)
      );
    }

    isReadyToClose() {
      // Need at least 1 check-in, and everyone checked-in must be checked-out
      return (
        this.students.some(({ checkIn }) => checkIn) &&
        this.students.every(
          ({ checkIn, checkOut, left }) => !checkIn || checkOut || left
        )
      );
    }

    makeAdvanceBooking() {
      const copyItem = (item) =>
        new Item({
          ...item,
          missing: false,
          timeCheckedInByClient: "",
          timeCheckedInByServer: "",
          timeCheckedOutByClient: "",
          timeCheckedOutByServer: "",
        });
      const copyFormItem = (formItem) =>
        new FormItem({
          ...formItem,
          items: formItem.items.map(copyItem),
        });
      return new Form({
        ...this,
        id: null,
        notes: [],
        students: this.students.map((student) => ({
          ...student,
          checkIn: null,
          checkOut: null,
          left: false,
        })),
        items: this.items.reduce((resetFormItems, formItem) => {
          if (!resetFormItems.length) return [copyFormItem(formItem)];
          const index = resetFormItems.findIndex(
            ({ barcode, description, id }) =>
              barcode === formItem.barcode &&
              description === formItem.description &&
              id === formItem.id
          );
          if (!index) return [...resetFormItems, copyFormItem(formItem)];
          const existing = resetFormItems.splice(index, 1);
          return [
            ...resetFormItems,
            new FormItem({
              ...existing,
              // merge items
              items: [...existing.items, ...formItem.items.map(copyItem)],
            }),
          ];
        }, []),
      });
    }
  }
</script>
