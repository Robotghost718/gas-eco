<script>
  /* global DateUtils HTML Utility OpenFormsTable */
  /* exported OpenFormsPage */
  function OpenFormsPage({ openForms, setForm }) {
    return HTML.page({
      name: "openForms",
      children: [
        HTML.createElement("h2", { textContent: "Open Forms" }),
        HTML.createElement("h3", {
          textContent: "click on a form to view and edit",
        }),
        HTML.table(
          HTML.createElement("thead", {
            class: "open",
            children: [
              HTML.headerCell({ child: HTML.documentIcon() }),
              ...["startTime", "endTime", "location", "students"].map((text) =>
                HTML.createElement("th", {
                  "data-sort": text,
                  textContent: Utility.uncamelCase(text),
                })
              ),
            ],
          }),
          OpenFormsTable({ openForms, setForm })
        ),
        HTML.createElement("h2", { textContent: "Equipment Checked Out" }),
        HTML.table(
          HTML.createElement("thead", {
            class: "equipmentOut",
            child: HTML.row(
              ...["Item", "Id", "Location", "Students", "End Time"].map(
                HTML.headerCell
              )
            ),
          }),
          HTML.createElement("tbody", {
            class: "equipmentOut",
          })
        ),
      ],
    });

    function displaySortedBy(stack, tableHead) {
      Array.from(tableHead.querySelectorAll("th")).forEach((header) => {
        header.classList.remove("sortedBy", "ascending", "descending");
        if (header.dataset.sort === stack.sortBy) {
          header.classList.add(
            "sortedBy",
            stack.sortDescending ? "descending" : "ascending"
          );
        }
      });
    }

    function makeOpenFormTableRows(form) {
      form.items
        .filter((item) => item.checkedOut)
        .forEach((item) => populateEquipmentOutList(form, item));

      let type = "inactive", // assume inactive
        endTime = DateUtils.parseFormattedDate(form.endTime).getTime(),
        fifteenMinutes = 15 * 60 * 1000, // milliseconds
        now = Date.now();
      // determine if active, ending soon, or late (green, yellow, red)
      if (form.students.some((student) => student.checkIn)) {
        type = "active";
      }
      if (type === "active" && now > endTime) {
        type = "late";
      }
      if (type === "active" && now > endTime - fifteenMinutes) {
        type = "endingSoon";
      }
      formsTableBody.appendChild(
        HTML.createElement("tr", {
          class: type,
          "data-id": form.id,
          children: [
            HTML.createElement("td", { child: HTML.documentIcon() }),
            ...[
              form.startTime,
              form.endTime,
              form.location,
              form.bookedStudents ||
                form.students.map((student) => student.name).join(", "),
            ].map((textContent) => HTML.createElement("td", { textContent })),
          ],
        })
      );
    }

    function populateEquipmentOutList(
      { location, students, endTime, id: formId },
      { description, id: itemId }
    ) {
      equipmentTableBody.appendChild(
        HTML.createElement("tr", {
          "data-id": formId,
          children: [
            description,
            itemId,
            location,
            students.map((student) => student.name).join(", "),
            endTime,
          ].map((textContent) => HTML.createElement("td", { textContent })),
        })
      );
    }
  }
</script>
