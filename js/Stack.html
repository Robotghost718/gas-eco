<script>
/* global Form */
/* exported Stack */
/**
 * Stack is a container for Form objects,
 *   wraps a private array with custom methods
 */
function Stack() {
  let forms = [],
      currentIndex = 0;
  this.getCurrentForm = function() {
    return forms[currentIndex];
  };
  this.getCurrentIndex = function() { return currentIndex; };
  /**
   * importForms intakes an array of plain objects from the server
   *   and creates Form objects
   */
  this.importForms = function(array) {
    forms = array;
    forms.forEach((form, index, array) => {
      array[index] = new Form(form);
    });
  };
  this.replace = function(form) {
    if (! (form instanceof Form)) {
      throw new Error(`${form} is not a Form`);
    }
    const index = forms.findIndex(f => ! f.id || f.id == form.id);
    if (index < 0) {
      throw new Error(`cannot find ${form.id} in local forms`);
    }
    currentIndex = index;
    forms[index] = form;
  };
  /**
   * replaceCurrent is used by the collision resolve handler to overwrite
   *   whatever the current form is
   */
  this.replaceCurrent = function(form) {
    forms[currentIndex] = form;
  };
  this.updateIndex = function(form) {
    const index = forms.findIndex(f => ! f.id || f.id == form.id);
    if (index < 0) {
      throw new Error(`cannot find ${form.id} in local forms`);
    }
    currentIndex = index;
  };
  /**
   * @returns Form[] - NOT Stack
   */
  this.filter = function(func) {
    return forms.filter(func);
  };
  this.findIndex = function(func) {
    return forms.findIndex(func);
  };
  this.forEach = function(func) {
    forms.forEach(func);
  };
  this.sort = function(func) {
    forms.sort(func);
  };
  this.reverse = function() {
    forms.reverse();
  };
  this.pop = function() {
    --currentIndex;
    return forms.pop();
  };
  this.push = function(form) {
    if (! (form instanceof Form)) {
      throw new Error(`${form} is not a Form`);
    }
    const length = forms.push(form);
    currentIndex = length - 1;
  };
  this.getLength = function() { return forms.length; };
  this.getByID = function(id) {
    let index = forms.findIndex(form => form.id == id);
    if (index < 0) {
      return null;
    }
    currentIndex = index;
    return forms[index];
  };
  this.getNext = function() {
    if (currentIndex === forms.length - 1) { // we're already at the end
      return null;
    }
    return forms[++currentIndex];
  };
  this.getPrevious = function() {
    if (currentIndex === 0) { // we're already at the beginning
      return null;
    }
    return forms[--currentIndex];
  };
}
</script>
