<script>
  /* global Form DateUtils */
  /* exported Stack */
  /**
   * Stack is a container for Form objects,
   *   wraps a private array with custom methods
   *
   */
  function Stack() {
    let forms = [],
      currentIndex = 0,
      initialized = false;
    this.isInitialized = function () {
      return initialized;
    };
    this.setForms = function (formArray) {
      if (
        Array.isArray(formArray) &&
        (formArray[0] instanceof Form || formArray.length === 0)
      ) {
        forms = formArray.slice();
        currentIndex = 0;
      }
    };
    this.sortBy = "startTime";
    this.sortDescending = false;
    this.getCurrentForm = function () {
      return forms[currentIndex];
    };
    this.getCurrentIndex = function () {
      return currentIndex;
    };
    /**
     * importForms intakes an array of plain objects from the server
     *   and creates Form objects
     */
    this.importForms = function (array) {
      if (!array) {
        throw new Error("importForms expects array");
      }
      forms = array;
      forms.forEach((form, index, array) => {
        array[index] = new Form(form);
      });
      initialized = true;
      return this;
    };
    this.replace = function (form) {
      if (!(form instanceof Form)) {
        throw new Error(`${form} is not a Form`);
      }
      const index = forms.findIndex((f) => !f.id || f.id == form.id);
      if (index < 0) {
        throw new Error(`cannot find ${form.id} in local forms`);
      }
      currentIndex = index;
      forms[index] = form;
      return this;
    };
    /**
     * replaceCurrent is used by the collision resolve handler to overwrite
     *   whatever the current form is
     */
    this.replaceCurrent = function (form) {
      forms[currentIndex] = form;
    };
    this.updateIndex = function (form) {
      const index = forms.findIndex((f) => !f.id || f.id == form.id);
      if (index < 0) {
        throw new Error(`cannot find ${form.id} in local forms`);
      }
      currentIndex = index;
      return this;
    };
    /**
     * @returns Form[] - NOT Stack
     */
    this.filter = function (func) {
      return forms.filter(func);
    };
    this.findIndex = function (func) {
      return forms.findIndex(func);
    };
    this.forEach = function (func) {
      forms.forEach(func);
    };
    this.sort = function (func) {
      forms.sort(func);
    };
    this.reverse = function () {
      forms.reverse();
    };
    this.pop = function () {
      --currentIndex;
      return forms.pop();
    };
    this.push = function (form) {
      if (!(form instanceof Form)) {
        throw new Error(`${form} is not a Form`);
      }
      const length = forms.push(form);
      currentIndex = length - 1;
    };
    this.getLength = function () {
      return forms.length;
    };
    this.getByID = function (id) {
      let index = forms.findIndex((form) => form.id == id);
      if (index < 0) {
        return null;
      }
      currentIndex = index;
      return forms[index];
    };
    this.getNext = function () {
      if (currentIndex === forms.length - 1) {
        // we're already at the end
        return null;
      }
      return forms[++currentIndex];
    };
    this.getPrevious = function () {
      if (currentIndex === 0) {
        // we're already at the beginning
        return null;
      }
      return forms[--currentIndex];
    };
  }
  Stack.prototype.sortForms = function (sortBy) {
    if (!sortBy) {
      sortBy = this.sortBy;
    } else {
      if (sortBy === this.sortBy) {
        this.sortDescending = !this.sortDescending;
      }
      this.sortBy = sortBy;
    }
    let compare;
    switch (sortBy) {
      case "startTime":
      case "endTime":
        compare = function (a, b) {
          let dateA = DateUtils.parseFormattedDate(a[sortBy]).getTime(),
            dateB = DateUtils.parseFormattedDate(b[sortBy]).getTime();
          if (dateA < dateB) {
            return -1;
          }
          if (dateA > dateB) {
            return 1;
          }
          if (dateA == dateB) {
            return 0;
          }
        };
        break;
      case "location":
        compare = function (a, b) {
          if (a[sortBy] < b[sortBy]) {
            return -1;
          }
          if (a[sortBy] > b[sortBy]) {
            return 1;
          }
          if (a[sortBy] == b[sortBy]) {
            return 0;
          }
        };
        break;
      case "contact":
      case "tape":
      case "overnight":
      case "items":
      case "project":
      case "bookingId":
        compare = function (a, b) {
          if (a[sortBy] < b[sortBy]) {
            return -1;
          }
          if (a[sortBy] > b[sortBy]) {
            return 1;
          }
          if (a[sortBy] == b[sortBy]) {
            return 0;
          }
        };
        break;
      case "bookedStudents":
      case "students":
        compare = function (a, b) {
          let nameSort = function (c, d) {
            if (c.name < d.name) {
              return -1;
            }
            if (c.name > d.name) {
              return 1;
            }
            if (c.name == d.name) {
              return 0;
            }
          };
          a.students.sort(nameSort);
          b.students.sort(nameSort);
          if (a.students[0].name < b.students[0].name) {
            return -1;
          }
          if (a.students[0].name > b.students[0].name) {
            return 1;
          }
          if (a.students[0].name == b.students[0].name) {
            return 0;
          }
        };
        break;
      case "type":
        compare = function (a, b) {
          let active = function (student) {
            return student.checkIn;
          };
          a = +a.students.some(active);
          b = +b.students.some(active);
          if (a > b) {
            return -1;
          }
          if (a < b) {
            return 1;
          }
          if (a == b) {
            return 0;
          }
        };
        break;
    }
    this.sort(compare);
    if (this.sortDescending) {
      this.reverse();
    }
    return this;
  };
</script>
