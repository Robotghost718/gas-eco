<script>
  /* global DateUtils Form HTML Item Utility */
  /* exported CheckInButton */
  function CheckInButton({ form, item, disabled, onChange }) {
    const { createElement } = HTML;
    const { is, remove, replace } = Utility;
    const { getFormattedDateTime } = DateUtils;
    if (item.checkedOutAgain) {
      return document.createTextNode("");
    }
    if (item.missing) {
      return createElement("span", {
        class: "alert",
        textContent: "ITEM IS MISSING",
      });
    }
    if (disabled || item.timeCheckedInByClient) {
      return document.createTextNode(item.timeCheckedInByClient);
    }
    if (!item.timeCheckedOutByServer) {
      return createElement("button", {
        class: "create",
        textContent: "Remove",
        onClick: () => {
          onChange({
            form: new Form({
              ...form,
              items: remove(form.items, is(item)),
            }),
            change: {
              target: {
                name: "items",
                value: item.description + " removed",
              },
            },
          });
        },
      });
    }
    if (!item.timeCheckedInByClient && item.isSerialized()) {
      return createElement("i", {
        textContent: "Scan barcode to return",
      });
    }

    if (item.quantity > 1) {
      const quantitySelect = createElement("select", {
        class: "selectQuantity",
        children: [
          createElement("option", {
            value: "all",
            textContent: "All",
          }),
          ...Array.from({ length: item.quantity - 1 }).map((_, i) =>
            createElement("option", {
              textContent: String(i + 1),
            })
          ),
        ],
      });
      return createElement("span", {
        children: [
          createElement("button", {
            class: "action",
            textContent: "Check In",
            onClick: () =>
              onChange({
                form: new Form({
                  ...form,
                  items: replace(
                    form.items,
                    is(item),
                    new Item({
                      ...item,
                      quantityIn:
                        quantitySelect.value === "all"
                          ? item.quantity
                          : +quantitySelect.value,
                      checkIn: getFormattedDateTime(new Date()),
                    })
                  ),
                }),
                change: {
                  target: {
                    name: "items",
                    value: `${item.id || item.description} check-in ${
                      quantitySelect.value
                    }`,
                  },
                },
              }),
          }),
          quantitySelect,
        ],
      });
    }
    return createElement("button", {
      class: "action",
      textContent: "Check In",
      onClick: () =>
        onChange({
          form: new Form({
            ...form,
            items: replace(
              form.items,
              is(item),
              new Item({
                ...item,
                checkIn: getFormattedDateTime(new Date()),
              })
            ),
          }),
          change: {
            target: {
              name: "items",
              value: `${item.id || item.description} check-in`,
            },
          },
        }),
    });
  }
</script>
