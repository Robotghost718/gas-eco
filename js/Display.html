<script>
/**
 * @param {Form} form
 * @param {bool} archived - is this a closed form?
 * @return void
 */
/* global app utility Form */
/* exported
     populateArchiveTable
     displayForm
     populateFormsTable
     toast
*/
function displayForm(form) {
  const formPage = app.pages.form;
  const els = formPage.elements;
  formPage.resetLocation();
  for (let key in form) {
    switch (key) {
      case 'items': {
        const items = form[key];
        utility.DOM.empty(els.itemList);
        if (items.getLength() > 0) {
          const slice = items.slice();
          slice.reverse().forEach(populateItemList);
        }
        break;
      }
      case 'notes': {
        utility.DOM.empty(els.noteSection);
        let notes = form[key];
        if (notes.length == 0) {
          els.form.notes.value = JSON.stringify([]);
          els.noteSection.classList.add('hidden');
        } else {
          for (let note of notes) {
            try {                    // Unintuitive use of try/catch: read carefully:
              JSON.parse(note.body); // (success == change log ) => ignore it
            } catch(e) {             // (  error == global note) => display it
              let p = document.createElement('p');
              p.textContent = 'Note: ' + '[' + note.author + '] ' + note.body;
              els.noteSection.appendChild(p);
            }
          }
          if (els.noteSection.firstChild) { // if it's not empty
            els.noteSection.classList.remove('hidden');
          } else {
            els.noteSection.classList.add('hidden');
          }
          els.form.notes.value = JSON.stringify(notes);
        }
        break;
      }
      case 'students': {
        let students = form[key];
        utility.DOM.empty(els.studentList);
        if (students.length > 0) {
          students.forEach(populateStudentList);
        }
        break;
      }
      case 'startTime': // fallthrough
      case 'endTime': // fallthrough
      case 'bookedStudents': // fallthrough
      case 'contact': // fallthrough
      case 'project': // fallthrough
      case 'tape': // fallthrough
      case 'overnight': // fallthrough
      case 'location': // fallthrough
        var td = document.querySelector('#' + key + 'Display');
        if (form[key]) { // There's data to display
          td.textContent = form[key];
          td.classList.remove('hidden');
          td.parentNode.classList.remove('hidden');
          if (td.nextElementSibling) {
            td.nextElementSibling.classList.add('hidden');
          }
          if (key == 'location' || key == 'startTime' || key == 'endTime') {
            els.form[key].value = form[key];
          }
          // if "Other" value, we need to put that value back into the select
          if (key == 'location' && els.form.location.value == "") {
            els.locationOtherOption.value = els.locationOtherOption.textContent = form[key];
            els.form[key].value = form[key];
          }
        } else { // There's not data, so maybe show an input for the user, and clear old data
          switch (key) {
            case 'startTime':
            case 'endTime':
              td.textContent = '';
              els.form[key].value = '';
              td.classList.add('hidden');
              td.nextElementSibling.classList.remove('hidden');
              var today = new Date(),
                  dateInput = td.nextElementSibling.firstElementChild,
                  hourInput = dateInput.nextElementSibling,
                  minuteInput = hourInput.nextElementSibling,
                  ampmInput = minuteInput.nextElementSibling;
              var hour = today.getHours(),
                  minutes = today.getMinutes();

              minuteInput.value = utility.date.roundMinutes(minutes);
              hourInput.value = utility.date.parseHours(hour);
              ampmInput.value = utility.date.parseAMPM(hour);
              dateInput.value = '' + today.getFullYear() + '-' +
                utility.date.zeropad((today.getMonth() + 1)) + '-' +
                utility.date.zeropad(today.getDate());

              break;
            case 'location':
              td.classList.add('hidden');
              td.nextElementSibling.classList.remove('hidden');
              els.locationSelect.value = 'none';
              break;
            default:
              td.parentNode.classList.add('hidden');
          }
        }
        break;
    }
  }

  // copy form
  app.pages.form.savedForm = new Form(form);

  // cleanup
  app.changes.clear();
  app.omnibox.clear();

  // indicate where this form is in the current stack, e.g. "1/6"
  const stack = app.pages.form.currentStack;
  els.currentFormstackDisplay.textContent = (stack.getCurrentIndex() + 1) +
    "/" + stack.getLength();

  if (stack === app.pages.archive.filteredStack) {
    formPage.disable();
  } else {
    formPage.enable();
  }

  app.spinner.element.classList.add('hidden');
  app.showPage(formPage);

}

/**
 * This is a procedure to display to the user a compact list of the open forms
 * @param {object []} forms - an array of Forms
 * @return {undefined} - updates html display for user
 */
function populateFormsTable(forms) {
  utility.DOM.empty(app.pages.openForms.elements.formsTableBody);
  utility.DOM.empty(app.pages.openForms.elements.equipmentTableBody);

  // if there's no forms...
  if (forms.getLength() == 0) {
    let cell = document.createElement('td'),
        row = document.createElement('tr');
    cell.textContent = 'No open forms';
    row.appendChild(cell);
    row.classList.add('hoveroff');
    app.pages.openForms.elements.formsTableBody.appendChild(row);

    return;
  }

  // else populate
  forms.forEach(makeOpenFormTableRows);

  // if makeOpenFormTableRows found no equipment out...
  if (!app.pages.openForms.elements.equipmentTableBody.firstChild) {
    let row = document.createElement('tr'),
        cell = document.createElement('td');
    cell.textContent = 'No equipment checked-out.';
    cell.style.pointerEvents = 'none';
    row.appendChild(cell);
    app.pages.openForms.elements.equipmentTableBody.appendChild(row);
  }
}

function makeOpenFormTableRows(form) {
  form.items.forEach(function(item) {
    if (item.checkedOut) {
      let itemInfo = [
        item.description, item.id, form.location,
        form.students, form.endTime, form.id
      ];
      populateEquipmentOutList(itemInfo);
    }
  });

  let row = utility.DOM.makeTableRow(
    'td',
    app.strings.documentIcon,
    form.startTime,
    form.endTime,
    form.location,
    (form.bookedStudents || form.students.map(student => student.name).join(', '))
  );
  let type = 'inactive', // assume inactive
      endTime = utility.date.parseFormattedDate(form.endTime).getTime(),
      fifteenMinutes = (15 * 60 * 1000), // milliseconds
      now = Date.now();
  row.setAttribute('data-id', form.id);
  // determine if active, ending soon, or late (green, yellow, red)
  if (form.students.some(student => student.checkIn)) {
    type = 'active';
  }
  if (type == 'active' && now > endTime) {
    type = 'late';
  }
  if (type == 'active' && now > (endTime - fifteenMinutes)) {
    type = 'endingSoon';
  }
  row.classList.add(type);
  app.pages.openForms.elements.formsTableBody.appendChild(row);
}

function populateEquipmentOutList(item) {
  let row = utility.DOM.makeTableRow(
    'td', item[0], item[1], item[2],
    item[3].map(student => student.name).join(', '), item[4]
  );
  row.setAttribute('data-id', item[5]);
  app.pages.openForms.elements.equipmentTableBody.appendChild(row);
}

function populateItemList(item) {
  let checkInButton, checkIn;
  const noteRow = document.createElement('tr'),
        notes = document.createElement('td'),
        quantity = item.getQuantity();
  if (! item.checkIn && ! item.isSerialized()) {
    const id = item.id ? item.id : item.barcode;
    checkInButton = `<button class="action"
                             value="checkInButton"
                             data-itemid="${id}">Check In</button>`;
    if (quantity > 1) {
      checkInButton += `<select data-itemid="${id}" class="selectQuantity">
        <option value="all">All</option>`;
      for (let i = 1; i < quantity; ++i) {
        checkInButton += `<option>${i}</option>`;
      }
      checkInButton += `</select>`;
    }
  } else if (! item.checkIn && item.isSerialized()) {
    checkInButton = `<i>Scan barcode to return</i>`;
  }
  if (item.missing == true) {
    checkIn = `<span class="alert">ITEM IS MISSING</span>`;
  } else {
    checkIn = checkInButton || item.checkIn;
  }
  const quantityCell = item.isSerialized() ? quantity :
    `<button class="quantity" value="itemQuantityChange">${quantity}</button>
     <button class="quantity" value="itemQuantityPlusOne">+</button>`;
  const itemRow = utility.DOM.makeTableRow(
    'td', quantityCell, item.description,
    item.id, item.checkOut, checkIn
  );
  itemRow.setAttribute('data-id', item.id);
  itemRow.setAttribute('data-barcode', item.barcode);
  if (! item.isSerialized()) {
    itemRow.classList.add('nonserialized');
  } else {
    itemRow.classList.add('serialized');
  }
  app.pages.form.elements.itemList.appendChild(itemRow);

  notes.setAttribute('colspan', 4);
  notes.classList.add('itemnotes');
  notes.textContent = 'Notes: ' + item.notes;
  noteRow.appendChild(notes);
  app.pages.form.elements.itemList.appendChild(noteRow);
}

function populateStudentList(student) {
  let checkOut;
  if (student.left){
    checkOut = `<span class="alert">DID NOT CHECK OUT</span>`;
  } else {
    checkOut = student.checkOut || `<i>Scan ID to sign out</i>`;
  }
  const studentRow = utility.DOM.makeTableRow(
    'td', student.name, student.netId, student.checkIn, checkOut
  );
  studentRow.setAttribute('data-netid', student.netId);
  app.pages.form.elements.studentList.appendChild(studentRow);
}

/**
 * @param {Stack} formStack
 */
function populateArchiveTable(formStack) {
  utility.DOM.empty(app.pages.archive.elements.tableBody);

  // if there's no forms...
  if (formStack.getLength() == 0) {
    let cell = document.createElement('td'),
        row = document.createElement('tr');
    cell.textContent = 'No forms matched your search.';
    cell.setAttribute("colspan", 12); // fill entire row
    row.appendChild(cell);
    row.classList.add('hoveroff');
    app.pages.archive.elements.tableBody.appendChild(row);

    return;
  }

  // else populate
  formStack.forEach(makeArchiveTableRows);
}

function makeArchiveTableRows(form) {
  let hasItems = (form.items.getLength() > 0) ? "YES" : "NO";
  let row = utility.DOM.makeTableRow(
    'td',
    app.strings.documentIcon,
    form.startTime,
    form.endTime,
    form.location,
    form.students.map(student => student.name).join(', '),
    hasItems,
    form.bookingId,
    form.bookedStudents,
    form.contact,
    form.project,
    form.tape? "YES" : "",
    form.overnight? "YES" : ""
  );
  row.setAttribute('data-id', form.id);
  app.pages.archive.elements.tableBody.appendChild(row);
}

function toast(message) {
  if (typeof message !== 'string') {
    throw new Error("toast requires string argument, got " + message);
  }
  const container = document.createElement("div");
  container.classList.add("toast");
  container.textContent = message;
  document.body.appendChild(container);
  window.setTimeout(() => container.remove(), 5000);
}
</script>
