<script>
  /**
   * @param {Form} form
   * @param {bool} archived - is this a closed form?
   * @return void
   */
  /* global app DateUtils HTML Form Utility */
  /* exported
       populateArchiveTable
       displayForm
       populateFormsTable
       modal
       toast
  */
  function displayForm(form) {
    const formPage = app.pages.form;
    const els = formPage.elements;
    formPage.resetLocation();
    for (const key in form) {
      switch (key) {
        case "items": {
          const items = form[key];
          HTML.empty(els.itemList);
          if (items.getLength() > 0) {
            const slice = items.slice();
            slice.reverse().forEach(populateItemList);
          }
          break;
        }
        case "notes": {
          HTML.empty(els.noteSection);
          let notes = form[key];
          if (notes.length == 0) {
            els.form.notes.value = JSON.stringify([]);
            els.noteSection.classList.add("hidden");
          } else {
            for (const note of notes) {
              if (!Utility.tryJsonParse(note.body)) {
                els.noteSection.appendChild(
                  HTML.createElement("p", {
                    textContent: `Note: [${note.author}] ${note.body}`,
                  })
                );
              }
            }
            if (els.noteSection.firstChild) {
              // if it's not empty
              els.noteSection.classList.remove("hidden");
            } else {
              els.noteSection.classList.add("hidden");
            }
            els.form.notes.value = JSON.stringify(notes);
          }
          break;
        }
        case "students": {
          const students = form[key];
          HTML.empty(els.studentList);
          if (students.length > 0) {
            students.forEach(populateStudentList);
          }
          break;
        }
        case "startTime": // fallthrough
        case "endTime": // fallthrough
        case "bookedStudents": // fallthrough
        case "contact": // fallthrough
        case "project": // fallthrough
        case "tape": // fallthrough
        case "overnight": // fallthrough
        case "location": // fallthrough
          var td = document.querySelector("#" + key + "Display");
          if (form[key]) {
            // There's data to display
            HTML.attributes(td, {
              textContent: form[key],
              removeClass: "hidden",
            });
            td.parentNode.classList.remove("hidden");
            if (td.nextElementSibling) {
              td.nextElementSibling.classList.add("hidden");
            }
            if (["location", "startTime", "endTime"].includes(key)) {
              els.form[key].value = form[key];
            }
            // if "Other" value, we need to put that value back into the select
            if (key === "location" && els.form.location.value == "") {
              els.locationOtherOption.value = els.locationOtherOption.textContent =
                form[key];
              els.form[key].value = form[key];
            }
          } else {
            // There's not data, so maybe show an input for the user, and clear old data
            switch (key) {
              case "startTime":
              case "endTime": {
                HTML.attributes(td, {
                  textContent: "",
                  class: "hidden",
                });
                els.form[key].value = "";
                td.nextElementSibling.classList.remove("hidden");
                const today = new Date(),
                  dateInput = td.nextElementSibling.firstElementChild,
                  hourInput = dateInput.nextElementSibling,
                  minuteInput = hourInput.nextElementSibling,
                  ampmInput = minuteInput.nextElementSibling;
                const hour = today.getHours(),
                  minutes = today.getMinutes();

                minuteInput.value = DateUtils.roundMinutes(minutes);
                hourInput.value = DateUtils.parseHours(hour);
                ampmInput.value = DateUtils.parseAMPM(hour);
                dateInput.value = DateUtils.formatDashed(today);

                break;
              }
              case "location":
                HTML.attributes(td, {
                  class: "hidden",
                });
                td.nextElementSibling.classList.remove("hidden");
                els.locationSelect.value = "none";
                break;
              default:
                td.parentNode.classList.add("hidden");
            }
          }
          break;
      }
    }

    // copy form
    app.pages.form.savedForm = new Form(form);

    // cleanup
    app.changes.clear();
    app.omnibox.clear();

    // indicate where this form is in the current stack, e.g. "1/6"
    const stack = app.pages.form.currentStack;
    els.currentFormstackDisplay.textContent =
      stack.getCurrentIndex() + 1 + "/" + stack.getLength();

    if (stack === app.pages.archive.filteredStack) {
      formPage.disable();
    } else {
      formPage.enable();
    }

    app.spinner.element.classList.add("hidden");
    app.showPage(formPage);
  }

  function displaySortedBy(stack, tableHead) {
    const headers = tableHead.querySelectorAll("th"),
      sortDirection = stack.sortDescending ? "descending" : "ascending";
    for (let i = 0; i < headers.length; ++i) {
      headers[i].classList.remove("sortedBy", "ascending", "descending");
      if (headers[i].dataset.sort === stack.sortBy) {
        headers[i].classList.add("sortedBy", sortDirection);
      }
    }
  }

  /**
   * This is a procedure to display to the user a compact list of the open forms
   * @param {object []} forms - an array of Forms
   * @return {undefined} - updates html display for user
   */
  function populateFormsTable(forms) {
    HTML.empty(app.pages.openForms.elements.formsTableBody);
    HTML.empty(app.pages.openForms.elements.equipmentTableBody);

    // highlight the column currently sorted by
    displaySortedBy(forms, app.pages.openForms.elements.formsTableHead);

    // if there's no forms...
    if (forms.getLength() == 0) {
      let cell = document.createElement("td"),
        row = document.createElement("tr");
      cell.textContent = "No open forms";
      cell.setAttribute("colspan", "5");
      row.appendChild(cell);
      row.classList.add("hoveroff");
      app.pages.openForms.elements.formsTableBody.appendChild(row);

      return;
    }

    // else populate
    forms.forEach(makeOpenFormTableRows);

    // if makeOpenFormTableRows found no equipment out...
    if (!app.pages.openForms.elements.equipmentTableBody.firstChild) {
      let row = document.createElement("tr"),
        cell = document.createElement("td");
      cell.textContent = "No equipment checked-out.";
      cell.style.pointerEvents = "none";
      row.appendChild(cell);
      app.pages.openForms.elements.equipmentTableBody.appendChild(row);
    }
  }

  function makeOpenFormTableRows(form) {
    form.items.forEach(function (item) {
      if (item.checkedOut) {
        populateEquipmentOutList([
          item.description,
          item.id,
          form.location,
          form.students,
          form.endTime,
          form.id,
        ]);
      }
    });

    let type = "inactive", // assume inactive
      endTime = DateUtils.parseFormattedDate(form.endTime).getTime(),
      fifteenMinutes = 15 * 60 * 1000, // milliseconds
      now = Date.now();
    // determine if active, ending soon, or late (green, yellow, red)
    if (form.students.some((student) => student.checkIn)) {
      type = "active";
    }
    if (type === "active" && now > endTime) {
      type = "late";
    }
    if (type === "active" && now > endTime - fifteenMinutes) {
      type = "endingSoon";
    }
    app.pages.openForms.elements.formsTableBody.appendChild(
      HTML.createElement("tr", {
        class: type,
        "data-id": form.id,
        children: [
          HTML.createElement("td", { innerHTML: app.strings.documentIcon }),
          ...[
            form.startTime,
            form.endTime,
            form.location,
            form.bookedStudents ||
              form.students.map((student) => student.name).join(", "),
          ].map((textContent) => HTML.createElement("td", { textContent })),
        ],
      })
    );
  }

  function populateEquipmentOutList(item) {
    app.pages.openForms.elements.equipmentTableBody.appendChild(
      HTML.createElement("tr", {
        "data-id": item[5],
        children: [
          item[0],
          item[1],
          item[2],
          item[3].map((student) => student.name).join(", "),
          item[4],
        ].map((textContent) => HTML.createElement("td", { textContent })),
      })
    );
  }

  function populateItemList(item) {
    const isArchive =
      app.pages.form.currentStack === app.pages.archive.filteredStack;
    app.pages.form.elements.itemList.appendChild(
      HTML.createElement("tr", {
        class: item.isSerialized ? "serialized" : "nonserialized",
        "data-id": item.id,
        "data-barcode": item.barcode,
        children: [
          item.makeQuantityButtons(isArchive),
          document.createTextNode(item.description),
          document.createTextNode(item.id),
          item.checkOut
            ? document.createTextNode(item.checkOut)
            : HTML.createElement("i", {
                textContent: "Scan barcode to check out",
              }),
          item.makeCheckInButton(isArchive),
        ].map((child) => HTML.createElement("td", { child })),
      })
    );
    app.pages.form.elements.itemList.appendChild(
      HTML.createElement("tr", {
        child: HTML.createElement("td", {
          colspan: 4,
          class: "itemnotes",
          textContent: "Notes: " + item.notes,
        }),
      })
    );
  }

  function populateStudentList(student) {
    const isArchive =
      app.pages.form.currentStack === app.pages.archive.filteredStack;
    app.pages.form.elements.studentList.appendChild(
      HTML.createElement("tr", {
        "data-netid": student.netId,
        children: [
          HTML.createElement("td", { textContent: student.name }),
          HTML.createElement("td", { textContent: student.netId }),
          HTML.createElement("td", {
            child: student.checkIn
              ? document.createTextNode(student.checkIn)
              : isArchive
              ? document.createTextNode("")
              : HTML.createElement("i", { textContent: "Scan ID to sign in" }),
          }),
          HTML.createElement("td", {
            child: student.left
              ? HTML.createElement("span", {
                  class: "alert",
                  textContent: "DID NOT CHECK OUT",
                })
              : student.checkOut
              ? document.createTextNode(student.checkOut)
              : isArchive || !student.checkIn
              ? document.createTextNode("")
              : HTML.createElement("i", { textContent: "Scan ID to sign out" }),
          }),
        ],
      })
    );
  }

  /**
   * @param {Stack} formStack
   */
  function populateArchiveTable(formStack) {
    HTML.empty(app.pages.archive.elements.tableBody);

    displaySortedBy(formStack, app.pages.archive.elements.tableHead);

    // if there's no forms...
    if (formStack.getLength() === 0) {
      return app.pages.archive.elements.tableBody.appendChild(
        HTML.createElement("tr", {
          class: "hoveroff",
          child: HTML.createElement("td", {
            textContent: "No forms matched your search.",
            colspan: 12, // fill entire row
          }),
        })
      );
    }
    // else populate
    formStack.forEach(makeArchiveTableRows);
  }

  function makeArchiveTableRows(form) {
    app.pages.archive.elements.tableBody.appendChild(
      HTML.createElement("tr", {
        "data-id": form.id,
        children: [
          app.strings.documentIcon,
          form.startTime,
          form.endTime,
          form.location,
          form.students.map((student) => student.name).join(", "),
          form.items.getLength() > 0 ? "YES" : "NO", // "has items"
          form.bookingId,
          form.bookedStudents,
          form.contact,
          form.project,
          form.tape ? "YES" : "",
          form.overnight ? "YES" : "",
        ].map((textContent) => HTML.createElement("td", { textContent })),
      })
    );
  }

  function modal({
    message = "",
    okValue = "modalOk",
    cancel = false,
    blocking = false,
    onOk = () => {},
    onCancel = () => {},
  } = {}) {
    if (typeof message !== "string") {
      throw new Error("modal requires string argument, got " + message);
    }
    let guard;
    if (blocking) {
      guard = document.createElement("div");
      guard.classList.add("overlay");
      document.body.appendChild(guard);
    }
    const container = document.createElement("div");
    container.classList.add("modal");
    const p = document.createElement("p");
    p.textContent = message;
    container.appendChild(p);
    const removeModal = () => {
      container.remove();
      if (guard) guard.remove();
    };
    const makeButton = (name, value, onClick) => {
      const button = document.createElement("button");
      button.addEventListener("click", removeModal);
      button.addEventListener("click", onClick);
      button.textContent = name;
      button.value = value;
      return button;
    };
    cancel &&
      container.appendChild(makeButton("Cancel", "modalCancel", onCancel));
    container.appendChild(makeButton("OK", okValue, onOk));
    document.body.appendChild(container);
  }

  function toast(textContent) {
    const container = HTML.createElement("div", {
      class: "toast",
      textContent,
    });
    document.body.appendChild(container);
    window.setTimeout(() => container.remove(), 5000);
  }
</script>
