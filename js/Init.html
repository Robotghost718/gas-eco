<script>
  /* global app google ClosedFormsPage OpenFormsPage Omnibox FormPage */

  OpenFormsPage.setHandlers({
    clickTable: ({ form }) => app.doCommand("displayForm", form),
  });
  Omnibox.setHandlers({
    onManualEntryStart: () => app.doCommand("newManual"),
    onManualEntryEnd: (value) =>
      FormPage.handleChange({ target: { name: "manual", value } }),
    onCheckOutAgain: app.modal.handleCheckOutAgain,
    onQuantityChange: app.modal.handleQuantityChange,
    onAmbiguousItemAction: app.modal.handleAmbiguousItemAction,
    onItemChange: FormPage.updateItems,
    onStudentChange: FormPage.updateStudents,
    onNewCodabar: app.modal.getNewCodabar,
    onNeedsSignature: (netid) => {
      app.modal.signatureWait();
      app.run.doPost({ post: "startSignature", netid });
    },
    onQueryResults: app.modal.handleQuery,
  });
  Omnibox.setConnections({
    getSavedForm: FormPage.getSavedForm,
  });
  FormPage.setHandlers({
    onUnsavedForm: app.modal.handleUnsavedForm,
    onSubmit: () => app.doCommand("updateForm"),
    onLocationOther: app.modal.getLocation,
    onItemNote: app.modal.handleItemNote,
    onItemMetaClick: Omnibox.setInputAndParse,
    onStudentMetaClick: Omnibox.setInputAndParse,
    onUnload: () => app.run.doPost({ post: "unload" }),
  });
  FormPage.setConnections({
    getCurrentForm: OpenFormsPage.getCurrentForm,
    getStack: OpenFormsPage.getStack,
  });
  ClosedFormsPage.setHandlers({
    onFormSelect: FormPage.displayForm,
  });
  ClosedFormsPage.setConnections({
    setCurrentStack: FormPage.setCurrentStack,
  });

  window.addEventListener("click", app.handlers.click);
  window.addEventListener("keydown", app.handlers.keydown);

  /** Display init - anything to do with what the user sees immediately */
  app.modal.hide(); // make sure everything is hidden that is supposed to be

  // Server runners
  app.withErrorHandler = google.script.run.withFailureHandler(
    app.modal.handleError
  );
  app.run = app.withErrorHandler.withSuccessHandler(app.refresh);

  /** Server calls - the initial server calls that happen automatically */
  app.run.doGet({ get: "openForms", init: true }); // displays open forms
  app.run.doGet({ get: "user" }); // displays username
  app.run.doGet({ get: "students", init: true }); // gets the student info cache
  app.run.doGet({ get: "items", init: true }); // gets the item info cache
  app.run.doGet({
    get: "archive",
    dateRangeJSON: app.pages.archive.getDateRangeAsJSON(),
    init: true,
  });
</script>
