<script>
  /**
   * client commands switch block
   * most of these are primarily driven by mouse clicks, usually on button elements
   */
  /* global
      Form
      FormPage
      app
      Omnibox
      OpenFormsPage
      HTML
      Utility
  */
  app.doCommand = function (command, ...options) {
    switch (command) {
      case "ambiguousCheckIn": {
        app.modal.hide();
        Omnibox.handleItem(app.modal.tmp, "all", false);
        break;
      }
      case "ambiguousCheckOut": {
        app.modal.hide();
        app.modal.handleQuantityChange(app.modal.tmp);
        break;
      }
      case "archivedForms": {
        if (!app.changes.saved) {
          app.modal.handleUnsavedForm(command);
          return;
        }
        app.showPage(app.pages.archive);
        break;
      }
      case "changeLog":
        app.modal.displayChangeLog(
          FormPage.getCurrentStack().getCurrentForm().notes
        );
        break;
      case "checkInButton": {
        const itemID = options[0];
        const savedItem = FormPage.getSavedForm().items.find(
          (item) => (item.barcode || item.id) == itemID
        );
        if (!savedItem) {
          app.modal.handleError(
            new Error(
              "This item was just checked-out. " +
                "Update or revert the form to continue."
            )
          );
          break;
        }
        const quantityToReturn =
          savedItem.getQuantity() > 1
            ? document.querySelector(`select[data-itemid="${itemID}"]`).value
            : undefined;
        Omnibox.handleItem(savedItem, quantityToReturn, false);
        break;
      }
      case "checkOutAgain": {
        const item = app.modal.tmp;
        item.checkIn = "";
        item.checkedOutAgain = true;
        FormPage.updateItems({
          target: {
            name: "items",
            value: `${item.description} checked out again`,
          },
        });
        break;
      }
      case "codabar": {
        const codabar = app.modal.tmp,
          netId = app.modal.getInput();
        const student = Omnibox.getRoster().find(
          (student) => student.netId.toLowerCase() === netId
        );
        if (!student) {
          window.alert(
            "Hmmm, NetID " +
              netId +
              " does not match a current student. " +
              "Check that it was entered correctly, try refreshing the browser, " +
              "or submit a trouble report."
          );
          break;
        }
        FormPage.setUpdateFormButtonToSpinner();
        app.run.doPost({
          post: "codabar",
          netId,
          codabar,
        });
        break;
      }
      case "collisionResolve": {
        const form = app.modal.tmp.storedForm;
        FormPage.getCurrentStack().replaceCurrent(form);
        app.changes.saved = true;
        FormPage.lockButtons();
        FormPage.displayForm(form);
        break;
      }
      case "copyItems": {
        Utility.copyToClipboard(
          JSON.stringify(
            FormPage.getCurrentStack().getCurrentForm().items.getStripped()
          )
        );
        break;
      }
      case "deleteForm": {
        if (FormPage.getSavedForm().isBlank()) {
          app.doCommand("openForms");
          break;
        }
        document.appendChild(
          HTML.modal({
            blocking: true,
            child: HTML.paragraph(
              "This will close out the form and mark it deleted. Are you sure?"
            ),
            closeText: "Cancel",
            onOk: () => {
              FormPage.lock();
              FormPage.setDeleteFormButtonToSpinner();
              const form = OpenFormsPage.getCurrentForm();
              app.changes.add({
                target: {
                  name: "delete",
                  value: "form deleted",
                },
              });
              form.notes.push(app.changes.makeNote());
              app.run.doPost({
                post: "deleteForm",
                form: form.stringify(),
              });
            },
          })
        );
        break;
      }
      case "displayForm": {
        FormPage.displayForm(options[0]);
        break;
      }
      case "displayDuplicatedForm": {
        const newForm = new Form(FormPage.getSavedForm(), true);
        const stack = OpenFormsPage.getStack();
        FormPage.setCurrentStack(stack);
        stack.push(newForm);
        app.changes.saved = false;
        FormPage.displayForm(newForm);
        break;
      }
      case "displayNewForm": {
        if (!app.changes.saved) {
          app.modal.handleUnsavedForm(command);
          return;
        }
        const newForm = new Form({});
        const stack = OpenFormsPage.getStack();
        FormPage.setCurrentStack(stack);
        stack.push(newForm);
        app.changes.saved = false;
        FormPage.displayForm(newForm);
        break;
      }
      case "itemNote": {
        const item = app.modal.tmp;
        const change = { target: { name: "items" } };
        const value = HTML.getRadioValue(app.modal.table);
        if (value == "other") {
          const note = app.modal.getText();
          if (note.length < 1) {
            return;
          }
          change.target.value = `${item.description} added note: ${note}`;
          item.notes = item.notes ? item.notes + `, ${note}` : note;
        } else if (value == "missing") {
          item.missing = true;
          change.target.value = `${item.description} marked as missing`;
        }
        FormPage.updateItems(change);
        break;
      }
      case "itemQuantity": {
        const quantity = +app.modal.getInput();
        const item = app.modal.tmp;
        // is the item on the saved form? Quantity cannot be decreased.
        const savedItem = FormPage.getSavedForm().items.find(
          ({ description }) => description === item.description
        );
        if (!item.checkedOutAgain && savedItem) {
          const savedQuantity = savedItem.getQuantity();
          if (quantity < savedQuantity) {
            window.alert(
              quantity +
                " is less than the previous quantity " +
                savedQuantity +
                ". You can only enter a larger amount " +
                "or check in this item."
            );
            return;
          }
        }
        try {
          item.setQuantity(quantity);
        } catch (error) {
          window.alert(error);
          return;
        }
        FormPage.updateItems({
          target: {
            name: "items",
            value: `${
              item.description
            } qty ${item.getQuantity()} to ${quantity}`,
          },
        });
        break;
      }
      case "itemQuantityPlusOne": {
        const form = OpenFormsPage.getCurrentForm();
        const item = form.items.getByItem(options[0]);
        const quantity = item.getQuantity();
        item.changeQuantity(1);
        FormPage.updateItems({
          target: {
            name: "items",
            value: `${item.description} qty ${quantity} to ${quantity + 1}`,
          },
        });
        break;
      }
      case "newManual":
        app.modal.getManual();
        break;
      case "openForms":
        if (!app.changes.saved) {
          app.modal.handleUnsavedForm(command);
          return;
        }
        app.run.doGet({ get: "openForms" });
        break;
      case "parseOmnibox":
        Omnibox.parse();
        break;
      case "query":
        app.pages.archive.query();
        break;
      case "removeItem": {
        const form = OpenFormsPage.getCurrentForm();
        const item = form.items.removeByItem(options[0]);
        FormPage.updateItems({
          target: {
            name: "items",
            value: item.description + " removed",
          },
        });
        break;
      }
      case "revert":
        // if (!window.isNaN(app.pages.form.autosaveID)) {
        //   window.clearTimeout(app.pages.form.autosaveID);
        //   app.pages.form.autosaveID = NaN;
        // }
        FormPage.displayForm(OpenFormsPage.getCurrentForm());
        break;
      case "saveManual": {
        const description = app.modal.getText();
        if (description === "") {
          break;
        }
        Utility.digestMessage(description).then((hash) => {
          Omnibox.handleItem({
            id: "MANUAL-" + Utility.hexString(hash).substring(0, 5),
            checkIn: null,
            checkOut: null,
            quantity: 1,
            serialized: false,
            barcode: null,
            description,
            checkedOut: false,
            notes: "",
            missing: false,
          });
        });
        break;
      }
      case "setLocationOther": {
        const otherLocation = app.modal.getInput();
        if (otherLocation === "") {
          app.modal.getLocation();
          break;
        }
        FormPage.handleChange({
          target: {
            name: "location",
            value: otherLocation,
          },
        });
        break;
      }
      case "signatureRecheck":
        app.run.doGet({ get: "students", init: false });
        break;
      case "updateForm": {
        Omnibox.parse();
        FormPage.lock();
        FormPage.setUpdateFormButtonToSpinner();
        const form = OpenFormsPage.getCurrentForm();
        form.notes.push(app.changes.makeNote());
        app.run.doPost({
          post: "updateForm",
          form: form.stringify(),
        });
        break;
      }
      case "undo":
        app.modal.handleUndo();
        break;
    }
  };
</script>
