<script>
/**
 * client commands switch block
 * most of these are primarily driven by mouse clicks, usually on button elements
 */
/* global
      Form
      app
      displayForm
      populateStudentList
      populateItemList
      utility
*/
app.doCommand = function(command,...options) {
  switch (command) {
    case 'archivedForms': {
      if (!app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.showPage(app.pages.archive);
      break;
    }
    case 'changeLog':
      app.modal.displayChangeLog(
        app.pages.form.currentStack.getCurrentForm().notes
      );
      break;
    case 'checkInButton': {
      const itemID = options[0];
      const savedItem = app.pages.form.savedForm.items.find(
        item => (item.barcode || item.id) == itemID
      );
      if (! savedItem) {
        app.modal.handleError(new Error("This item was just checked-out. " +
          "Update or revert the form to continue."
        ));
        break;
      }
      let quantityToReturn;
      if (savedItem.quantity > 1) {
        const quantityInput = document.querySelector(`select[data-itemid="${itemID}"]`);
        quantityToReturn = quantityInput.value;
      }
      app.omnibox.handleItem(savedItem, quantityToReturn);
      break;
    }
    case 'codabar': {
      const codabar = app.modal.tmp,
            netId = app.modal.getInput();
      const student = app.roster.find(
        student => student.netId.toLowerCase() == netId
      );
      if (! student){
        app.modal.handleError(new Error(
          "Hmmm, NetID " + netId + " does not match a current student. " +
          "Check that it was entered correctly, try refreshing the browser, " +
          "or submit a trouble report."
        ));
        break;
      }
      app.spinner.inside(app.pages.form.elements.updateFormButton);
      app.run.doPost({
        post: 'codabar',
        netId,
        codabar,
      });
      break;
    }
    case 'collisionResolve': {
      const form = app.modal.tmp.storedForm;
      app.pages.form.currentStack.replaceCurrent(form);
      app.changes.saved = true;
      app.pages.form.lockButtons();
      displayForm(form);
      break;
    }
    case 'copyItems': {
      const items = app.pages.form.currentStack.getCurrentForm().items;
      items.forEach(utility.item.strip);
      utility.copyToClipboard(JSON.stringify(items));
      break;
    }
    case 'displayForm': {
      displayForm(options[0]);
      break;
    }
    case 'displayNewForm': {
      if (! app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.pages.form.savedForm = new Form({});
      app.pages.form.currentStack = app.pages.openForms.stack;
      app.pages.openForms.stack.push(new Form({}));
      app.changes.saved = false;
      displayForm(app.pages.form.savedForm);
      break;
    }
    case 'itemNote': {
      const form = app.pages.openForms.getCurrentForm(),
            item = app.modal.tmp;
      const change = { target: { name: 'items' } };
      const value = utility.DOM.getRadioValue();
      if (value == 'other') {
        const note = app.modal.getText();
        if (note.length < 1) {
          return;
        }
        change.target.value = `${item.description} added note: ${note}`;
        if (! item.notes) {
          item.notes = note;
        } else {
          item.notes += `, ${note}`;
        }
      } else if (value == "missing") {
        item.missing = true;
        change.target.value = `${item.description} marked as missing`;
      }
      app.pages.form.elements.form.items.value = form.items.stringify();
      utility.DOM.empty(app.pages.form.elements.itemList);
      form.items.reverse().forEach(populateItemList);
      app.pages.form.handleChange(change);
      break;
    }
    case 'itemQuantity': {
      const quantity = +app.modal.getInput();
      const items = app.pages.openForms.getCurrentForm().items;
      // note: we shouldn't be here unless item is not serialized, thus description is unique
      const item = app.modal.tmp;
      const itemchange = {
        target: {
          name: 'items',
          value: item.description + ' qty ' + item.getQuantity(),
        }
      };
      // is the item on the saved form? Quantity cannot be decreased.
      const savedItem = app.pages.form.savedForm.items.find(
        i => i.description == item.description
      );
      if (savedItem && quantity < savedItem.quantity) {
        app.modal.handleError(
          new Error(quantity + " is less than the previous quantity " +
            savedItem.quantity + ". You can only enter a larger amount " +
            "or check in this item."
          )
        );
        return;
      }
      try {
        item.setQuantity(quantity);
      } catch (error) {
        app.modal.handleError(error);
        return;
      }
      // Update form.items
      app.pages.form.elements.form.items.value = JSON.stringify(items);
      // Update display
      utility.DOM.empty(app.pages.form.elements.itemList);
      items.reverse().forEach(populateItemList);
      // Fake change event
      itemchange.target.value += ' to ' + quantity;
      app.pages.form.handleChange(itemchange);
      break;
    }
    case 'newNote':
      app.modal.getNote();
      break;
    case 'newManual':
      app.modal.getManual();
      break;
    case 'nextForm':
      app.pages.form.getNext();
      break;
    case 'openForms':
      if (! app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.spinner.on();
      app.run.doGet({ get: 'openForms' });
      break;
    case 'parseOmnibox':
      app.omnibox.parse();
      break;
    case 'previousForm':
      app.pages.form.getPrevious();
      break;
    case 'query':
      app.pages.archive.query();
      break;
    case 'revert':
      displayForm(app.pages.form.savedForm);
      break;
    case 'saveNote': {
      utility.saveNote();
      break;
    }
    case 'saveManual': {
      const description = app.modal.getText();
      utility.digestMessage(description).then(hash =>{
        app.omnibox.handleItem({
          id: "MANUAL-" + utility.hexString(hash).substring(0, 5),
          checkIn: null,
          checkOut: null,
          quantity: 1,
          serialized: false,
          barcode: null,
          description,
          checkedOut: true,
          notes: '',
          missing: false
        });
      });
      break;
    }
    case 'setLocationOther': {
      const otherLocation = app.modal.getInput(),
            option = app.pages.form.elements.locationOtherOption,
            select = app.pages.form.elements.form.location,
            change = {
              target: {
                name  :'location',
                value :otherLocation
              }
            };
      if (otherLocation.length < 1){
        app.modal.getLocation();
        break;
      }
      select.value = option.value = otherLocation;
      app.pages.form.handleChange(change);
      option.textContent = otherLocation; // must follow handleChange
      break;
    }
    case 'signatureRecheck':
      app.run.doGet({ get: 'students',  init: false});
      break;
    case 'studentNote': {
      const value = utility.DOM.getRadioValue();
      const students = app.pages.openForms.getCurrentForm().students;
      const student = students.find(s => s.id == app.modal.tmp.id);
      if (! student) {
        app.modal.handleError(new Error("oops... could not find student on form"));
      }
      if (value == 'left') {
        student.left = true;
        app.pages.form.handleChange({
          target: {
            name: "students",
            value: student.name + ' left without checking out'
          }
        });
        app.pages.form.elements.form.students.value = JSON.stringify(students);
        utility.DOM.empty(app.pages.form.elements.studentList);
        students.forEach(populateStudentList);
      } else if (value == "other") {
        utility.saveNote(student.name + ": ");
      }
      break;
    }
    case 'updateForm':
      app.omnibox.parse();
      app.pages.form.lock();
      app.spinner.inside(app.pages.form.elements.updateFormButton);
      app.run.doPost({
        post: 'updateForm',
        form: app.pages.openForms.getCurrentForm().stringify(),
      });
      break;
    case 'undo':
      app.modal.handleUndo();
      break;
  }
};
</script>
