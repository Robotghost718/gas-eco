<script>
/* global app populateFormsTable Stack */
app.pages.openForms = {
  elements: {
    container:          document.querySelector('div.openFormsContainer'),
    equipmentTableBody: document.querySelector('tbody.equipmentOut'),
    formsTableBody:     document.querySelector('tbody.open'),
    formsTableHead:     document.querySelector('thead.open'),
  },
  getCurrentForm: function() {
    return this.stack.getCurrentForm();
  },
  handleClickTable: function(click) {
    const id = click.target.parentNode.getAttribute('data-id');
    app.doCommand('displayForm', this.stack.getByID(id));
  },
  handleClickTableHead: function(click) {
    this.stack.sortForms(click.target.dataset.sort);
    populateFormsTable(this.stack);
  },
  isShowing: function () {
    return ! this.elements.container.classList.contains("hidden");
  },
  show: function() {
    this.elements.container.classList.remove("hidden");
    if (this.refreshId === null) {
      this.setInterval();
    }
  },
  hide: function() {
    this.elements.container.classList.add("hidden");
    if (this.refreshId !== null) {
      window.clearInterval(this.refreshId);
    }
    this.refreshId = null;
  },
  refreshId: null,
  /**
   * refreshOpenForms is a window.setTimeout callback function
   *   to fetch the open forms from the server and silently update.
   */
  refreshOpenForms: function() {
    app.run
      .withUserObject({timeoutId: app.pages.openForms.refreshId})
      .doGet({get: "openFormsQuiet"});
  },
  setInterval: function() {
    this.refreshId = window.setInterval(this.refreshOpenForms, 60000);
  },
  stack: new Stack(),
};
</script>
