<script>
  /* global app populateFormsTable Stack */
  app.pages.openForms = {
    elements: {
      container: document.querySelector("div.openFormsContainer"),
      equipmentTableBody: document.querySelector("tbody.equipmentOut"),
      formsTableBody: document.querySelector("tbody.open"),
      formsTableHead: document.querySelector("thead.open"),
      mergeButton: document.querySelector("button[value=mergeMode]"),
      copyItemsButton: document.querySelector("button[value=copyItemsMode]"),
      modeDisplay: document.querySelector(".openFormsModeDisplay"),
    },
    copyItemsMode: false,
    copyItemsModeEnter: function () {
      this.copyItemsMode = true;
      alert("copy mode ON");
    },
    copyItemsModeExit: function () {
      this.copyItemsMode = false;
      alert("copy mode OFF");
    },
    getCurrentForm: function () {
      return this.stack.getCurrentForm();
    },
    handleClickTable: function (click) {
      if (this.mergeMode) {
        const htmlRow = click.target.parentNode;
        if (this.mergeSelection.includes(htmlRow)) {
          htmlRow.classList.remove("mergeSelection");
          this.mergeSelection.splice(
            this.mergeSelection.findIndex((row) => row === htmlRow),
            1
          );
        } else {
          htmlRow.classList.add("mergeSelection");
          this.mergeSelection.push(htmlRow);
          if (this.mergeSelection.length === 2) {
            this.mergeModeExit();
          }
        }
        return;
      }
      const id = click.target.parentNode.getAttribute("data-id");
      app.doCommand("displayForm", this.stack.getByID(id));
    },
    handleClickTableHead: function (click) {
      this.stack.sortForms(click.target.dataset.sort);
      populateFormsTable(this.stack);
    },
    isShowing: function () {
      return !this.elements.container.classList.contains("hidden");
    },
    mergeMode: false,
    mergeModeEnter: function () {
      this.mergeMode = true;
      this.elements.mergeButton.textContent = this.mergeButtonText.merge;
      this.elements.modeDisplay.textContent = this.modeDisplayText.merge;
    },
    mergeModeExit: function () {
      this.mergeMode = false;
      this.elements.mergeButton.textContent = this.mergeButtonText.normal;
      this.elements.modeDisplay.textContent = this.modeDisplayText.normal;
      this.mergeSelection = [];
      Array.from(document.querySelectorAll(".mergeSelection")).forEach((row) =>
        row.classList.remove("mergeSelection")
      );
    },
    mergeSelection: [],
    mergeButtonText: {
      normal: document.querySelector("button[value=mergeMode]").textContent,
      merge: "Cancel merge",
    },
    modeDisplayText: {
      normal: document.querySelector(".openFormsModeDisplay").textContent,
      merge: "select two forms to merge",
    },
    show: function () {
      this.elements.container.classList.remove("hidden");
      if (this.refreshId === null) {
        this.setInterval();
      }
    },
    hide: function () {
      this.mergeModeExit();
      this.elements.container.classList.add("hidden");
      if (this.refreshId !== null) {
        window.clearInterval(this.refreshId);
      }
      this.refreshId = null;
    },
    refreshId: null,
    /**
     * refreshOpenForms is a window.setTimeout callback function
     *   to fetch the open forms from the server and silently update.
     */
    refreshOpenForms: function () {
      app.run
        .withUserObject({ timeoutId: app.pages.openForms.refreshId })
        .doGet({ get: "openFormsQuiet" });
    },
    setInterval: function () {
      this.refreshId = window.setInterval(this.refreshOpenForms, 60000);
    },
    stack: new Stack(),
  };
</script>
