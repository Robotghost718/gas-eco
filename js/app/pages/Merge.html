<script>
  /* global app modal */
  app.pages.merge = {
    elements: {
      container: document.querySelector(".mergeContainer"),
      form: document.querySelector(".mergeTool"),
    },
    show: function () {
      this.elements.container.classList.remove("hidden");
      modal({ message: "Use this page to merge two forms.", blocking: true });
    },
    hide: function () {
      this.elements.container.classList.add("hidden");
    },
    display(...forms) {
      const studentTable = document.querySelector(".mergeStudents");
      const itemTable = document.querySelector(".mergeItems");
      forms.forEach((form, i) => {
        const id = indexToLetter(i);
        [
          "bookedStudents",
          "contact",
          "project",
          "tape",
          "overnight",
          "location",
          "startTime",
          "endTime",
        ].forEach((key) => {
          document.querySelector(`.${key}MergeDisplay${id}`).textContent =
            form[key];
        });
        form.students
          .map(studentCells)
          .forEach((cells) =>
            studentTable.appendChild(row(cell(id), ...cells))
          );
        form.items
          .map(itemCells)
          .forEach((cells) => itemTable.appendChild(row(cell(id), ...cells)));
      });
      function studentCells({ name, netId, checkIn, checkOut }) {
        return [cell(name), cell(netId), cell(checkIn), cell(checkOut)];
      }
      function itemCells(item) {
        const { description, barcode, id, checkOut, checkIn } = item;
        return [
          cell(item.getQuantity()),
          cell(description),
          cell(id || barcode),
          cell(checkOut),
          cell(checkIn),
        ];
      }
      function htmlEl(name) {
        return document.createElement(name);
      }
      function cell(value) {
        const td = htmlEl("td");
        td.textContent = value;
        return td;
      }
      function row(...tds) {
        const tr = htmlEl("tr");
        tds.forEach((cell) => tr.appendChild(cell));
        return tr;
      }
      function indexToLetter(n) {
        return String.fromCharCode("A".charCodeAt() + n);
      }
    },
    /*
        A   B   target shift  |  A   B  comment
        1   0   A      0      |  1   0  ignore
        1   0   B      0      |  0   1  toggle
        1   0   A      1      |  1   0  ignore
        1   0   B      1      |  1   1  both
        0   1   A      0      |  1   0  toggle
        0   1   B      0      |  0   1  ignore
        0   1   A      1      |  1   1  both
        0   1   B      1      |  0   1  ignore
        1   1   A      0      |  1   0  deselect non-target
        1   1   B      0      |  0   1  deselect non-target
        1   1   A      1      |  0   1  deselect target
        1   1   B      1      |  1   0  deselect target
       (0) (0)  [not allowed] |  1   1  both
    */
    handleClickTable(click) {
      document.getSelection().removeAllRanges(); // trying to avoid highlighting
      const { target, shiftKey } = click;
      const [, A, B] = Array.from(click.target.parentNode.children);
      const [a, b] = state(A, B);
      if ((a && !b && target === B) || (!a && b && target === A)) {
        if (shiftKey) both(A, B);
        else toggle(A, B);
      } else if (a && b) {
        if (shiftKey) toggle(target);
        else {
          if (target === A) toggle(B);
          else toggle(A);
        }
      } else if (!a && !b) {
        both(A, B);
      }
      function toggle(...els) {
        els.forEach((el) => el.classList.toggle("mergeFieldSelection"));
      }
      function both(...els) {
        els.forEach((el) => el.classList.add("mergeFieldSelection"));
      }
      function state(...els) {
        return els.map((el) => el.classList.contains("mergeFieldSelection"));
      }
    },
  };
</script>
