<script>
  /* global app modal */
  app.pages.merge = {
    elements: {
      container: document.querySelector(".mergeContainer"),
      form: document.querySelector(".mergeTool"),
    },
    show() {
      this.elements.container.classList.remove("hidden");
      modal({
        message: "Select which information you want to keep.",
        blocking: true,
      });
    },
    hide() {
      this.elements.container.classList.add("hidden");
    },
    display(...forms) {
      const studentTable = document.querySelector(".mergeStudents");
      const itemTable = document.querySelector(".mergeItems");
      forms.forEach((form, i) => {
        const id = indexToLetter(i);
        [
          "bookedStudents",
          "contact",
          "project",
          "tape",
          "overnight",
          "location",
          "startTime",
          "endTime",
        ].forEach((key) => {
          document.querySelector(`.${key}MergeDisplay${id}`).textContent =
            form[key];
        });
        populateTable(studentTable, id, form.students, studentCells);
        populateTable(itemTable, id, form.items, itemCells);
      });
      function populateTable(table, id, data, cellMapFn) {
        data.map(cellMapFn).forEach((cells) => {
          const tr = row(cell(id), ...cells);
          tr.classList.add("mergeFieldSelection");
          table.appendChild(tr);
        });
      }
      function studentCells({ name, netId, checkIn, checkOut }) {
        return [cell(name), cell(netId), cell(checkIn), cell(checkOut)];
      }
      function itemCells(item) {
        const { description, barcode, id, checkOut, checkIn } = item;
        return [
          cell(item.getQuantity()),
          cell(description),
          cell(id || barcode),
          cell(checkOut),
          cell(checkIn),
        ];
      }
      function htmlEl(name) {
        return document.createElement(name);
      }
      function cell(value) {
        const td = htmlEl("td");
        td.textContent = value;
        return td;
      }
      function row(...tds) {
        const tr = htmlEl("tr");
        tds.forEach((cell) => tr.appendChild(cell));
        return tr;
      }
      function indexToLetter(n) {
        return String.fromCharCode("A".charCodeAt() + n);
      }
    },
    handleClickTable(click) {
      const { target } = click;
      const containsClass = (className) => (element) =>
        element.classList && element.classList.contains(className);
      const path = click.composedPath();
      if (path.find(containsClass("staticFields"))) {
        const [, A, B] = Array.from(target.parentNode.children);
        [A, B].forEach((el) => el.classList.toggle("mergeFieldSelection"));
      } else if (path.find(containsClass("mergeStudents"))) {
        target.parentNode.classList.toggle("mergeFieldSelection");
      } else if (path.find(containsClass("mergeItems"))) {
        target.parentNode.classList.toggle("mergeFieldSelection");
      }
    },
  };
</script>
