<script>
/* global Form app displayForm utility toast */
app.pages.form = {
  autosaveID: NaN,
  checkForms: function() {
    app.run
      .withUserObject({ timeoutId: app.pages.form.timeoutId })
      .doGet({ get: "checkForms" });
  },
  currentStack: null,
  disable: function() {
    app.omnibox.element.setAttribute('disabled', true);
    this.elements.newNoteButton.setAttribute('disabled', true);
    this.elements.manualButton.setAttribute('disabled', true);
    this.elements.omniboxButton.setAttribute('disabled', true);
    this.elements.updateButtonHint.textContent = 'This is a closed form.  ' +
      'You cannot edit it.';
    this.elements.copyButton.classList.remove('hidden');
  },
  elements: {
    container:               document.querySelector('div.formContainer'),
    currentFormstackDisplay: document.querySelector('span.currentFormstackDisplay'),
    focusGuardTop:           document.querySelector('.focusGuardTop'),
    focusGuardBottom:        document.querySelector('.focusGuardBottom'),
    form:                    document.querySelector('form.model'),
    itemList:                document.querySelector('tbody.itemList'),
    locationSelect:          document.querySelector('form.model select[name="location"]'),
    locationOtherOption:     document.querySelector('form.model option[value="Other"]'),
    newNoteButton:           document.querySelector('button[value="newNote"]'),
    manualButton:            document.querySelector('button[value="newManual"]'),
    omniboxButton:           document.querySelector('button[value="parseOmnibox"]'),
    noteSection:             document.querySelector('section.globalnotes'),
    studentList:             document.querySelector('tbody.studentList'),
    tableStaticFields:       document.querySelector('table.staticFields'),
    updateButtonHint:        document.querySelector('span.updateButtonHint'),
    updateFormButton:        document.querySelector('button[value="updateForm"]'),
    undoButton:              document.querySelector('button[value="undo"]'),
    copyButton:              document.querySelector('button[value="copyItems"]'),
  },
  enable: function() {
    app.omnibox.element.removeAttribute('disabled');
    this.elements.newNoteButton.removeAttribute('disabled');
    this.elements.manualButton.removeAttribute('disabled');
    this.elements.omniboxButton.removeAttribute('disabled');
    this.elements.updateButtonHint.textContent = '';
    this.elements.copyButton.classList.add('hidden');
    this.refreshUpdateButton();
  },
  getNext: function() {
    const form = app.pages.form.currentStack.getNext();
    if (! form) { // we're already at the end
      app.omnibox.element.focus();
      return;
    }
    if (! app.changes.saved) {
      app.pages.form.currentStack.getPrevious(); // fix currentIndex
      app.modal.handleUnsavedForm('nextForm');
      return;
    }
    displayForm(form);
  },
  getPrevious: function() {
    const form = app.pages.form.currentStack.getPrevious();
    if (! form) { // we're already at the beginning
      app.omnibox.element.focus();
      return;
    }
    if (! app.changes.saved) {
      app.pages.form.currentStack.getNext(); // fix currentIndex
      app.modal.handleUnsavedForm('previousForm');
      return;
    }
    displayForm(form);
  },
  /** for form validation and attach beforeunload listener for unsaved changes */
  handleChange: function(change) {
    if ((change.target.classList &&
         change.target.classList.contains("selectQuantity")) ||
         change.target == app.omnibox.element) {
      return;
    }

    switch (change.target.name) {
      case 'location':
        app.pages.form.handleChangeLocation(change);
        break;
      case 'startDate':
      case 'startHour':
      case 'startMinute':
      case 'startAMPM':
      case 'endDate':
      case 'endHour':
      case 'endMinute':
      case 'endAMPM':
        app.pages.form.handleChangeTime(change);
        break;
      case 'notes':
        app.changes.add(change);
        break;
      case 'items':
      case 'students':
        toast(change.target.value + " OK");
        app.changes.add(change);
        break;
      case 'manual': // SPECIAL CASE
        app.changes.add(change);
        return; // no change to buttons or "saved" state for manual entries
    }

    app.changes.saved = false;
    app.pages.form.elements.undoButton.removeAttribute('disabled');
    const form = app.pages.openForms.getCurrentForm();
    if (form.isBlank()) {
      app.pages.form.elements.updateFormButton.textContent = app.strings.updateButton.enabled.CREATE;
    } else {
      app.pages.form.elements.updateFormButton.textContent = app.strings.updateButton.enabled.UPDATE;
    }
    app.pages.form.elements.updateFormButton.classList.add('create');

    // clear the old autosave, if it exists
    if (! window.isNaN(app.pages.form.autosaveID)) {
      window.clearTimeout(app.pages.form.autosaveID);
      app.pages.form.autosaveID = NaN;
    }
    if (form.isReadyToPost()) {
      // automatically try to save in 60 seconds
      app.pages.form.autosaveID = window.setTimeout(() => {
        // recheck form is still valid
        if (! app.pages.openForms.getCurrentForm().isReadyToPost()) {
          return;
        }
        app.doCommand("updateForm");
      }, 60000);
      // are we ready to close?
      if (form.isReadyToClose()) {
        app.pages.form.elements.updateFormButton.textContent = 'Update and Close';
      } // Enable update button
      app.pages.form.elements.updateFormButton.removeAttribute('disabled');
      app.pages.form.elements.updateButtonHint.textContent = app.strings.updateEnabledHint;
    } else { // Disable update button
      app.pages.form.elements.updateFormButton.setAttribute('disabled', true);
      app.pages.form.elements.updateButtonHint.textContent = app.strings.updateDisabledHint;
    }
  },
  handleChangeLocation: function(change) {
    if (change.target.value == 'Other') {
      change.target.value = 'none'; // in case the modal is cancelled
      app.modal.getLocation();
      return;
    }
    app.pages.openForms.getCurrentForm().location = change.target.value;
    // it's not other, make sure 'Other' label is reset, log the change
    app.pages.form.elements.locationOtherOption.textContent = 'Other';
    app.changes.add(change);
  },
  handleChangeTime: function(change) {
    let t = utility.date.parseDateAndTimeInputs();
    // CHECK #0: Are t.start and t.end valid?
    if (window.isNaN(t.startTime.getTime())) {
      app.pages.form.elements.form.startDate.classList.add('error');
      app.pages.form.elements.form.startHour.classList.add('error');
      app.pages.form.elements.form.startMinute.classList.add('error');
      app.pages.form.elements.form.startAMPM.classList.add('error');
      app.modal.handleError(new Error('please enter a valid start time.'));
      return;
    } else if (window.isNaN(t.endTime.getTime())) {
      app.pages.form.elements.form.endDate.classList.add('error');
      app.pages.form.elements.form.endHour.classList.add('error');
      app.pages.form.elements.form.endMinute.classList.add('error');
      app.pages.form.elements.form.endAMPM.classList.add('error');
      app.modal.handleError(new Error('please enter a valid end time.'));
      return;
    }

    // CHECK #1: If start is after end, try flipping end AM -> PM first
    if (t.endTime.getTime() <= t.startTime.getTime()) {
      if (app.pages.form.elements.form.endAMPM.value == 'AM') {
        app.pages.form.elements.form.endAMPM.value = 'PM';
        t = utility.date.parseDateAndTimeInputs();
      }
    }

    // CHECK #2: If start is still after end, display error to user
    if (t.endTime.getTime() <= t.startTime.getTime()) {
      app.pages.form.elements.form.endDate.classList.add('error');
      app.pages.form.elements.form.endHour.classList.add('error');
      app.pages.form.elements.form.endMinute.classList.add('error');
      app.pages.form.elements.form.endAMPM.classList.add('error');
      app.modal.handleError(new Error('Start time is after end time.'));
      return;
    } else { // In case there was an error before, reset the classLists
      app.pages.form.elements.form.endDate.classList.remove('error');
      app.pages.form.elements.form.endHour.classList.remove('error');
      app.pages.form.elements.form.endMinute.classList.remove('error');
      app.pages.form.elements.form.endAMPM.classList.remove('error');
      app.pages.form.elements.form.startDate.classList.remove('error');
      app.pages.form.elements.form.startHour.classList.remove('error');
      app.pages.form.elements.form.startMinute.classList.remove('error');
      app.pages.form.elements.form.startAMPM.classList.remove('error');
    }
    const form = app.pages.openForms.getCurrentForm();
    const startTime = utility.date.getFormattedDate(t.startTime);
    app.pages.form.elements.form.startTime.value = form.startTime = startTime;
    const endTime = utility.date.getFormattedDate(t.endTime);
    app.pages.form.elements.form.endTime.value = form.endTime = endTime;
    const type = change.target.name.slice(0,1),
          newChange = { target: {} };
    if (type == 's') {
      newChange.target.name = 'startTime';
      newChange.target.value = app.pages.form.elements.form.startTime.value;
    } else if (type == 'e') {
      newChange.target.name = 'endTime';
      newChange.target.value = app.pages.form.elements.form.endTime.value;
    }
    app.changes.add(newChange);
  },

  handleClickItem: function(click) {
    if (app.pages.form.currentStack === app.pages.archive.filteredStack) {
      return;
    }
    const data = click.target.parentNode.dataset;
    if (click.metaKey) {
      app.omnibox.element.value = data.id || data.barcode;
      app.omnibox.parse();
      return;
    }
    const itemRow = (click.target.classList.contains('itemnotes'))
      ? click.target.parentNode.previousSibling
      : click.target.parentNode;
    const form = app.pages.openForms.getCurrentForm();
    const key = itemRow.dataset.id === '' ? "barcode" : "id";
    const item = itemRow.dataset.id === '' ?
      form.items.getByBarcode(itemRow.dataset.barcode) :
      form.items.getById(itemRow.dataset.id);
    if (! item) {
      app.modal.handleError(
        new Error('cannot take note for ' + itemRow.dataset[key])
      );
    }
    app.modal.handleItemNote(item);
  },
  handleClickStaticTable: function(click) {
    if (app.pages.form.currentStack === app.pages.archive.filteredStack) {
      return;
    }
    if (click.target.tagName != 'TD') {
      return;
    }
    if (click.target.classList.contains('editable')) {
      if (!app.omnibox.element.disabled) {
        let inputCell = utility.DOM.getNextSibling(click.target);
        let input = utility.DOM.getFirstChild(inputCell);
        let value, hour, minute, ampm;
        switch (input.name) {
          case 'location':
            app.pages.form.resetLocation(); // select loses custom "Other"
            input.value = click.target.textContent;
            if (input.value == "") { // form is using custom "Other"
              input.value = "none"; // this will discard custom value
            }
            break;
          case 'startDate': // fallthrough
          case 'endDate':
            value = utility.date.parseFormattedDate(click.target.textContent);
            hour = utility.DOM.getNextSibling(input);
            minute = utility.DOM.getNextSibling(hour);
            ampm = utility.DOM.getNextSibling(minute);
            input.value = value.getFullYear() +
              '-' + utility.date.zeropad(value.getMonth() + 1) +
              '-' + utility.date.zeropad(value.getDate());
            minute.value = utility.date.roundMinutes(value.getMinutes());
            hour.value = utility.date.parseHours(value.getHours());
            ampm.value = utility.date.parseAMPM(value.getHours());
            break;
        }
        click.target.classList.add('hidden');
        inputCell.classList.remove('hidden');
      }
    }
  },
  handleClickStudent: function(click) {
    if (app.pages.form.currentStack === app.pages.archive.filteredStack) {
      return;
    }
    const netId = click.target.parentNode.dataset.netid;
    if (click.metaKey) {
      app.omnibox.element.value = netId;
      app.omnibox.parse();
      return;
    }
    const students = app.pages.openForms.getCurrentForm().students;
    const student = students.find(s => s.netId == netId);
    if (!student) {
      app.modal.handleError(
        new Error('could not find student with NetID ' + netId)
      );
      return;
    }
    app.modal.handleStudentNote(student);
  },
  hide: function() {
    app.pages.form.elements.container.classList.add("hidden");
    if (! window.isNaN(app.pages.form.timeoutId)) {
      window.clearTimeout(app.pages.form.timeoutId);
      app.pages.form.timeoutId = NaN;
    }
    if (! window.isNaN(app.pages.form.autosaveID)) {
      window.clearTimeout(app.pages.form.autosaveID);
      app.pages.form.autosaveID = NaN;
    }
    app.pages.form.unlock();
  },
  isLocked: function() {
    return app.pages.form.locked;
  },
  /**
   * isShowing should verify if the user is currently on the single form view
   * @returns {bool}
   */
  isShowing: function () {
    return ! app.pages.form.elements.container.classList.contains("hidden");
  },
  lock: function() {
    app.pages.form.locked = true;
  },
  locked: false,
  lockButtons: function() {
    app.pages.form.elements.undoButton.setAttribute('disabled', true);
    app.pages.form.elements.updateButtonHint.textContent = '';
    app.pages.form.elements.updateFormButton.setAttribute('disabled', true);
  },
  refreshUpdateButton: function() {
    if (app.pages.openForms.getCurrentForm().isBlank()) {
      this.elements.updateFormButton.textContent = app.strings.updateButton.enabled.CREATE;
    } else {
      this.elements.updateFormButton.textContent = app.strings.updateButton.disabled;
      this.elements.updateFormButton.classList.remove('create');
    }
  },
  resetLocation: function() {
    const els = app.pages.form.elements;
    els.locationSelect.value = "none";
    els.locationOtherOption.value = els.locationOtherOption.textContent = "Other";
  },
  savedForm: new Form({}),
  saveNote: function(prefix = "") {
    const input = app.modal.getText();
    if (input.length < 1) {
      return;
    }
    const form = app.pages.openForms.getCurrentForm();
    const note = {
      timestamp: Date.now(),
      author: app.elements.usernameDisplay.textContent,
      body: prefix + input,
    };
    let shortNotes = note.body;
    if (shortNotes.length > 10) {
      shortNotes = shortNotes.slice(0, 10) + "...";
    }
    const change = {
      target: {
        name: 'notes',
        value: shortNotes
      }
    };
    const p = document.createElement('p');
    p.textContent = 'Note: ' + '[' + note.author + '] ' + note.body;

    form.notes.push(note);
    this.handleChange(change);

    this.elements.noteSection.appendChild(p);
    if (this.elements.noteSection.classList.contains('hidden')) {
      this.elements.noteSection.classList.remove('hidden');
    }
  },
  setTimeout: function() {
    // do not set this when viewing the archive stack
    if (app.pages.form.currentStack === app.pages.openForms.stack) {
      app.pages.form.timeoutId = window.setTimeout(app.pages.form.checkForms, 60000);
    }
  },
  show: function() {
    if (window.isNaN(this.timeoutId)) {
      this.setTimeout();
    }
    this.refreshUpdateButton();
    this.elements.container.classList.remove("hidden");
    if (! app.modal.isShowing()) {
      app.omnibox.element.focus();
    }
  },
  timeoutId: NaN,
  unlock: function() {
    app.pages.form.locked = false;
  },
};
</script>
