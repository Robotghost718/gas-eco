<script>
  /* global app displayForm Form FormPage OpenFormsPage Omnibox */
  app.handlers = {
    /**
     * @see js/app/pages/Form
     * @see js/Init
     * prevents users from updating the form while the form is being saved
     */
    checkLock: function (event) {
      if (
        FormPage.isShowing() &&
        FormPage.isLocked() &&
        !app.modal.isShowing()
      ) {
        event.stopPropagation();
        return true;
      }
      return false;
    },

    /**
     * @see js/app/DoCommand
     * click routes user actions, usually to js.app.doCommand, sometimes
     *   with some additional filitering/modifying here
     */
    click: function (click) {
      if (app.handlers.checkLock(click)) {
        return;
      }
      if (click.target.tagName === "BUTTON") {
        app.handlers.button(click);
        return;
      }
      if (/^T[DH]$/.test(click.target.tagName)) {
        app.handlers.table(click);
        return;
      }
    },
    table: function (click) {
      const containsClass = (element, className) => {
        if (element.classList && element.classList.contains(className)) {
          return true;
        }
      };
      const path = click.composedPath();
      if (path.find((el) => containsClass(el, "modal"))) {
        app.modal.hide();
        document.querySelector("input.omnibox").value =
          click.target.parentNode.dataset.id;
        Omnibox.parse();
        return;
      }
    },
    button: function (click) {
      if (
        click.target.classList.contains("modalok") ||
        click.target.classList.contains("modalcancel")
      ) {
        app.modal.hide();
      }

      if (click.target.value == "checkInButton") {
        app.doCommand("checkInButton", click.target.dataset.itemid);
        return;
      }

      if (click.target.value == "itemQuantityChange") {
        const data = click.target.parentNode.dataset;
        app.modal.handleQuantityChange(
          OpenFormsPage.getCurrentForm().items.getByItem(data)
        );
        return;
      }

      if (click.target.value == "itemQuantityPlusOne") {
        const data = click.target.parentNode.dataset;
        app.doCommand("itemQuantityPlusOne", data);
        return;
      }

      if (click.target.value == "removeItem") {
        const data = click.target.parentNode.parentNode.dataset;
        app.doCommand("removeItem", data);
        return;
      }

      if (click.target.value.slice(0, 9) == "loseData_") {
        FormPage.loseData();
        click.target.value = click.target.value.slice(
          "loseData_".length,
          click.target.value.length
        );
        // check if blank form, undo actions from Display::displayNewForm
        if (FormPage.getSavedForm().isBlank()) {
          OpenFormsPage.getStack().pop();
          if (/(previous|next)Form/.test(click.target.value)) {
            displayForm(OpenFormsPage.getCurrentForm());
            return;
          } else if (click.target.value === "revert") {
            // if (!window.isNaN(app.pages.form.autosaveID)) {
            //   window.clearTimeout(app.pages.form.autosaveID);
            //   app.pages.form.autosaveID = NaN;
            // }
            app.doCommand("displayNewForm");
            return;
          }
        } else {
          // we were editing an active form; kill it
          OpenFormsPage.getStack().replaceCurrent(
            new Form(FormPage.getSavedForm())
          );
        }
      }
      app.doCommand(click.target.value);
    },
    keydown: function (keydown) {
      if (app.handlers.checkLock(keydown)) {
        return;
      }
    },
  };
</script>
