<script>
// Window level event handlers.
// Page and page element handlers are found under their respective pages
/* global app displayForm Form */
app.handlers = {
  /**
   * Attach this function to the beforeunload event whevener there is a form with
   * unsaved changes displayed.
   * @see {@link https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload}
   * @see app.changes.saved
   */
  beforeunload: function(event) {
    if (! app.changes.saved) {
      var confirmationMessage = "Are you sure?";
      event.returnValue = confirmationMessage;     // Gecko, Trident, Chrome 34+
      return confirmationMessage;              // Gecko, WebKit, Chrome <34
    } else {
      app.handlers.unload();
    }
  },

  /**
   * @see js/app/pages/Form
   * @see js/Init
   * prevents users from updating the form while the form is being saved
   */
  checkLock: function(event) {
    if (app.pages.form.isShowing() &&
        app.pages.form.isLocked() &&
        ! app.modal.isShowing()) {
      event.stopPropagation();
      return true;
    }
    return false;
  },

  /**
   * @see js/app/DoCommand
   * click routes user actions, usually to js.app.doCommand, sometimes
   *   with some additional filitering/modifying here
   */
  click: function(click) {
    if (app.handlers.checkLock(click)) {
      return;
    }
    if (click.target.tagName === 'BUTTON') {
      app.handlers.button(click);
      return;
    }
    if (/^T[DH]$/.test(click.target.tagName)) {
      app.handlers.table(click);
      return;
    }
  },
  table: function(click) {
    const containsClass = (element, className) => {
      if (element.classList && element.classList.contains(className)) {
        return true;
      }
    };
    const path = click.composedPath();
    if (path.find(el => containsClass(el, "modal"))) {
      app.modal.hide();
      app.omnibox.element.value = click.target.parentNode.dataset.id;
      app.omnibox.parse();
      return;
    }
    if (path.find(el => containsClass(el, "openFormsContainer"))) {
      if (click.target.tagName === 'TD') {
        app.pages.openForms.handleClickTable(click);
        return;
      }
      if (click.target.tagName === 'TH') {
        app.pages.openForms.handleClickTableHead(click);
        return;
      }
    }
    if (path.find(el => containsClass(el, "itemList"))) {
      app.pages.form.handleClickItem(click);
      return;
    }
    if (path.find(el => containsClass(el, "studentList"))) {
      app.pages.form.handleClickStudent(click);
      return;
    }
    if (path.find(el => containsClass(el, "staticFields"))) {
      app.pages.form.handleClickStaticTable(click);
      return;
    }
    if (path.find(el => containsClass(el, "archive"))) {
      if (click.target.tagName === 'TD') {
        app.pages.archive.handleClickTable(click);
        return;
      }
      if (click.target.tagName === 'TH') {
        app.pages.archive.handleClickTableHead(click);
        return;
      }
    }
  },
  button: function(click) {    
    if (click.target.classList.contains("modalok") ||
        click.target.classList.contains("modalcancel")) {
      app.modal.hide();
    }

    if (click.target.value == "checkInButton") {
      app.doCommand('checkInButton', click.target.dataset.itemid);
      return;
    }

    if (click.target.value == "itemQuantityChange") {
      const data = click.target.parentNode.dataset;
      app.modal.handleQuantityChange(app.pages.openForms.getCurrentForm()
        .items.getByItem(data));
      return;
    }

    if (click.target.value == "itemQuantityPlusOne") {
      const data = click.target.parentNode.dataset;
      app.doCommand("itemQuantityPlusOne", data);
      return;
    }

    if (click.target.value == "removeItem") {
      const data = click.target.parentNode.dataset;
      app.doCommand("removeItem", data);
      return;
    }

    if (click.target.value.slice(0,9) == 'loseData_') {
      app.changes.saved = true;
      app.pages.form.elements.updateButtonHint.textContent = '';
      app.pages.form.elements.updateFormButton.disabled = true;
      app.pages.form.elements.undoButton.disabled = true;
      click.target.value = click.target.value.slice('loseData_'.length, click.target.value.length);
      // check if blank form, undo actions from Display::displayNewForm
      if (app.pages.form.savedForm.isBlank()) {
        app.pages.openForms.stack.pop();
        if (/(previous|next)Form/.test(click.target.value)) {
          displayForm(app.pages.openForms.getCurrentForm());
          return;
        } else if (click.target.value === "revert") {
          if (! window.isNaN(app.pages.form.autosaveID)) {
            window.clearTimeout(app.pages.form.autosaveID);
            app.pages.form.autosaveID = NaN;
          }
          app.doCommand("displayNewForm");
          return;
        }
      } else { // we were editing an active form; kill it
        app.pages.openForms.stack.replaceCurrent(new Form(app.pages.form.savedForm));
      }
    }
    app.doCommand(click.target.value);
  },
  keydown: function(keydown) {
    if (app.handlers.checkLock(keydown)) {
      return;
    }
    // Allow esc to safely exit error messages
    if (keydown.key == 'Escape') {
      if (app.modal.isShowing()) {
        app.modal.hide();
      } else {
        keydown.target.blur();
      }
    }

    // Allow cmd + enter to submit/update form
    if (! app.pages.form.elements.updateFormButton.disabled &&
        ! app.modal.isShowing()) {
      if ((keydown.metaKey || keydown.ctrlKey) && keydown.key == 'Enter') {
        app.doCommand('updateForm');
        return;
      }
    }

    if (keydown.key === 'Enter' && app.modal.isShowing()) {
      app.modal.handleKeydown(keydown.key);
    }

    if (keydown.target === app.omnibox.element) {
      app.omnibox.handleKeydown(keydown);
    }
  },
  unload: function() {
    app.run.doPost({ post: 'unload' });
  },
};
</script>
