<script>
/* global
Item
app
populateItemList
populateStudentList
utility
*/
app.omnibox = {
  clear: function() {
    app.omnibox.element.value = '';
  },
  element: document.querySelector('input.omnibox'),
  handleItem: function(item, quantityToReturn, ambiguous = true) {
    const form = app.pages.openForms.getCurrentForm();
    const itemOnForm = form.items.find(i => {
      if (item.id && i.id == item.id) {
        return true;
      }
      if (item.barcode && i.barcode == item.barcode) {
        return true;
      }
      return false;
    });
    const change = { // fake change event
      target: {
        name: 'items',
        value: (item.id && ! /^manual/i.test(item.id)) ?
          item.id :
          item.description
      }
    };

    if (! itemOnForm) { // new item
      item = new Item(item); // copy it
      item.checkOut = utility.date.getFormattedDate(new Date());
      form.items.push(item);
      change.target.value += ' check-out';
    } else if (quantityToReturn && quantityToReturn != "all") {
      itemOnForm.changeQuantity(-quantityToReturn);
      change.target.value = `returned ${quantityToReturn} ${change.target.value}`;
    } else {
      const savedItem = app.pages.form.savedForm.items.getByItem(item);
      if (itemOnForm.checkOut && itemOnForm.checkIn) { // checkout again?
        this.clear();
        if (! savedItem.checkIn) {
          app.modal.handleError(new Error(`${itemOnForm.description} ` +
            `was just checked-in.  Update or revert to check-out again.`)
          );
          return;
        }
        app.modal.handleCheckOutAgain(itemOnForm);
        return;
      } else if (itemOnForm.checkOut) { // Its a check-in
        if (! savedItem || ! savedItem.checkOut || itemOnForm.checkedOutAgain) {
          this.clear();
          if (! item.isSerialized()) {
            app.modal.handleQuantityChange(item);
            return;
          }
          app.modal.handleError(
            new Error(
              `${item.description} was just checked-out. Update or revert the form to continue.`
            ));
          return;
        }
        if (! item.isSerialized() && ambiguous) {
          this.clear();
          app.modal.handleAmbiguousItemAction(itemOnForm);
          return;
        }
        itemOnForm.checkIn = utility.date.getFormattedDate(new Date());
        // clears the missing property if it was set.
        itemOnForm.missing = false;
        change.target.value += ' check-in';
      } else { // Its a check-out for reserved gear
        itemOnForm.checkOut = utility.date.getFormattedDate(new Date());
        change.target.value += ' check-out';
      }
    }

    // Update display
    utility.DOM.empty(app.pages.form.elements.itemList);
    form.items.reverse().forEach(populateItemList);
    app.omnibox.clear();
    // Fake change event
    app.pages.form.handleChange(change);
  },
  handleKeydown: function(keydown) {
    if (keydown.key == 'Enter') {
      keydown.preventDefault();
      app.omnibox.parse();
      return;
    }
  },
  /** TODO */
  handleNewCodabar: function(codabar /* string */) {
    // use modal
    app.modal.getNewCodabar(codabar);
  },
  /** @param {Student} input */
  handleStudent: function(student) {
    student = Object.assign({}, student);
    const form = app.pages.openForms.getCurrentForm();
    const students = form.students;
    const studentOnForm = students.find(s => s.netId == student.netId);
    const change = { // fake change event
      target: {
        name: 'students',
        value: student.name
      }
    };

    if (! studentOnForm) {
      if (! student.signatureOnFile) {
        app.modal.signatureWait();
        app.run.doPost({ post: 'startSignature', netid: student.netId });
        return;
      }
      student.checkIn = utility.date.getFormattedDate(new Date());
      students.push(student);
      change.target.value += ' check-in';
    } else {
      try {
        if (studentOnForm.checkIn && studentOnForm.checkOut) {
          throw new Error(studentOnForm.name + ' is already checked out.');
        } else if (studentOnForm.checkIn) {
          const savedStudent = app.pages.form.savedForm.students.find(s => s.netId == student.netId);
          if (! savedStudent || ! savedStudent.checkIn) {
            throw new Error( `${student.name} was just checked-in. Update the form before checking out.`);
          }
          if (form.hasItemsOut()) {
            throw new Error(app.strings.studentCheckOutError);
          }
          studentOnForm.checkOut = utility.date.getFormattedDate(new Date());
          change.target.value += ' check-out';
        } else {
          if (! student.signatureOnFile) {
            app.modal.signatureWait();
            app.run.doPost({ post: 'startSignature', netid: student.netId});
            return;
          } else {
            studentOnForm.checkIn = utility.date.getFormattedDate(new Date());
            change.target.value += ' check-in';
          }
        }

      }
      catch(error) {
        app.modal.handleError(error);
        app.omnibox.element.classList.add('error');
        window.setTimeout(
          () => app.omnibox.element.classList.remove('error'), 2000
        );
        return;
      }
    }
    // Update display
    utility.DOM.empty(app.pages.form.elements.studentList);
    students.forEach(populateStudentList);
    app.omnibox.clear();
    // Fake change event
    app.pages.form.handleChange(change);
  },
  logManualEntry: function(value) {
    app.pages.form.handleChange({target: {name: "manual", value}});
  },
  /**
   * parse examines the current value of the omnibox text input element
   *   and passes the value to the correct handler or shows the user an error.
   */
  parse: function() {
    let value = this.element.value;

    if (! value) { // nothing was entered, abort
      return;
    }
    
    if (/^\s*\[\s*{\s*"/.test(value)) { // JSON array of objects: "[{}]"
      JSON.parse(value).forEach(this.handleItem);
      return;
    }

    value = value.toLowerCase(); // case insenstive input
    let parsed;
    // DETERMINE TYPE: ID card barcode, item barcode, item ID/SKU, student name
    const codabarRegex = /^[a-d][0-9]{5,}[a-d]$/; // "a123...789b" pattern
    if (codabarRegex.test(value)) { // Check student id
      parsed = app.roster.find(
        student => student.id.toLowerCase() == value
      );
      if (parsed) {
        this.handleStudent(parsed);
        return;
      }
      this.handleNewCodabar(value);
      return;
    }

    const idType = /^[a-z]+[0-9]+/.test(value) ? 'netId' : 'name'; // Check student name and id
    parsed = app.roster.find(
      student => student[idType].toLowerCase() == value
    );
    if (parsed) {
      this.logManualEntry(this.element.value);
      this.handleStudent(parsed);
      return;
    }

    const itemIdregex = /[A-Za-z]+-[A-Za-z0-9]+/, // letter(s), hyphen, digit(s) or letter(s)
          barcoderegex = /^[0-9]+$/;              // only digits
    if (itemIdregex.test(value)) {
      parsed = app.inventory.getById(value);
      if (! parsed && /^manual/.test(value)) {
        parsed = app.pages.openForms.getCurrentForm().items.find(
          item => item.id.toLowerCase().replace(/-0+/, '-') == value
        );
      } else {
        this.logManualEntry(this.element.value);
      }
    } else if (barcoderegex.test(value)) { // assume it's a barcode
      if (value == app.strings.manualItemBarcode) {
        this.clear();
        app.doCommand("newManual");
        return;
      }
      parsed = app.inventory.getByBarcode(value);
    }
    if (parsed) {
      this.handleItem(new Item(parsed));
      return;
    }

    this.clear();

    const queryResults = utility.query(value.replace(/'/g, ""), (obj) => {
      if (obj instanceof Item) {
        const keys = [];
        if (obj.description !== "") {
          keys.push(obj.description.trim().toLowerCase());
        }
        if (obj.id !== "") {
          keys.push(obj.id.trim().toLowerCase());
        }
        return keys;
      }
      // else it is a student
      return [obj.name.trim().toLowerCase().replace(/'/g, "")];
    }, app.inventory.slice(), app.roster).filter(result => result.weight < 4);

    if (queryResults.length > 0) {
      app.modal.handleQuery(queryResults);
      return;
    }
    app.modal.handleError(new Error(`"${value}" ${app.strings.parserError}`));
  },
};
</script>
