<script>
  /* global
  ClosedFormsPage
  DateUtils
  Form
  FormPage
  HTML
  LoadingPage
  OpenFormsPage
  Utility
  google
  */
  /* exported App */
  const App = (function () {
    const { button, createElement, modal, paragraph, update } = HTML;
    const { last, tryJsonParse } = Utility;
    const { getFormattedDateTime } = DateUtils;
    const state = {
      changeStack: [], // each change produces a new Form
      closedForms: null,
      closedFormsQuery: {},
      inventory: null,
      openForms: null,
      roster: null,
      saved: true,
      undoStack: [], // each "undo" takes from changeStack, for "redo", cleared on change
    };
    const newFormButton = button("New Form", {
      class: "share",
      disabled: true,
      onClick: () => {
        const onOk = () => {
          const form = new Form({});
          state.openForms.push(form);
          setForm(form);
        };
        if (!state.saved) loseDataWarning(onOk);
        else onOk();
      },
    });
    const openFormsButton = button("View Open Forms", {
      disabled: true,
      onClick: (_, button) => {
        button.setAttribute("disabled", true);
        // check for unsaved changes, TBD,
        state.openForms = null;
        withErrorHandler
          .withSuccessHandler(onOpenForms)
          .doGet({ get: "openForms" });
        showLoadingPage();
      },
    });
    const closedFormsButton = button("View Closed Forms", {
      disabled: true,
      onClick: () => {
        const onOk = () => showClosedFormsPage();
        if (!state.saved) loseDataWarning(onOk);
        else onOk();
      },
    });
    const usernameDisplay = createElement("span", { class: "usernameDisplay" });
    const pageContainer = createElement("div", {
      child: LoadingPage({
        rosterStatus: "Loading students...",
        inventoryStatus: "Loading inventory...",
        openFormsStatus: "Loading open forms...",
      }),
    });
    document.body.appendChild(
      HTML.page({
        hidden: false,
        name: "app",
        children: [
          createElement("header", {
            children: [
              HTML.heading1("Equipment Check Out"),
              createElement("span", {
                class: "usernameContainer",
                textContent: "signed in as ",
                child: usernameDisplay,
              }),
            ],
          }),
          createElement("nav", {
            children: [newFormButton, openFormsButton, closedFormsButton],
          }),
          pageContainer,
        ],
      })
    );

    const withErrorHandler = google.script.run.withFailureHandler((error) => {
      console.error(error);
      displayErrorMessage(error.message);
    });

    // initial server calls
    withErrorHandler
      .withSuccessHandler(onOpenForms)
      .doGet({ get: "openForms", init: true });
    withErrorHandler
      .withSuccessHandler(
        (response) => (usernameDisplay.textContent = response.user)
      )
      .doGet({ get: "user" });
    withErrorHandler
      .withSuccessHandler(onRoster)
      .doGet({ get: "students", init: true });
    withErrorHandler
      .withSuccessHandler(onInventory)
      .doGet({ get: "items", init: true });
    withErrorHandler.withSuccessHandler(onClosedForms).doGet({
      get: "archive",
      dateRangeJSON: JSON.stringify({
        start: getFormattedDateTime(new Date("01/01/2019")),
        end: getFormattedDateTime(new Date()),
      }),
      init: true,
    });

    /**
     * @see {@link https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload}
     */
    window.addEventListener("beforeunload", function (event) {
      if (!state.saved) {
        const confirmationMessage = "Are you sure?";
        event.returnValue = confirmationMessage; // Gecko, Trident, Chrome 34+
        return confirmationMessage; // Gecko, WebKit, Chrome <34
      } else {
        // handlers.onUnload();
      }
    });

    // have to attach to window to catch this regardless of focus
    // should probably check context, because this is currently a FormPage
    // context, but could not figure out how to declare inside FormPage
    window.addEventListener("keydown", (event) => {
      if (
        event.target.tagName &&
        event.target.tagName.toLowerCase() === "input"
      )
        return;
      if (
        (event.metaKey || event.ctrlKey) &&
        !event.shiftKey &&
        event.key === "z"
      ) {
        event.preventDefault();
        return onUndo();
      }
      if (
        (event.metaKey || event.ctrlKey) &&
        event.shiftKey &&
        event.key === "z"
      ) {
        event.preventDefault();
        return onRedo();
      }
    });

    //---- function definitions

    function onInventory(response) {
      const inventory = tryJsonParse(response.items);
      if (!inventory)
        return displayErrorMessage("Error getting inventory from server");
      if (!inventory.length) {
        return displayErrorMessage("Error: Server found no items!");
      }
      state.inventory = inventory;
      if (response.unlock) {
        tryUnlock();
      }
    }

    function onSubmit(
      form,
      onSuccess = () => undefined,
      onFailure = () => undefined
    ) {
      google.script.run
        .withFailureHandler((error) => {
          displayErrorMessage(error.message);
          onFailure();
        })
        .withSuccessHandler((response) => {
          if (response.target === "updateForm") {
            const updatedForm = new Form(JSON.parse(response.form));
            // OpenFormsPage.getStack()
            //   .replace(updatedForm)
            //   .updateIndex(updatedForm);
            onSuccess(updatedForm);
            return;
          }
          if (response.target === "openForms") {
            onSuccess();
            return onOpenForms(response);
          }
          if (response.target === "collision") {
            onFailure();
            return onCollision(response);
          }
          if (response.target === "invalid") {
            onFailure();
            return displayErrorMessage("Form is invalid");
          }
        })
        .doPost({
          post: "updateForm",
          form,
        });
    }

    function onDelete(form) {
      if (form)
        withErrorHandler
          .withSuccessHandler((response) => {
            if (response.post === "openForms") return onOpenForms(response);
            if (response.post === "collision") return onCollision(response);
          })
          .doPost({ post: "deleteForm", form });
      else
        withErrorHandler
          .withSuccessHandler((response) => {
            onOpenForms(response);
          })
          .doGet({ get: "openForms" });
    }

    function onNeedsSignature(netid) {
      let canceled = false;
      modal({
        children: [HTML.heading1("Add signature"), paragraph("Please wait...")],
        closeText: "Cancel",
        onClose: () => (canceled = true),
      });
      withErrorHandler
        .withSuccessHandler((_, context) => {
          if (canceled) {
            // user aborted by hitting "cancel"
            return;
          }
          context.modal.remove();
          modal({
            children: [
              HTML.heading1("Add signature"),
              paragraph(
                "Production area policy acknowledgment signature not found " +
                  "for this person. All persons must read the policy and have " +
                  "a signature on file. Please use the tablet to show the " +
                  "person the policy and capture their signature. " +
                  "Click the 'Signature Done/Recheck' when they are finished " +
                  "using the tablet."
              ),
            ],
            okText: "Signature Done/Recheck",
            onOk: () =>
              withErrorHandler
                .withSuccessHandler(onRoster)
                .doGet({ get: "students", init: false }),
          });
        })
        .withUserObject({ canceled })
        .doPost({ post: "startSignature", netid });
    }

    function onNewCodabar({ netId, codabar }) {
      FormPage.setUpdateFormButtonToSpinner();
      withErrorHandler
        .withSuccessHandler((response) => {
          Omnibox.setRoster(JSON.parse(response.students));
          Omnibox.parse();
        })
        .doPost({
          post: "codabar",
          netId,
          codabar,
        });
    }

    function showLoadingPage() {
      update(
        pageContainer,
        LoadingPage({
          rosterStatus: state.roster
            ? `${state.roster.length} people downloaded`
            : "Loading students...",
          inventoryStatus: state.inventory
            ? `${state.inventory.length} items downloaded`
            : "Loading inventory...",
          openFormsStatus: state.openForms
            ? `${state.openForms.length} open forms downloaded`
            : "Loading open forms...",
        })
      );
    }

    /**
     * tryUnlock controls when the loading page switches to the open forms page
     */
    function tryUnlock() {
      // const rosterLength = Omnibox.getRoster().length,
      //   inventoryLength = Omnibox.getInventory().getLength(),
      //   stack = new Stack(), //OpenFormsPage.getStack(),
      //   stackInit = stack.isInitialized();
      showLoadingPage();
      if (![state.inventory, state.roster, state.openForms].every(Boolean)) {
        return false;
      }
      openFormsButton.removeAttribute("disabled");
      newFormButton.removeAttribute("disabled");
      showOpenFormsPage();
      return true;
    }

    function showOpenFormsPage() {
      update(
        pageContainer,
        OpenFormsPage({ openForms: state.openForms, setForm, setOpenForms })
      );
    }

    function showClosedFormsPage() {
      update(
        pageContainer,
        ClosedFormsPage({
          closedForms: state.closedForms,
          closedFormsQuery: state.closedFormsQuery,
          setClosedFormsQuery: (query) => (state.closedFormsQuery = query),
          setForm: (form) => setForm(form, true),
          setOpenForms,
        })
      );
    }

    function setOpenForms(forms) {
      state.openForms = forms;
      showOpenFormsPage();
    }

    function onClosedForms(response) {
      const closedForms = tryJsonParse(response.formList);
      if (!closedForms)
        return displayErrorMessage(
          "Server was unable to retrieve the closed forms."
        );
      state.closedForms = closedForms.map((form) => new Form(form));
      response.unlock && closedFormsButton.removeAttribute("disabled");
    }

    function onCollision(response) {
      response.storedForm = tryJsonParse(response.storedForm);
      response.submittedForm = tryJsonParse(response.submittedForm);
      modal({
        children: [
          HTML.heading1("Uh-oh, your form conflicts with another form"),
          paragraph(
            "Unfortunately a newer version of the form has been found on the server.  In a future update you can save your work, but for now we have to destroy it.  Sorry!!"
          ),
        ],
        onClose: () =>
          alert("Whoops, forgot to implement this. Please refresh the page!"),
      });
    }

    function onOpenForms(response) {
      const openForms = tryJsonParse(response.formList);
      if (!openForms)
        return displayErrorMessage(
          "Error: server failed to get the open forms."
        );
      state.openForms = openForms.map((form) => new Form(form));
      tryUnlock();
    }

    function onRoster(response) {
      const roster = tryJsonParse(response.students);
      if (!roster)
        return displayErrorMessage("Error getting roster from server.");
      if (roster.length < 1) {
        return displayErrorMessage("No students found");
      }
      state.roster = roster;
      if (response.unlock) tryUnlock();
      else Omnibox.parse();
    }

    function displayErrorMessage(message) {
      modal({
        children: [HTML.heading1("Error"), paragraph(message)],
      });
    }

    function setForm(form, disabled = false) {
      if (state.saved) {
        state.changeStack = [form];
        state.undoStack = [];
      }
      update(
        pageContainer,
        FormPage({
          disabled,
          form,
          formIndexDisplay: `${
            state.openForms.findIndex((f) => f === form) + 1
          }/${state.openForms.length}`,
          onDelete,
          onSubmit,
          onChange,
          onUndo,
          onRedo,
          saved: state.saved,
          username: getUsername(),
        })
      );
    }

    function onUndo() {
      if (state.changeStack.length === 1)
        return modal({
          child: paragraph("Nothing to undo."),
        });
      state.undoStack.push(state.changeStack.pop());
      setForm(last(state.changeStack));
    }

    function onRedo() {
      if (!state.undoStack.length)
        return modal({ child: paragraph("Nothing to redo.") });
      state.changeStack.push(state.undoStack.pop());
      setForm(last(state.changeStack));
    }

    function onChange({
      form,
      change: {
        target: { name, value },
      },
    }) {
      const newForm = new Form({
        ...form,
        notes: [
          ...form.notes,
          {
            timestamp: Date.now(),
            author: getUsername(),
            // body is JSON to be compatible with legacy forms
            // if diff'ing notes vs changes can be updated, stop stringifying here
            body: JSON.stringify([{ name, value }]),
          },
        ],
      });
      state.changeStack.push(newForm);
      state.undoStack = [];
      state.saved = false;
      setForm(newForm);
    }

    function getUsername() {
      const el = document.querySelector("span.usernameDisplay");
      return el && el.textContent ? el.textContent : "anonymous";
    }

    function loseDataWarning(onOk) {
      modal({
        children: [
          HTML.heading1("Warning, your changes are not saved"),
          paragraph("Are you sure?"),
        ],
        closeText: "Cancel",
        okText: "Lose changes",
        onOk,
      });
    }
  })();
</script>
