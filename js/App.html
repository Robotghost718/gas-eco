<script>
  /* global
  ClosedFormsPage
  Form
  FormPage
  HTML
  LoadingPage
  Omnibox
  OpenFormsPage
  Stack
  google
  */
  /* exported App */
  const App = (function () {
    const state = {
      roster: null,
      closedForms: null,
      openForms: null,
      inventory: null,
      savedForm: null,
      currentForm: null,
      saved: true,
    };
    const elements = {
      newFormButton: HTML.createElement("button", {
        textContent: "New Form",
        class: "share",
        disabled: true,
        onClick: () => {
          const onOk = () => {
            const form = new Form({});
            state.openForms.push(form);
            setForm(form);
          };
          if (!state.saved) loseDataWarning(onOk);
          else onOk();
        },
      }),
      openFormsButton: HTML.createElement("button", {
        textContent: "View Open Forms",
        disabled: true,
        onClick: (_, button) => {
          button.setAttribute("disabled", true);
          // check for unsaved changes, TBD,
          state.openForms = null;
          withErrorHandler
            .withSuccessHandler(onOpenForms)
            .doGet({ get: "openForms" });
          showLoadingPage();
        },
      }),
      closedFormsButton: HTML.createElement("button", {
        textContent: "View Closed Forms",
        disabled: true,
        onClick: () => {
          // const onOk = () => showPage(ClosedFormsPage);
          // if (!FormPage.isSaved()) FormPage.loseDataWarning(onOk);
          // else onOk();
        },
      }),
      usernameDisplay: HTML.createElement("span", { class: "usernameDisplay" }),
    };
    const pageContainer = HTML.createElement("div", {
      child: LoadingPage({
        rosterStatus: "Loading students...",
        inventoryStatus: "Loading inventory...",
        openFormsStatus: "Loading open forms...",
      }),
    });
    document.body.appendChild(
      HTML.page({
        hidden: false,
        name: "app",
        children: [
          HTML.createElement("header", {
            children: [
              HTML.heading1("Equipment Check Out"),
              HTML.createElement("span", {
                class: "usernameContainer",
                textContent: "signed in as ",
                child: elements.usernameDisplay,
              }),
            ],
          }),
          HTML.createElement("nav", {
            children: [
              elements.newFormButton,
              elements.openFormsButton,
              elements.closedFormsButton,
            ],
          }),
          pageContainer,
        ],
      })
    );

    const withErrorHandler = google.script.run.withFailureHandler((error) => {
      console.error(error);
      displayErrorMessage(error.message);
    });

    // OpenFormsPage.setHandlers({
    //   clickTable: ({ form }) => FormPage.displayForm(form),
    // });
    // Omnibox.setHandlers({
    //   onLogManualEntry: (value) =>
    //     FormPage.handleChange({ target: { name: "manual", value } }),
    //   onItemChange: (change) => {
    //     HTML.toast(`${change.target.value} OK`);
    //     FormPage.updateItems(change);
    //   },
    //   onStudentChange: (change) => {
    //     HTML.toast(`${change.target.value} OK`);
    //     FormPage.updateStudents(change);
    //   },
    //   onNewCodabar,
    //   onNeedsSignature,
    // });
    // Omnibox.setConnections({
    //   getSavedForm: FormPage.getSavedForm,
    //   getCurrentForm: () => undefined, //OpenFormsPage.getCurrentForm,
    // });
    // Omnibox.setElement(FormPage.getOmnibox());
    // FormPage.setHandlers({
    //   onDelete,
    //   // onDisplayForm: () => showPage(FormPage),
    //   onItemMetaClick: Omnibox.setInputAndParse,
    //   onItemQuantityChange: Omnibox.handleItem,
    //   onManualEntry: Omnibox.manualEntry,
    //   onModalQuantityChange: (item) => Omnibox.makeQuantityChangeDialog(item)(),
    //   onParseInput: Omnibox.parse,
    //   onStudentMetaClick: Omnibox.setInputAndParse,
    //   onSubmit,
    //   onUnload: () => withErrorHandler.doPost({ post: "unload" }),
    // });
    // FormPage.setConnections({
    //   getCurrentForm: () => undefined, //OpenFormsPage.getCurrentForm,
    //   getStack: () => undefined, //OpenFormsPage.getStack,
    // });
    // ClosedFormsPage.setHandlers({
    //   onFormSelect: FormPage.displayForm,
    //   onUpdate: (dateRangeJSON) =>
    //     withErrorHandler
    //       .withSuccessHandler(onClosedForms)
    //       .doGet({ get: "archive", dateRangeJSON }),
    // });
    // ClosedFormsPage.setConnections({
    //   setCurrentStack: FormPage.setCurrentStack,
    // });

    // initial server calls
    withErrorHandler
      .withSuccessHandler(onOpenForms)
      .doGet({ get: "openForms", init: true });
    withErrorHandler
      .withSuccessHandler(
        (response) => (elements.usernameDisplay.textContent = response.user)
      )
      .doGet({ get: "user" });
    withErrorHandler
      .withSuccessHandler(onRoster)
      .doGet({ get: "students", init: true });
    withErrorHandler
      .withSuccessHandler(onInventory)
      .doGet({ get: "items", init: true });
    withErrorHandler.withSuccessHandler(onClosedForms).doGet({
      get: "archive",
      dateRangeJSON: ClosedFormsPage.getDateRangeAsJSON(),
      init: true,
    });

    //---- function definitions

    function onInventory(response) {
      // const inventory = Omnibox.getInventory();
      // inventory.setItems(JSON.parse(response.items));
      try {
        var inventory = JSON.parse(response.items);
      } catch (error) {
        return displayErrorMessage("Error getting inventory from server");
      }
      if (!inventory.length) {
        return displayErrorMessage("Error: Server found no items!");
      }
      state.inventory = inventory;
      if (response.unlock) {
        tryUnlock();
      }
    }

    function onSubmit(
      form,
      onSuccess = () => undefined,
      onFailure = () => undefined
    ) {
      google.script.run
        .withFailureHandler((error) => {
          displayErrorMessage(error.message);
          onFailure();
        })
        .withSuccessHandler((response) => {
          if (response.target === "updateForm") {
            const updatedForm = new Form(JSON.parse(response.form));
            // OpenFormsPage.getStack()
            //   .replace(updatedForm)
            //   .updateIndex(updatedForm);
            onSuccess(updatedForm);
            return;
          }
          if (response.target === "openForms") {
            onSuccess();
            return onOpenForms(response);
          }
          if (response.target === "collision") {
            onFailure();
            return onCollision(response);
          }
          if (response.target === "invalid") {
            onFailure();
            return displayErrorMessage("Form is invalid");
          }
        })
        .doPost({
          post: "updateForm",
          form,
        });
    }

    function onDelete(form) {
      if (form)
        withErrorHandler
          .withSuccessHandler((response) => {
            if (response.post === "openForms") return onOpenForms(response);
            if (response.post === "collision") return onCollision(response);
          })
          .doPost({ post: "deleteForm", form });
      else
        withErrorHandler
          .withSuccessHandler((response) => {
            onOpenForms(response);
          })
          .doGet({ get: "openForms" });
    }

    function onNeedsSignature(netid) {
      const modal = HTML.modal({
        children: [
          HTML.heading1("Add signature"),
          HTML.paragraph("Please wait..."),
        ],
        closeText: "Cancel",
      });
      withErrorHandler
        .withSuccessHandler((_, context) => {
          if (!context.modal) {
            // user aborted by hitting "cancel"
            return;
          }
          context.modal.remove();
          HTML.modal({
            children: [
              HTML.heading1("Add signature"),
              HTML.paragraph(
                "Production area policy acknowledgment signature not found " +
                  "for this person. All persons must read the policy and have " +
                  "a signature on file. Please use the tablet to show the " +
                  "person the policy and capture their signature. " +
                  "Click the 'Signature Done/Recheck' when they are finished " +
                  "using the tablet."
              ),
            ],
            okText: "Signature Done/Recheck",
            onOk: () =>
              withErrorHandler
                .withSuccessHandler(onRoster)
                .doGet({ get: "students", init: false }),
          });
        })
        .withUserObject({ modal })
        .doPost({ post: "startSignature", netid });
    }

    function onNewCodabar({ netId, codabar }) {
      FormPage.setUpdateFormButtonToSpinner();
      withErrorHandler
        .withSuccessHandler((response) => {
          Omnibox.setRoster(JSON.parse(response.students));
          Omnibox.parse();
        })
        .doPost({
          post: "codabar",
          netId,
          codabar,
        });
    }

    // function checkLock() {
    //   return (
    //     FormPage.isShowing() &&
    //     FormPage.isLocked() &&
    //     !document.querySelector(".modal")
    //   );
    // }

    function showLoadingPage() {
      updatePageContainer(
        LoadingPage({
          rosterStatus: state.roster
            ? `${state.roster.length} people downloaded`
            : "Loading students...",
          inventoryStatus: state.inventory
            ? `${state.inventory.length} items downloaded`
            : "Loading inventory...",
          openFormsStatus: state.openForms
            ? `${state.openForms.length} open forms downloaded`
            : "Loading open forms...",
        })
      );
    }

    /**
     * tryUnlock controls when the loading page switches to the open forms page
     */
    function tryUnlock() {
      // const rosterLength = Omnibox.getRoster().length,
      //   inventoryLength = Omnibox.getInventory().getLength(),
      //   stack = new Stack(), //OpenFormsPage.getStack(),
      //   stackInit = stack.isInitialized();
      showLoadingPage();
      if (![state.inventory, state.roster, state.openForms].every(Boolean)) {
        return false;
      }
      elements.openFormsButton.removeAttribute("disabled");
      elements.newFormButton.removeAttribute("disabled");
      updatePageContainer(
        OpenFormsPage({ openForms: state.openForms, setForm })
      );
      return true;
    }

    function onClosedForms(response) {
      try {
        var closedForms = response.formList;
      } catch (error) {
        return displayErrorMessage(
          "Server was unable to retrieve the closed forms."
        );
      }
      state.closedForms = closedForms;
      if (response.unlock) {
        elements.closedFormsButton.removeAttribute("disabled");
      }
      ClosedFormsPage.query();
    }

    function onCollision(response) {
      response.storedForm = JSON.parse(response.storedForm);
      response.submittedForm = JSON.parse(response.submittedForm);
      HTML.modal({
        children: [
          HTML.heading1("Uh-oh, your form conflicts with another form"),
          HTML.paragraph(
            "Unfortunately a newer version of the form has been found on the server.  In a future update you can save your work, but for now we have to destroy it.  Sorry!!"
          ),
        ],
        onClose: () => FormPage.displayForm(JSON.parse(response.storedForm)),
      });
    }

    function onOpenForms(response) {
      try {
        var openForms = JSON.parse(response.formList);
      } catch (error) {
        return displayErrorMessage(
          "Error: server failed to get the open forms."
        );
      }
      // FormPage.setCurrentStack(stack);
      state.openForms = openForms.map((form) => new Form(form));
      //! TODO check that the "saved" prop is updated by something else, should be Changes.clear()
      // app.changes.saved = true;
      tryUnlock();
    }

    function onOpenFormsQuiet(response, context) {
      const stack = OpenFormsPage.getStack();
      if (context.timeoutId != OpenFormsPage.getRefreshId()) {
        return; // we are in an undefined state, abort
      }
      try {
        stack.importForms(JSON.parse(response.formList)).sortForms();
      } catch (error) {
        // TODO - try something else, set timeout to try later ?
      }
    }

    function onCheckForms(response) {
      //case "checkForms"
      let newForms = JSON.parse(response.formList);
      if (!newForms[0]) return;
      newForms = new Stack(newForms);
      // determine current context, see FormPage.{show,hide}
      // for why timeoutId shows context
      if (
        //! Removing this "timeoutId" tracking. Rethink
        // context.timeoutId != app.pages.form.timeoutId ||
        FormPage.getCurrentStack() === ClosedFormsPage.getStack()
      ) {
        return;
      }
      newForms.sortForms();
      const staleForm = FormPage.getCurrentStack().getCurrentForm();
      const newForm = newForms.getByID(staleForm.id);
      if (!newForm) {
        // must be a new form, nothing to do, abort
        return;
      }
      // are changes saved?
      if (FormPage.isSaved()) {
        //OpenFormsPage.setStack(newForms);
        FormPage.displayForm(newForm);
        // app.pages.form.setTimeout(); //! TODO rethink
      } else {
        if (newForm.hash !== staleForm.hash) {
          // another instance has already updated this form; do not set timeout
          withErrorHandler
            .withSuccessHandler(() =>
              HTML.toast("The form you were editing was saved on the server.")
            )
            .doPost({
              post: "rejected",
              form: staleForm.stringify(),
            });
          HTML.modal({
            children: [
              HTML.heading1("Uh-oh, your form conflicts with another form"),
              HTML.paragraph(
                "Unfortunately, no automatic fix is available, but your form " +
                  'has been saved.  To keep viewing your form, choose "Close".'
              ),
            ],
            okText: "Switch to the saved form",
            onOk: () => {
              FormPage.getCurrentStack().replaceCurrent(newForm);
              // app.changes.saved = true;
              FormPage.lockButtons();
              FormPage.displayForm(newForm);
            },
          });
        } else {
          // editing the current form; keep checking
          // app.pages.form.setTimeout(); //! TODO rethink
        }
      }
    }

    function onRoster(response) {
      try {
        var roster = JSON.parse(response.students);
      } catch (error) {
        return displayErrorMessage("Error getting roster from server.");
      }
      if (roster.length < 1) {
        return displayErrorMessage("No students found");
      }
      state.roster = roster;
      if (response.unlock) {
        tryUnlock();
      } else {
        Omnibox.parse();
      }
    }

    function displayErrorMessage(message) {
      HTML.modal({
        children: [HTML.heading1("Error"), HTML.paragraph(message)],
      });
    }

    function updatePageContainer(page) {
      HTML.empty(pageContainer);
      pageContainer.appendChild(page);
    }

    function setForm(form) {
      updatePageContainer(
        FormPage({
          form,
          omnibox: HTML.createElement("input", { type: "text" }),
          submit: () => displayErrorMessage("submit is disabled"),
          onChange: console.log,
        })
      );
    }

    function loseDataWarning(onOk) {
      HTML.modal({
        children: [
          HTML.heading1("Warning, your changes are not saved"),
          HTML.paragraph("Are you sure?"),
        ],
        closeText: "Cancel",
        okText: "Lose changes",
        onOk,
      });
    }
  })();
</script>
