<script>
  /* global Config DateUtils HTML Utility DateTimeInput */
  /* exported FormPage */
  function FormPage({
    form,
    disabled = false,
    savable = false,
    formIndexDisplay = "",
    omnibox,
    submit,
    onChange,
  }) {
    console.log(form);
    // submodule to track form changes
    const Changes = (function () {
      let saved = true;
      let stack = [];
      return {
        add(change) {
          let newChange = {
            name: change.target.name,
            value: change.target.value,
            timestamp: Date.now(),
          };
          stack.push(newChange);
          saved = false;
        },
        clear() {
          stack = [];
          saved = true;
        },
        getStack() {
          return stack.slice();
        },
        isSaved() {
          return saved;
        },
        makeNote() {
          return {
            timestamp: Date.now(),
            author: getUsername(),
            body: JSON.stringify(this.stack),
          };
        },
      };
    })();

    /**
     * @see {@link https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload}
     */
    window.addEventListener("beforeunload", function (event) {
      if (!Changes.isSaved()) {
        const confirmationMessage = "Are you sure?";
        event.returnValue = confirmationMessage; // Gecko, Trident, Chrome 34+
        return confirmationMessage; // Gecko, WebKit, Chrome <34
      } else {
        // handlers.onUnload();
      }
    });

    return HTML.page({
      name: "form",
      children: [
        HTML.createElement("form", {
          class: "model",
          onSubmit: (e) => e.preventDefault(),
          children: [
            HTML.createElement("input", { type: "hidden", name: "notes" }),
            HTML.createElement("input", { type: "hidden", name: "startTime" }),
            HTML.createElement("input", { type: "hidden", name: "endTime" }),
            HTML.createElement("section", {
              class: "formControls",
              children: [
                HTML.createElement("div", {
                  tabindex: 0,
                  // onFocus: () => locationSelect.focus(),
                }),
                omnibox,
                HTML.button("ðŸ”Ž", {
                  class: "buttonSmall",
                  disabled,
                  tabindex: -1,
                  onClick: () => alert("parse input disabled"), //handlers.onParseInput(),
                }),
                HTML.button("Add item without barcode or ID", {
                  disabled,
                  tabindex: -1,
                  onClick: () => alert("manual entry disabled"), //handlers.onManualEntry(),
                }),
                HTML.button("New note", {
                  class: "action",
                  disabled,
                  tabindex: -1,
                  onClick: () => {
                    const input = HTML.createElement("textarea");
                    HTML.modal({
                      children: [
                        HTML.heading1("New note"),
                        HTML.paragraph("Enter a note"),
                        input,
                      ],
                      okText: "Save note",
                      onOk: () => saveNote(input.value),
                    });
                    input.focus();
                  },
                }),
                HTML.button("Change log", {
                  tabindex: -1,
                  onClick: onChangeLog,
                }),
                HTML.button("Copy items to clipboard", {
                  class: disabled ? "" : "hidden",
                  tabindex: -1,
                  onClick: () => alert("copy items disabled"),
                  // Utility.copyToClipboard(
                  //   JSON.stringify(
                  //     getCurrentStack().getCurrentForm().items.getStripped()
                  //   )
                  // ),
                }),
                HTML.br(),
                HTML.button("Previous form", {
                  tabindex: -1,
                  onClick: () => alert("get previous disabled"), //getPrevious,
                }),
                HTML.button("Next form", {
                  tabindex: -1,
                  onClick: () => alert("get next disabled"), //getNext,
                }),
                HTML.createElement("span", {
                  textContent: formIndexDisplay,
                }),
                HTML.br(),
                HTML.button("Submit", {
                  disabled: disabled || !savable,
                  class: "action buttonTight",
                  onClick: submit,
                }),
                HTML.button("Save as advance booking", {
                  class: `action buttonTight${form.isBlank() ? "" : " hidden"}`,
                  disabled: disabled || !savable,
                  tabindex: -1,
                  onClick: () => {
                    HTML.modal({
                      children: [
                        HTML.heading1("Save for later?"),
                        HTML.paragraph(
                          "All sign-in and check-out info will be removed. " +
                            "Add all people and items before saving. " +
                            "You can only do this once."
                        ),
                      ],
                      closeText: "Cancel",
                      okText: "Save as advance booking",
                      onOk: makeAdvanceBooking,
                    });
                  },
                }),
                HTML.button("Revert to saved form", {
                  disabled,
                  onClick: () =>
                    HTML.modal({
                      children: [
                        HTML.heading1("Undo all changes"),
                        HTML.paragraph(
                          "Do you want to undo all changes since the last save?"
                        ),
                      ],
                      okText: "Revert to saved form",
                      onOk: () => undefined,
                    }),
                }),
                HTML.createElement("span", {
                  class: "updateButtonHint",
                  textContent: getUpdateButtonHint(),
                }),
              ],
            }),
            HTML.createElement("section", {
              class: "globalnotes",
              children: form.notes.reduce((notes, note) => {
                if (Utility.tryJsonParse(note.body)) return notes;
                return [
                  ...notes,
                  HTML.createElement("p", {
                    textContent: `Note: [${note.author}] ${note.body}`,
                  }),
                ];
              }, []),
            }),
            HTML.createElement("section", {
              children: [
                HTML.createElement("table", {
                  class: "staticFields",
                  children: [
                    ...[
                      ["Booked Students", "bookedStudents"],
                      ["Contact", "contact"],
                      ["Project", "project"],
                      ["Analog Tape", "tape"],
                      ["Overnight Setup", "overnight"],
                    ].reduce(
                      (rows, [textContent, key]) =>
                        form[key]
                          ? [
                              ...rows,
                              HTML.createElement("tr", {
                                children: [
                                  HTML.headerCell(textContent),
                                  HTML.cell(form[key]),
                                ],
                              }),
                            ]
                          : rows,
                      []
                    ),
                    HTML.row(
                      HTML.headerCell("Location"),
                      HTML.cell({
                        textContent: form.location || "",
                        onClick: form.location
                          ? (_, locationDisplay) => {
                              if (disabled) return;
                              locationDisplay.parentNode.appendChild(
                                locationSelect()
                              );
                              locationDisplay.remove();
                            }
                          : () => undefined,
                        children: form.location ? [] : [locationSelect()],
                      })
                    ),
                    HTML.row(
                      HTML.headerCell("Start Time"),
                      HTML.cell({
                        onClick: form.startTime
                          ? handleClickTimeDisplay({
                              name: "start",
                              value: form.startTime,
                            })
                          : () => undefined,
                        textContent: form.startTime,
                        children: form.startTime
                          ? []
                          : DateTimeInput({
                              name: "start",
                              value: form.startTime,
                            }),
                      })
                    ),
                    HTML.row(
                      HTML.headerCell("End Time"),
                      HTML.cell({
                        onClick: form.endTime
                          ? handleClickTimeDisplay({
                              name: "end",
                              value: form.endTime,
                            })
                          : () => undefined,
                        textContent: form.endTime,
                        children: form.endTime
                          ? []
                          : DateTimeInput({
                              name: "end",
                              value: form.endTime,
                            }),
                      })
                    ),
                  ],
                }),
                HTML.createElement("div", {
                  tabindex: 0,
                  onFocus: () => omnibox.focus(),
                }),
              ],
            }),
            HTML.createElement("section", {
              children: [
                HTML.createElement("h4", { textContent: "Students" }),
                HTML.table(
                  HTML.createElement("thead", {
                    class: "form formStudents",
                    children: [
                      HTML.row(
                        ...["Name", "NetID", "Signed In", "Signed Out"].map(
                          HTML.headerCell
                        )
                      ),
                    ],
                  }),
                  HTML.createElement("tbody", {
                    class: "studentList",
                    children: form.students.length
                      ? form.students.map(makeStudentRow)
                      : [HTML.row(HTML.cell("Scan ID to sign in a student"))],
                  })
                ),
              ],
            }),
            HTML.createElement("section", {
              children: [
                HTML.createElement("h4", {
                  textContent: "Equipment Checked Out",
                }),
                HTML.table(
                  HTML.createElement("thead", {
                    class: "form formItems",
                    children: [
                      HTML.row(
                        ...[
                          "Qty",
                          "Items",
                          "Item ID",
                          "Checked Out",
                          "Checked In",
                        ].map(HTML.headerCell)
                      ),
                    ],
                  }),
                  HTML.createElement("tbody", {
                    class: "itemList",
                    children: form.items.getLength()
                      ? form.items.map(makeItemRow) // slice.reverse?
                      : [
                          HTML.row(
                            HTML.cell("Scan barcode to check out an item")
                          ),
                        ],
                  })
                ),
              ],
            }),
          ],
        }),
      ],
      onKeydown: (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          submit();
        }
      },
    });

    function handleClickTimeDisplay({ name, value }) {
      return (_, timeDisplay) => {
        if (disabled) return;
        timeDisplay.textContent = "";
        DateTimeInput({
          name,
          value,
          onChange: handleChangeTime,
        }).forEach((el) => timeDisplay.parentNode.appendChild(el));
        timeDisplay.remove();
      };
    }

    function getUpdateButtonHint() {
      if (disabled) return "This is a closed form. You cannot edit it.";
      if (!savable)
        return "Please enter start time, end time, location, and at least one student";
      return "";
    }

    function handleChangeLocation(change) {
      if (change.target.value === "Other") {
        const input = HTML.createElement("input", { type: "text" });
        HTML.modal({
          children: [
            HTML.heading1("Location: Other"),
            HTML.paragraph(
              "Location must be on the 5th or 6th floor of 370 Jay Street."
            ),
            input,
          ],
          okText: "Set location",
          onOk: () =>
            handleChangeLocation({
              target: {
                name: "location",
                value: input.value || "none",
              },
            }),
          onClose: () =>
            handleChangeLocation({
              target: { name: "location", value: "none" },
            }),
        });
        input.focus();
        return;
      }
      onChange(change);
    }

    function handleChangeTime(change) {
      onChange(change);
    }

    function handleClickItem(item) {
      const radio = HTML.radio("itemOptions");
      const input = HTML.createElement("textarea");
      HTML.modal({
        children: [
          HTML.heading1("Add notes to item"),
          HTML.table(
            HTML.row(
              HTML.cell("Item cannot be found"),
              HTML.cell({ child: radio("missing") })
            ),
            HTML.row(
              HTML.cell("Other (please specifiy below"),
              HTML.cell({ child: radio("other") })
            )
          ),
          input,
        ],
        okText: "Add note",
        onOk: ({ modal }) => {
          const choice = HTML.getRadioValue(modal);
          let value = "";
          if (choice === "missing") {
            item.missing = true;
            value = `${item.description} marked as missing`;
          } else if (choice === "other") {
            item.notes = [item.notes, input.value].filter((s) => s).join(", ");
          }
          updateItems({
            target: {
              name: "items",
              value,
            },
          });
        },
      });
      input.focus();
    }

    function handleStudentNote(student) {
      const radio = HTML.radio("studentOptions");
      const input = HTML.createElement("textarea");
      HTML.modal({
        children: [
          HTML.heading1("Add notes to student"),
          HTML.table(
            HTML.row(
              HTML.cell("Student never showed up."),
              HTML.cell({ child: radio("no show") })
            ),
            HTML.row(
              HTML.cell("Student left without checking out."),
              HTML.cell({ child: radio("left") })
            ),
            HTML.row(
              HTML.cell("Other (please specify below)"),
              HTML.cell({ child: radio("other", true) })
            )
          ),
          input,
        ],
        okText: "Submit",
        onOk: ({ modal }) => {
          const choice = HTML.getRadioValue(modal);
          const textValue = input.value;

          if (choice === "left") {
            student.left = true;
            updateStudents({
              target: {
                name: "students",
                value: `${student.name} left without checking out`,
              },
            });
          } else if (choice === "no show") {
            onChange({
              target: {
                name: "students",
                value: `${student.name} did not show up`,
              },
            });
          } else if (choice === "other") {
            saveNote(`${student.name}: ${textValue}`);
          }
        },
      });
      input.focus();
    }

    function cancelAutosave() {
      if (autosaveID !== null) {
        window.clearTimeout(autosaveID);
        autosaveID = null;
      }
    }

    function makeAdvanceBooking() {
      // connections.getCurrentForm().makeAdvanceBooking();
      onChange({
        target: { name: "advanceBooking", value: "Make advance booking" },
      });
    }

    function parseDateAndTimeInputs() {
      let startTime = new Date(elements.form.startDate.value + "T00:00:00"),
        endTime = new Date(elements.form.endDate.value + "T00:00:00"),
        startHour = +elements.form.startHour.value,
        endHour = +elements.form.endHour.value,
        startMinute = +elements.form.startMinute.value,
        endMinute = +elements.form.endMinute.value;
      const ampmConverter = (ampm, hour) => {
        if (ampm == "PM" && hour != 12) {
          hour += 12;
        } else if (ampm == "AM" && hour == 12) {
          // i.e. 12 AM
          hour = 0;
        }
        return hour;
      };
      startHour = ampmConverter(elements.form.startAMPM.value, startHour);
      endHour = ampmConverter(elements.form.endAMPM.value, endHour);
      startTime.setHours(startHour);
      startTime.setMinutes(startMinute);
      endTime.setHours(endHour);
      endTime.setMinutes(endMinute);

      return { startTime, endTime };
    }

    function saveNote(body) {
      if (body.length < 1) {
        return;
      }
      const author = getUsername();
      form.notes.push({
        timestamp: Date.now(),
        author,
        body,
      });
      onChange({
        target: {
          name: "notes",
          value: body.length > 10 ? body.slice(0, 10) + "..." : body,
        },
      });
      elements.noteSection.appendChild(
        HTML.createElement("p", {
          textContent: `Note: [${author}] ${body}`,
        })
      );
      if (elements.noteSection.classList.contains("hidden")) {
        elements.noteSection.classList.remove("hidden");
      }
    }

    function makeQuantityButtons(item, isArchive) {
      if (isArchive || item.checkIn || item.isSerialized()) {
        return document.createTextNode(item.getQuantity());
      }
      return HTML.createElement("span", {
        children: [
          HTML.createElement("button", {
            class: "quantity",
            onClick: () => handlers.onModalQuantityChange(item),
            textContent: item.getQuantity(),
          }),
          HTML.createElement("button", {
            class: "quantity",
            onClick: () => {
              const quantity = item.getQuantity();
              item.changeQuantity(1);
              updateItems({
                target: {
                  name: "items",
                  value: `${item.description} qty ${quantity} to ${
                    quantity + 1
                  }`,
                },
              });
            },
            textContent: "+",
          }),
        ],
      });
    }

    function makeItemRow(item) {
      return HTML.createElement("tr", {
        class: item.isSerialized ? "serialized" : "nonserialized",
        children: [
          HTML.cell({ child: makeQuantityButtons(item, disabled) }),
          HTML.cell(item.description),
          HTML.cell(item.id),
          HTML.cell(
            item.checkOut
              ? item.checkOut
              : {
                  child: HTML.createElement("i", {
                    textContent: "Scan barcode to check out",
                  }),
                }
          ),
          HTML.cell({ child: makeCheckInButton(item, disabled) }),
        ],
        onClick: ({ metaKey, target }) => {
          if (target.tagName.toLowerCase() === "button") return;
          if (metaKey) alert("click item with meta key disabled");
          //handlers.onItemMetaClick(item.id || item.barcode);
          else handleClickItem(item);
        },
      });
      // elements.itemList.appendChild(
      //   HTML.createElement("tr", {
      //     child: HTML.createElement("td", {
      //       colspan: 4,
      //       class: "itemnotes",
      //       textContent: "Notes: " + item.notes,
      //     }),
      //   })
      // );
    }

    function makeCheckInButton(item, isArchive) {
      if (item.checkedOutAgain) {
        return document.createTextNode("");
      }
      if (item.missing) {
        return HTML.createElement("span", {
          class: "alert",
          textContent: "ITEM IS MISSING",
        });
      }
      if (isArchive || item.checkIn) {
        return document.createTextNode(item.checkIn);
      }
      if (!item.checkOut || !item.checkedOut) {
        return HTML.createElement("button", {
          class: "create",
          textContent: "Remove",
          onClick: () => {
            alert("item remove function disabled");
            // const form = connections.getCurrentForm();
            // form.items.removeByItem(item);
            // updateItems({
            //   target: {
            //     name: "items",
            //     value: item.description + " removed",
            //   },
            // });
          },
        });
      }
      if (!item.checkIn && item.isSerialized()) {
        return HTML.createElement("i", {
          textContent: "Scan barcode to return",
        });
      }
      const id = item.id || item.barcode;
      const checkInButton = HTML.createElement("button", {
        class: "action",
        textContent: "Check In",
        onClick: () => {
          alert("item check in fn disabled");
          // const savedItem = getSavedForm().items.find(
          //   (item) => (item.barcode || item.id) == id
          // );
          // if (!savedItem) {
          //   return window.alert(
          //     "This item was just checked-out. Update or revert the form to continue."
          //   );
          // }
          // const quantityToReturn =
          //   savedItem.getQuantity() > 1
          //     ? document.querySelector(`select[data-itemid="${id}"]`).value
          //     : undefined;
          // handlers.onItemQuantityChange(savedItem, quantityToReturn, false);
        },
      });
      const quantity = item.getQuantity();
      if (quantity > 1) {
        return HTML.createElement("span", {
          "data-id": item.id,
          "data-barcode": item.barcode,
          children: [
            checkInButton,
            HTML.createElement("select", {
              class: "selectQuantity",
              "data-itemid": id,
              children: [
                HTML.createElement("option", {
                  value: "all",
                  textContent: "All",
                }),
                ...Array.from({ length: quantity - 1 }).map((_, i) =>
                  HTML.createElement("option", {
                    textContent: String(i + 1),
                  })
                ),
              ],
            }),
          ],
        });
      }
      return checkInButton;
    }

    function makeStudentRow(student) {
      // isArchive === disabled
      return HTML.createElement("tr", {
        children: [
          HTML.cell(student.name),
          HTML.cell(student.netId),
          HTML.createElement("td", {
            child: student.checkIn
              ? document.createTextNode(student.checkIn)
              : disabled
              ? document.createTextNode("")
              : HTML.createElement("i", {
                  textContent: "Scan ID to sign in",
                }),
          }),
          HTML.createElement("td", {
            child: student.left
              ? HTML.createElement("span", {
                  class: "alert",
                  textContent: "DID NOT CHECK OUT",
                })
              : student.checkOut
              ? document.createTextNode(student.checkOut)
              : disabled || !student.checkIn
              ? document.createTextNode("")
              : HTML.createElement("i", {
                  textContent: "Scan ID to sign out",
                }),
          }),
        ],
        onClick: ({ metaKey, target }) => {
          if (target.tagName.toLowerCase() === "button") return;
          if (metaKey) return alert("click student with meta key disabled");
          //handlers.onStudentMetaClick(student.netId);
          else handleStudentNote(student);
        },
      });
    }

    function getUsername() {
      const el = document.querySelector("span.usernameDisplay");
      if (el) return el.textContent;
      return "anonymous";
    }

    function onChangeLog() {
      const changes = [
        ...form.notes.reduce((areChanges, note) => {
          const change = Utility.tryJsonParse(note.body);
          if (!Array.isArray(change)) return areChanges;
          change.forEach((entry) => (entry.author = note.author));
          return [...areChanges, ...change];
        }, []),
        ...Changes.getStack(),
      ];
      HTML.modal({
        children: [
          HTML.table(
            HTML.row(...["Time", "User", "Field", "Value"].map(HTML.cell))
          ),
          ...changes.map(({ timestamp, author, name, value }) =>
            HTML.row(
              HTML.cell(DateUtils.getFormattedDate(new Date(timestamp))),
              HTML.cell(author),
              HTML.cell(Utility.uncamelCase(name)),
              HTML.cell(value)
            )
          ),
        ],
      });
    }
    function locationSelect() {
      return HTML.select({
        name: "location",
        value: form.location,
        onChange: handleChangeLocation,
        children: [
          HTML.option("please select", "none"),
          ...Array.from(Config.locations).map((location) =>
            HTML.option(location)
          ),
          HTML.option("Other"),
        ],
      });
    }
  }
</script>
