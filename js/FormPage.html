<script>
  /* global Config DateUtils HTML Utility DateTimeInput ModalQuantityChange */
  /* exported FormPage */
  function FormPage({
    form,
    disabled = false,
    savable = false,
    formIndexDisplay = "",
    omnibox,
    onSubmit,
    onChange,
    onDelete,
  }) {
    const { copyToClipboard, nullIf, tryJsonParse, uncamelCase } = Utility;
    const { button, cell, createElement, modal, page, row, table } = HTML;
    // submodule to track form changes
    const Changes = (function () {
      let saved = true;
      let stack = [];
      return {
        add(change) {
          let newChange = {
            name: change.target.name,
            value: change.target.value,
            timestamp: Date.now(),
          };
          stack.push(newChange);
          saved = false;
        },
        clear() {
          stack = [];
          saved = true;
        },
        getStack() {
          return stack.slice();
        },
        isSaved() {
          return saved;
        },
        makeNote(author) {
          return {
            timestamp: Date.now(),
            author,
            body: JSON.stringify(this.stack),
          };
        },
      };
    })();

    return page({
      name: "form",
      children: [
        createElement("form", {
          class: "model",
          onSubmit: (e) => e.preventDefault(),
          children: [
            createElement("section", {
              class: "formControls",
              children: [
                createElement("div", {
                  tabindex: 0,
                  // onFocus: () => locationSelect.focus(),
                }),
                omnibox,
                button("ðŸ”Ž", {
                  class: "buttonSmall",
                  disabled,
                  tabindex: -1,
                  onClick: () => alert("parse input disabled"), //handlers.onParseInput(),
                }),
                button("Add item without barcode or ID", {
                  disabled,
                  tabindex: -1,
                  onClick: () => alert("manual entry disabled"), //handlers.onManualEntry(),
                }),
                button("New note", {
                  class: "action",
                  disabled,
                  tabindex: -1,
                  onClick: () => {
                    const input = createElement("textarea");
                    modal({
                      children: [
                        HTML.heading1("New note"),
                        HTML.paragraph("Enter a note"),
                        input,
                      ],
                      okText: "Save note",
                      onOk: () => saveNote(input.value),
                    });
                    input.focus();
                  },
                }),
                button("Change log", {
                  tabindex: -1,
                  onClick: onChangeLog,
                }),
                nullIf(
                  !disabled,
                  button("Copy items to clipboard", {
                    tabindex: -1,
                    onClick: () =>
                      copyToClipboard(JSON.stringify(form.items.getStripped())),
                  })
                ),
                nullIf(
                  disabled,
                  button("Delete this form", {
                    onClick: onDelete,
                  })
                ),
                HTML.br(),
                button("Previous form", {
                  tabindex: -1,
                  onClick: () => alert("get previous disabled"), //getPrevious,
                }),
                button("Next form", {
                  tabindex: -1,
                  onClick: () => alert("get next disabled"), //getNext,
                }),
                createElement("span", {
                  textContent: formIndexDisplay,
                }),
                HTML.br(),
                button("Submit", {
                  disabled: disabled || !savable,
                  class: "action buttonTight",
                  onClick: () => onSubmit(form),
                }),
                nullIf(
                  disabled || !form.isBlank(),
                  button("Save as advance booking", {
                    class: `action buttonTight`,
                    disabled: !savable,
                    tabindex: -1,
                    onClick: () => {
                      modal({
                        children: [
                          HTML.heading1("Save for later?"),
                          HTML.paragraph(
                            "All sign-in and check-out info will be removed. " +
                              "Add all people and items before saving. " +
                              "You can only do this once."
                          ),
                        ],
                        closeText: "Cancel",
                        okText: "Save as advance booking",
                        onOk: makeAdvanceBooking,
                      });
                    },
                  })
                ),
                button("Revert to saved form", {
                  disabled,
                  onClick: () =>
                    modal({
                      children: [
                        HTML.heading1("Undo all changes"),
                        HTML.paragraph(
                          "Do you want to undo all changes since the last save?"
                        ),
                      ],
                      okText: "Revert to saved form",
                      onOk: () => undefined,
                    }),
                }),
                createElement("span", {
                  class: "updateButtonHint",
                  textContent: getUpdateButtonHint(),
                }),
              ],
            }),
            createElement("section", {
              class: "globalnotes",
              children: form.notes.reduce((notes, note) => {
                if (tryJsonParse(note.body)) return notes;
                return [
                  ...notes,
                  createElement("p", {
                    textContent: `Note: [${note.author}] ${note.body}`,
                  }),
                ];
              }, []),
            }),
            createElement("section", {
              children: [
                createElement("table", {
                  class: "staticFields",
                  children: [
                    ...[
                      ["Booked Students", "bookedStudents"],
                      ["Contact", "contact"],
                      ["Project", "project"],
                      ["Analog Tape", "tape"],
                      ["Overnight Setup", "overnight"],
                    ].reduce(
                      (rows, [textContent, key]) =>
                        form[key]
                          ? [
                              ...rows,
                              createElement("tr", {
                                children: [
                                  HTML.headerCell(textContent),
                                  cell(form[key]),
                                ],
                              }),
                            ]
                          : rows,
                      []
                    ),
                    row(
                      HTML.headerCell("Location"),
                      cell({
                        textContent: form.location || "",
                        onClick: form.location
                          ? (_, locationDisplay) => {
                              if (disabled) return;
                              locationDisplay.parentNode.appendChild(
                                locationSelect()
                              );
                              locationDisplay.remove();
                            }
                          : () => undefined,
                        children: form.location ? [] : [locationSelect()],
                      })
                    ),
                    row(
                      HTML.headerCell("Start Time"),
                      cell({
                        onClick: form.startTime
                          ? handleClickTimeDisplay({
                              name: "start",
                              value: form.startTime,
                            })
                          : () => undefined,
                        textContent: form.startTime,
                        children: form.startTime
                          ? []
                          : DateTimeInput({
                              name: "start",
                              value: form.startTime,
                            }),
                      })
                    ),
                    row(
                      HTML.headerCell("End Time"),
                      cell({
                        onClick: form.endTime
                          ? handleClickTimeDisplay({
                              name: "end",
                              value: form.endTime,
                            })
                          : () => undefined,
                        textContent: form.endTime,
                        children: form.endTime
                          ? []
                          : DateTimeInput({
                              name: "end",
                              value: form.endTime,
                            }),
                      })
                    ),
                  ],
                }),
                createElement("div", {
                  tabindex: 0,
                  onFocus: () => omnibox.focus(),
                }),
              ],
            }),
            createElement("section", {
              children: [
                createElement("h4", { textContent: "Students" }),
                table(
                  createElement("thead", {
                    class: "form formStudents",
                    children: [
                      row(
                        ...["Name", "NetID", "Signed In", "Signed Out"].map(
                          HTML.headerCell
                        )
                      ),
                    ],
                  }),
                  createElement("tbody", {
                    class: "studentList",
                    children: form.students.length
                      ? form.students.map(makeStudentRow)
                      : [row(cell("Scan ID to sign in a student"))],
                  })
                ),
              ],
            }),
            createElement("section", {
              children: [
                createElement("h4", {
                  textContent: "Equipment Checked Out",
                }),
                table(
                  createElement("thead", {
                    class: "form formItems",
                    children: [
                      row(
                        ...[
                          "Qty",
                          "Items",
                          "Item ID",
                          "Checked Out",
                          "Checked In",
                        ].map(HTML.headerCell)
                      ),
                    ],
                  }),
                  createElement("tbody", {
                    class: "itemList",
                    children: form.items.length
                      ? form.items.map(makeItemRow) // slice.reverse?
                      : [row(cell("Scan barcode to check out an item"))],
                  })
                ),
              ],
            }),
          ],
        }),
      ],
      onKeydown: (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          onSubmit(form);
        }
      },
    });

    function handleClickTimeDisplay({ name, value }) {
      return (_, timeDisplay) => {
        if (disabled) return;
        timeDisplay.textContent = "";
        DateTimeInput({
          name,
          value,
          onChange: onChangeTime,
        }).forEach((el) => timeDisplay.parentNode.appendChild(el));
        timeDisplay.remove();
      };
    }

    function getUpdateButtonHint() {
      if (disabled) return "This is a closed form. You cannot edit it.";
      if (!savable)
        return "Please enter start time, end time, location, and at least one student";
      return "";
    }

    function handleChangeLocation(change) {
      if (change.target.value === "Other") {
        const input = createElement("input", { type: "text" });
        modal({
          children: [
            HTML.heading1("Location: Other"),
            HTML.paragraph(
              "Location must be on the 5th or 6th floor of 370 Jay Street."
            ),
            input,
          ],
          okText: "Set location",
          onOk: () =>
            handleChangeLocation({
              target: {
                name: "location",
                value: input.value || "none",
              },
            }),
          onClose: () =>
            handleChangeLocation({
              target: { name: "location", value: "none" },
            }),
        });
        input.focus();
        return;
      }
      onChange(change);
    }

    function handleClickItem(item) {
      const radio = HTML.radio("itemOptions");
      const input = createElement("textarea");
      modal({
        children: [
          HTML.heading1("Add notes to item"),
          table(
            row(
              cell("Item cannot be found"),
              cell({ child: radio("missing") })
            ),
            row(
              cell("Other (please specifiy below"),
              cell({ child: radio("other") })
            )
          ),
          input,
        ],
        okText: "Add note",
        onOk: ({ modal }) => {
          const choice = HTML.getRadioValue(modal);
          let value = "";
          if (choice === "missing") {
            item.missing = true;
            value = `${item.description} marked as missing`;
          } else if (choice === "other") {
            item.notes = [item.notes, input.value].filter((s) => s).join(", ");
          }
          onChange({
            target: {
              name: "items",
              value,
            },
          });
        },
      });
      input.focus();
    }

    function handleStudentNote(student) {
      const radio = HTML.radio("studentOptions");
      const input = createElement("textarea");
      modal({
        children: [
          HTML.heading1("Add notes to student"),
          table(
            row(
              cell("Student never showed up."),
              cell({ child: radio("no show") })
            ),
            row(
              cell("Student left without checking out."),
              cell({ child: radio("left") })
            ),
            row(
              cell("Other (please specify below)"),
              cell({ child: radio("other", true) })
            )
          ),
          input,
        ],
        okText: "Submit",
        onOk: ({ modal }) => {
          const choice = HTML.getRadioValue(modal);
          const textValue = input.value;

          if (choice === "left") {
            student.left = true;
            onChange({
              target: {
                name: "students",
                value: `${student.name} left without checking out`,
              },
            });
          } else if (choice === "no show") {
            onChange({
              target: {
                name: "students",
                value: `${student.name} did not show up`,
              },
            });
          } else if (choice === "other") {
            saveNote(`${student.name}: ${textValue}`);
          }
        },
      });
      input.focus();
    }

    function makeAdvanceBooking() {
      // connections.getCurrentForm().makeAdvanceBooking();
      onChange({
        target: { name: "advanceBooking", value: "Make advance booking" },
      });
    }

    function onChangeTime({ name, values }) {
      const { date, hour, minutes, ampm } = values;
      const value = `${date} ${hour}:${minutes} ${ampm}`;
      onChange({ target: { name, value } });
    }

    function saveNote(body) {
      if (body.length < 1) {
        return;
      }
      const author = getUsername();
      form.notes.push({
        timestamp: Date.now(),
        author,
        body,
      });
      onChange({
        target: {
          name: "notes",
          value: body.length > 10 ? body.slice(0, 10) + "..." : body,
        },
      });
    }

    function makeQuantityButtons(item, isArchive) {
      if (isArchive || item.checkIn || item.isSerialized()) {
        return document.createTextNode(item.getQuantity());
      }
      return createElement("span", {
        children: [
          button(String(item.getQuantity()), {
            class: "quantity",
            onClick: () =>
              ModalQuantityChange({
                item,
                onClick: (value) => {
                  item.changeQuantity(value); // TODO switch to immutable
                  onChange({
                    target: {
                      name: "items",
                      value: `${item.description} qty to ${value}`,
                    },
                  });
                },
              }),
          }),
          button("+", {
            class: "quantity",
            onClick: () => {
              const quantity = item.getQuantity();
              item.changeQuantity(1);
              onChange({
                target: {
                  name: "items",
                  value: `${item.description} qty ${quantity} to ${
                    quantity + 1
                  }`,
                },
              });
            },
          }),
        ],
      });
    }

    function makeItemRow(item) {
      return createElement("tr", {
        class: item.isSerialized ? "serialized" : "nonserialized",
        children: [
          cell({ child: makeQuantityButtons(item, disabled) }),
          cell(item.description),
          cell(item.id),
          cell(
            item.checkOut
              ? item.checkOut
              : {
                  child: createElement("i", {
                    textContent: "Scan barcode to check out",
                  }),
                }
          ),
          cell({ child: makeCheckInButton(item, disabled) }),
        ],
        onClick: ({ metaKey, target }) => {
          if (target.tagName.toLowerCase() === "button") return;
          if (metaKey) alert("click item with meta key disabled");
          //handlers.onItemMetaClick(item.id || item.barcode);
          else handleClickItem(item);
        },
      });
      // elements.itemList.appendChild(
      //   createElement("tr", {
      //     child: createElement("td", {
      //       colspan: 4,
      //       class: "itemnotes",
      //       textContent: "Notes: " + item.notes,
      //     }),
      //   })
      // );
    }

    function makeCheckInButton(item, isArchive) {
      if (item.checkedOutAgain) {
        return document.createTextNode("");
      }
      if (item.missing) {
        return createElement("span", {
          class: "alert",
          textContent: "ITEM IS MISSING",
        });
      }
      if (isArchive || item.checkIn) {
        return document.createTextNode(item.checkIn);
      }
      if (!item.checkOut || !item.checkedOut) {
        return createElement("button", {
          class: "create",
          textContent: "Remove",
          onClick: () => {
            alert("item remove function disabled");
            // const form = connections.getCurrentForm();
            // form.items.removeByItem(item);
            // onChange({
            //   target: {
            //     name: "items",
            //     value: item.description + " removed",
            //   },
            // });
          },
        });
      }
      if (!item.checkIn && item.isSerialized()) {
        return createElement("i", {
          textContent: "Scan barcode to return",
        });
      }
      const id = item.id || item.barcode;
      const checkInButton = createElement("button", {
        class: "action",
        textContent: "Check In",
        onClick: () => {
          alert("item check in fn disabled");
          // const savedItem = getSavedForm().items.find(
          //   (item) => (item.barcode || item.id) == id
          // );
          // if (!savedItem) {
          //   return window.alert(
          //     "This item was just checked-out. Update or revert the form to continue."
          //   );
          // }
          // const quantityToReturn =
          //   savedItem.getQuantity() > 1
          //     ? document.querySelector(`select[data-itemid="${id}"]`).value
          //     : undefined;
          // handlers.onItemQuantityChange(savedItem, quantityToReturn, false);
        },
      });
      const quantity = item.getQuantity();
      if (quantity > 1) {
        return createElement("span", {
          "data-id": item.id,
          "data-barcode": item.barcode,
          children: [
            checkInButton,
            createElement("select", {
              class: "selectQuantity",
              "data-itemid": id,
              children: [
                createElement("option", {
                  value: "all",
                  textContent: "All",
                }),
                ...Array.from({ length: quantity - 1 }).map((_, i) =>
                  createElement("option", {
                    textContent: String(i + 1),
                  })
                ),
              ],
            }),
          ],
        });
      }
      return checkInButton;
    }

    function makeStudentRow(student) {
      // isArchive === disabled
      return createElement("tr", {
        children: [
          cell(student.name),
          cell(student.netId),
          createElement("td", {
            child: student.checkIn
              ? document.createTextNode(student.checkIn)
              : disabled
              ? document.createTextNode("")
              : createElement("i", {
                  textContent: "Scan ID to sign in",
                }),
          }),
          createElement("td", {
            child: student.left
              ? createElement("span", {
                  class: "alert",
                  textContent: "DID NOT CHECK OUT",
                })
              : student.checkOut
              ? document.createTextNode(student.checkOut)
              : disabled || !student.checkIn
              ? document.createTextNode("")
              : createElement("i", {
                  textContent: "Scan ID to sign out",
                }),
          }),
        ],
        onClick: ({ metaKey, target }) => {
          if (target.tagName.toLowerCase() === "button") return;
          if (metaKey) return alert("click student with meta key disabled");
          //handlers.onStudentMetaClick(student.netId);
          else handleStudentNote(student);
        },
      });
    }

    function getUsername() {
      const el = document.querySelector("span.usernameDisplay");
      if (el) return el.textContent;
      return "anonymous";
    }

    function onChangeLog() {
      const changes = [
        ...form.notes.reduce((areChanges, note) => {
          const change = tryJsonParse(note.body);
          if (!Array.isArray(change)) return areChanges;
          change.forEach((entry) => (entry.author = note.author));
          return [...areChanges, ...change];
        }, []),
        ...Changes.getStack(),
      ];
      modal({
        children: [
          table(row(...["Time", "User", "Field", "Value"].map(cell))),
          ...changes.map(({ timestamp, author, name, value }) =>
            row(
              cell(DateUtils.getFormattedDate(new Date(timestamp))),
              cell(author),
              cell(uncamelCase(name)),
              cell(value)
            )
          ),
        ],
      });
    }
    function locationSelect() {
      return HTML.select({
        name: "location",
        value: form.location,
        onChange: handleChangeLocation,
        children: [
          HTML.option("please select", "none"),
          ...Array.from(Config.locations).map((location) =>
            HTML.option(location)
          ),
          HTML.option("Other"),
        ],
      });
    }
  }
</script>
