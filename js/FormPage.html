<script>
  "use strict";
  /* global
  Config
  DateTimeInput
  DateUtils
  Form
  HTML
  Item
  ModalQuantityChange
  Omnibox
  Utility
  */
  /* exported FormPage */
  function FormPage({
    disabled = false,
    form,
    formIndexDisplay = "",
    onChange,
    inventory,
    onDelete,
    onRedo,
    onSubmit,
    onUndo,
    roster,
    savable = false,
    saved,
    username = "anonymous",
  }) {
    const {
      br,
      button,
      cell,
      createElement,
      getRadioValue,
      headerCell,
      heading1,
      modal,
      option,
      page,
      paragraph,
      radio,
      row,
      select,
      table,
    } = HTML;
    const { copyToClipboard, nullIf, tryJsonParse, uncamelCase } = Utility;
    const { getFormattedDate } = DateUtils;

    const omnibox = Omnibox({
      form,
      inventory,
      onSubmit: (obj) => console.log({ omnibox: obj }),
      roster,
    });

    return page({
      name: "form",
      children: [
        createElement("form", {
          class: "model",
          onSubmit: (e) => e.preventDefault(),
          children: [
            createElement("section", {
              class: "formControls",
              children: [
                createElement("div", {
                  tabindex: 0,
                  // onFocus: () => locationSelect.focus(),
                }),
                omnibox,
                button("ðŸ”Ž", {
                  class: "buttonSmall",
                  disabled,
                  tabindex: -1,
                  onClick: () => alert("parse input disabled"), //handlers.onParseInput(),
                }),
                button("Add item without barcode or ID", {
                  disabled,
                  tabindex: -1,
                  onClick: () => alert("manual entry disabled"), //handlers.onManualEntry(),
                }),
                button("New note", {
                  class: "action",
                  disabled,
                  tabindex: -1,
                  onClick: () => {
                    const input = createElement("textarea");
                    modal({
                      children: [
                        heading1("New note"),
                        paragraph("Enter a note"),
                        input,
                      ],
                      okText: "Save note",
                      onOk: () => saveNote(input.value),
                    });
                    input.focus();
                  },
                }),
                button("Change log", {
                  tabindex: -1,
                  onClick: onChangeLog,
                }),
                nullIf(
                  !disabled,
                  button("Copy items to clipboard", {
                    tabindex: -1,
                    onClick: () =>
                      copyToClipboard(JSON.stringify(form.items.getStripped())),
                  })
                ),
                nullIf(
                  disabled,
                  button("Delete this form", {
                    onClick: onDelete,
                  })
                ),
                br(),
                button("Previous form", {
                  tabindex: -1,
                  onClick: () => alert("get previous disabled"), //getPrevious,
                }),
                button("Next form", {
                  tabindex: -1,
                  onClick: () => alert("get next disabled"), //getNext,
                }),
                createElement("span", {
                  textContent: formIndexDisplay,
                }),
                br(),
                button("Submit", {
                  disabled: disabled || !savable,
                  class: `action buttonTight${savable ? " create" : ""}`,
                  onClick: () => onSubmit(form),
                }),
                nullIf(
                  disabled || !form.isBlank(),
                  button("Save as advance booking", {
                    class: `action buttonTight`,
                    disabled: !savable,
                    tabindex: -1,
                    onClick: () => {
                      modal({
                        children: [
                          heading1("Save for later?"),
                          paragraph(
                            "All sign-in and check-out info will be removed. " +
                              "Add all people and items before saving. " +
                              "You can only do this once."
                          ),
                        ],
                        closeText: "Cancel",
                        okText: "Save as advance booking",
                        onOk: makeAdvanceBooking,
                      });
                    },
                  })
                ),
                button("Undo", {
                  disabled,
                  onClick: onUndo,
                }),
                button("Redo", {
                  disabled,
                  onClick: onRedo,
                }),
                createElement("span", {
                  class: "updateButtonHint",
                  textContent: getUpdateButtonHint(),
                }),
              ],
            }),
            createElement("section", {
              class: "globalnotes",
              children: form.notes.reduce((notes, note) => {
                if (tryJsonParse(note.body)) return notes;
                return [
                  ...notes,
                  createElement("p", {
                    textContent: `Note: [${note.author}] ${note.body}`,
                  }),
                ];
              }, []),
            }),
            createElement("section", {
              children: [
                createElement("table", {
                  class: "staticFields",
                  children: [
                    ...[
                      ["Booked Students", "bookedStudents"],
                      ["Contact", "contact"],
                      ["Project", "project"],
                      ["Analog Tape", "tape"],
                      ["Overnight Setup", "overnight"],
                    ].reduce(
                      (rows, [textContent, key]) =>
                        form[key]
                          ? [
                              ...rows,
                              createElement("tr", {
                                children: [
                                  headerCell(textContent),
                                  cell(form[key]),
                                ],
                              }),
                            ]
                          : rows,
                      []
                    ),
                    row(
                      headerCell("Location"),
                      saved && form.location
                        ? cell({
                            textContent: form.location,
                            onClick: (_, locationDisplay) => {
                              if (disabled) return;
                              locationDisplay.parentNode.appendChild(
                                LocationSelect()
                              );
                              locationDisplay.remove();
                            },
                          })
                        : cell({
                            child: LocationSelect(),
                          })
                    ),
                    row(
                      headerCell("Start Time"),
                      saved && form.startTime
                        ? cell({
                            onClick: handleClickTimeDisplay({
                              name: "start",
                              value: form.startTime,
                            }),
                            textContent: form.startTime,
                          })
                        : cell({
                            children: DateTimeInput({
                              name: "start",
                              value: form.startTime,
                              onChange: onChangeTime,
                            }),
                          })
                    ),
                    row(
                      headerCell("End Time"),
                      saved && form.endTime
                        ? cell({
                            onClick: handleClickTimeDisplay({
                              name: "end",
                              value: form.endTime,
                            }),
                            textContent: form.endTime,
                          })
                        : cell({
                            children: DateTimeInput({
                              name: "end",
                              value: form.endTime,
                              onChange: onChangeTime,
                            }),
                          })
                    ),
                  ],
                }),
                createElement("div", {
                  tabindex: 0,
                  onFocus: () => omnibox.focus(),
                }),
              ],
            }),
            createElement("section", {
              children: [
                createElement("h4", { textContent: "Students" }),
                table(
                  createElement("thead", {
                    class: "form formStudents",
                    children: [
                      row(
                        ...["Name", "NetID", "Signed In", "Signed Out"].map(
                          headerCell
                        )
                      ),
                    ],
                  }),
                  createElement("tbody", {
                    class: "studentList",
                    children: form.students.length
                      ? form.students.map(StudentRow)
                      : [row(cell("Scan ID to sign in a student"))],
                  })
                ),
              ],
            }),
            createElement("section", {
              children: [
                createElement("h4", {
                  textContent: "Equipment Checked Out",
                }),
                table(
                  createElement("thead", {
                    class: "form formItems",
                    children: [
                      row(
                        ...[
                          "Qty",
                          "Items",
                          "Item ID",
                          "Checked Out",
                          "Checked In",
                        ].map(headerCell)
                      ),
                    ],
                  }),
                  createElement("tbody", {
                    class: "itemList",
                    children: form.items.length
                      ? form.items.map(ItemRow) // slice.reverse?
                      : [row(cell("Scan barcode to check out an item"))],
                  })
                ),
              ],
            }),
          ],
        }),
      ],
      onKeydown: (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          event.preventDefault();
          onSubmit(form);
        }
      },
    });

    function handleClickTimeDisplay({ name, value }) {
      return (_, timeDisplay) => {
        if (disabled) return;
        timeDisplay.textContent = "";
        DateTimeInput({
          name,
          value,
          onChange: onChangeTime,
        }).forEach((el) => timeDisplay.parentNode.appendChild(el));
        timeDisplay.remove();
      };
    }

    function getUpdateButtonHint() {
      if (disabled) return "This is a closed form. You cannot edit it.";
      if (!savable)
        return "Please enter start time, end time, location, and at least one student";
      return "";
    }

    function handleChangeLocation(change) {
      if (change.target.value === "Other") {
        const input = createElement("input", { type: "text" });
        modal({
          children: [
            heading1("Location: Other"),
            paragraph(
              "Location must be on the 5th or 6th floor of 370 Jay Street."
            ),
            input,
          ],
          okText: "Set location",
          onOk: () =>
            handleChangeLocation({
              target: {
                name: "location",
                value: input.value || "none",
              },
            }),
          onClose: () =>
            handleChangeLocation({
              target: { name: "location", value: "none" },
            }),
        });
        input.focus();
        return;
      }
      onChange({
        form: new Form({ ...form, location: change.target.value }),
        change,
      });
    }

    function handleClickItem(item) {
      const optionRadio = radio("itemOptions");
      const input = createElement("textarea");
      modal({
        children: [
          heading1("Add notes to item"),
          table(
            row(
              cell("Item cannot be found"),
              cell({ child: optionRadio("missing") })
            ),
            row(
              cell("Other (please specifiy below"),
              cell({ child: optionRadio("other") })
            )
          ),
          input,
        ],
        okText: "Add note",
        onOk: ({ modal }) => {
          const choice = getRadioValue(modal);
          let value = "";
          if (choice === "missing") {
            item.missing = true;
            value = `${item.description} marked as missing`;
          } else if (choice === "other") {
            item.notes = [item.notes, input.value].filter((s) => s).join(", ");
          }
          onChange({
            form,
            change: {
              target: {
                name: "items",
                value,
              },
            },
          });
        },
      });
      input.focus();
    }

    function handleStudentNote(student) {
      const optionRadio = radio("studentOptions");
      const input = createElement("textarea");
      modal({
        children: [
          heading1("Add notes to student"),
          table(
            row(
              cell("Student never showed up."),
              cell({ child: optionRadio("no show") })
            ),
            row(
              cell("Student left without checking out."),
              cell({ child: optionRadio("left") })
            ),
            row(
              cell("Other (please specify below)"),
              cell({ child: optionRadio("other", true) })
            )
          ),
          input,
        ],
        okText: "Submit",
        onOk: ({ modal }) => {
          const choice = getRadioValue(modal);
          const textValue = input.value;

          if (choice === "left") {
            student.left = true;
            onChange({
              form,
              change: {
                target: {
                  name: "students",
                  value: `${student.name} left without checking out`,
                },
              },
            });
          } else if (choice === "no show") {
            onChange({
              form,
              change: {
                target: {
                  name: "students",
                  value: `${student.name} did not show up`,
                },
              },
            });
          } else if (choice === "other") {
            saveNote(`${student.name}: ${textValue}`);
          }
        },
      });
      input.focus();
    }

    function makeAdvanceBooking() {
      // connections.getCurrentForm().makeAdvanceBooking();
      onChange({
        target: { name: "advanceBooking", value: "Make advance booking" },
      });
    }

    function onChangeTime({ name, values }) {
      const { date, hour, minutes, ampm } = values;
      const [year, month, day] = date.split("-");
      const value = `${month}/${day}/${year} ${hour}:${String(minutes).padStart(
        "0",
        2
      )} ${ampm}`;
      onChange({
        form: new Form({
          ...form,
          [`${name}Time`]: value,
        }),
        change: { target: { name, value } },
      });
    }

    function saveNote(body) {
      if (body.length < 1) {
        return;
      }
      const author = username;
      form.notes.push({
        timestamp: Date.now(),
        author,
        body,
      });
      onChange({
        target: {
          name: "notes",
          value: body.length > 10 ? body.slice(0, 10) + "..." : body,
        },
      });
    }

    function QuantityButtons(item, isArchive) {
      if (isArchive || item.checkIn || item.isSerialized()) {
        return document.createTextNode(item.quantity);
      }
      return createElement("span", {
        children: [
          button(String(item.quantity), {
            class: "quantity",
            onClick: () =>
              ModalQuantityChange({
                item,
                onClick: (value) => {
                  alert("TODO: need to replace old item with new"); //item.changeQuantity(value);
                  onChange({
                    target: {
                      name: "items",
                      value: `${item.description} qty to ${value}`,
                    },
                  });
                },
              }),
          }),
          button("+", {
            class: "quantity",
            onClick: () => {
              const quantity = item.quantity;
              alert("TODO: need to update quantity immutably"); //item.changeQuantity(1);
              onChange({
                target: {
                  name: "items",
                  value: `${item.description} qty ${quantity} to ${
                    quantity + 1
                  }`,
                },
              });
            },
          }),
        ],
      });
    }

    function ItemRow(item) {
      return createElement("tr", {
        class: item.isSerialized ? "serialized" : "nonserialized",
        children: [
          cell({ child: QuantityButtons(item, disabled) }),
          cell(item.description),
          cell(item.id),
          cell(
            item.checkOut
              ? item.checkOut
              : {
                  child: createElement("i", {
                    textContent: "Scan barcode to check out",
                  }),
                }
          ),
          cell({ child: CheckInButton(item, disabled) }),
        ],
        onClick: ({ metaKey, target }) => {
          if (target.tagName.toLowerCase() === "button") return;
          if (metaKey) alert("click item with meta key disabled");
          //handlers.onItemMetaClick(item.id || item.barcode);
          else handleClickItem(item);
        },
      });
      // elements.itemList.appendChild(
      //   createElement("tr", {
      //     child: createElement("td", {
      //       colspan: 4,
      //       class: "itemnotes",
      //       textContent: "Notes: " + item.notes,
      //     }),
      //   })
      // );
    }

    function CheckInButton(item, isArchive) {
      if (item.checkedOutAgain) {
        return document.createTextNode("");
      }
      if (item.missing) {
        return createElement("span", {
          class: "alert",
          textContent: "ITEM IS MISSING",
        });
      }
      if (isArchive || item.checkIn) {
        return document.createTextNode(item.checkIn);
      }
      if (!item.checkOut || !item.checkedOut) {
        return createElement("button", {
          class: "create",
          textContent: "Remove",
          onClick: () => {
            alert("item remove function disabled");
            // const form = connections.getCurrentForm();
            // form.items.removeByItem(item);
            // onChange({
            //   target: {
            //     name: "items",
            //     value: item.description + " removed",
            //   },
            // });
          },
        });
      }
      if (!item.checkIn && item.isSerialized()) {
        return createElement("i", {
          textContent: "Scan barcode to return",
        });
      }
      const id = item.id || item.barcode;
      const checkInButton = createElement("button", {
        class: "action",
        textContent: "Check In",
        onClick: () => {
          alert("item check in fn disabled");
          // const savedItem = getSavedForm().items.find(
          //   (item) => (item.barcode || item.id) == id
          // );
          // if (!savedItem) {
          //   return window.alert(
          //     "This item was just checked-out. Update or revert the form to continue."
          //   );
          // }
          // const quantityToReturn =
          //   savedItem.getQuantity() > 1
          //     ? document.querySelector(`select[data-itemid="${id}"]`).value
          //     : undefined;
          // handlers.onItemQuantityChange(savedItem, quantityToReturn, false);
        },
      });
      const quantity = item.quantity;
      if (quantity > 1) {
        return createElement("span", {
          "data-id": item.id,
          "data-barcode": item.barcode,
          children: [
            checkInButton,
            createElement("select", {
              class: "selectQuantity",
              "data-itemid": id,
              children: [
                createElement("option", {
                  value: "all",
                  textContent: "All",
                }),
                ...Array.from({ length: quantity - 1 }).map((_, i) =>
                  createElement("option", {
                    textContent: String(i + 1),
                  })
                ),
              ],
            }),
          ],
        });
      }
      return checkInButton;
    }

    function StudentRow(student) {
      // isArchive === disabled
      return createElement("tr", {
        children: [
          cell(student.name),
          cell(student.netId),
          createElement("td", {
            child: student.checkIn
              ? document.createTextNode(student.checkIn)
              : disabled
              ? document.createTextNode("")
              : createElement("i", {
                  textContent: "Scan ID to sign in",
                }),
          }),
          createElement("td", {
            child: student.left
              ? createElement("span", {
                  class: "alert",
                  textContent: "DID NOT CHECK OUT",
                })
              : student.checkOut
              ? document.createTextNode(student.checkOut)
              : disabled || !student.checkIn
              ? document.createTextNode("")
              : createElement("i", {
                  textContent: "Scan ID to sign out",
                }),
          }),
        ],
        onClick: ({ metaKey, target }) => {
          if (target.tagName.toLowerCase() === "button") return;
          if (metaKey) return alert("click student with meta key disabled");
          //handlers.onStudentMetaClick(student.netId);
          else handleStudentNote(student);
        },
      });
    }

    function onChangeLog() {
      const changes = [
        ...form.notes.reduce((areChanges, note) => {
          const change = tryJsonParse(note.body);
          if (!Array.isArray(change)) return areChanges;
          change.forEach((entry) => {
            entry.author = note.author;
            if (!entry.timestamp) entry.timestamp = note.timestamp;
          });
          return [...areChanges, ...change];
        }, []),
      ];
      modal({
        children: [
          table(row(...["Time", "User", "Field", "Value"].map(cell))),
          ...changes.map(({ timestamp, author, name, value }) =>
            row(
              cell(DateUtils.getFormattedDateTime(new Date(timestamp))),
              cell(author),
              cell(uncamelCase(name)),
              cell(value)
            )
          ),
        ],
      });
    }

    function LocationSelect() {
      return select({
        name: "location",
        value: form.location,
        onChange: handleChangeLocation,
        children: [
          option("please select", "none"),
          ...Array.from(Config.locations).map((location) => option(location)),
          option("Other"),
        ],
      });
    }

    function handleItem(item) {
      const currentItem = form.items.find(
        ({ barcode, id }) =>
          (item.id && id === item.id) ||
          (item.barcode && barcode === item.barcode)
      );
      const change = {
        // fake change event
        target: {
          name: "items",
          value:
            item.id && !/^manual/i.test(item.id) ? item.id : item.description,
        },
      };

      if (!currentItem) {
        return new Form({
          ...form,
          items: [
            ...form.items,
            new Item({ ...item, checkOut: getFormattedDate(new Date()) }),
          ],
        });
      }
      if (currentItem.checkOut && currentItem.checkIn) {
        // checking out again
        return new Form({
          ...form,
          items: [
            ...form.items,
            new Item({ ...item, checkOut: getFormattedDate(new Date()) }),
          ],
        });
      } else if (currentItem.checkOut) {
        // checking in OR scanning additional items
        const quantityInput = createElement("input", { type: "text" });
        if (!item.isSerialized()) {
          return modal({
            onOk: () =>
              console.log(
                "TBD: updating method",
                new Form({
                  ...form,
                  items: form.items.map((i) =>
                    i === currentItem
                      ? new Item({
                          ...currentItem,
                          quantity: quantityInput.value,
                        })
                      : currentItem
                  ),
                })
              ),
          });
        }
        return new Form({
          ...form,
          items: [
            ...form.items,
            new Item({
              ...item,
              checkIn: getFormattedDate(new Date()),
              missing: false,
            }),
          ],
        });
      } else {
        // Its a check-out for reserved gear
        return new Form({
          ...form,
          items: form.items.map((i) =>
            i === currentItem
              ? new Item({
                  ...currentItem,
                  checkOut: getFormattedDate(new Date()),
                })
              : currentItem
          ),
        });
      }
    }
  }
</script>
