<script>
  /* global
    HTML
    Item
    Inventory
    DateUtils
    Utility
   */
  /* exported Omnibox */
  function Omnibox({ disabled, form, inventory, onSubmit, roster }) {
    const {
      button,
      cell,
      createElement,
      heading1,
      modal,
      paragraph,
      row,
    } = HTML;
    const { tryJsonParse } = Utility;
    const { getByBarcode, getById } = Inventory;
    const { getFormattedDateTime } = DateUtils;
    const input = createElement("input", {
      type: "text",
      class: "omnibox",
      placeholder: "Scan barcode or type NetID/ItemID",
      onKeydown: (event, el) => {
        const { metaKey, ctrlKey, key } = event;
        if (!metaKey && !ctrlKey && key === "Enter") {
          event.preventDefault();
          onOmniboxSubmit();
        } else if (key === "Escape") el.blur();
      },
    });

    return createElement("span", {
      children: [
        input,
        button("ðŸ”Ž", {
          class: "buttonSmall",
          disabled,
          tabindex: -1,
          onClick: () => onOmniboxSubmit(),
        }),
      ],
    });

    function onOmniboxSubmit() {
      const { type, value, error } = parse(input);
      if (error)
        return modal({
          children: [heading1("Error"), paragraph(error.message)],
        });
      onSubmit({ type, value });
    }

    /**
     * creates a dialog to determine if the user meant to check in an item
     * or check out more of the same item
     */
    function getItemAction(item) {
      modal({
        children: [
          HTML.heading1("Check in or out?"),
          HTML.table(
            row(
              cell("Check the item back in?"),
              cell({
                child: createElement("button", {
                  textContent: "Check In",
                  onClick: () => handleItem(item, "all", false),
                }),
              })
            ),
            row(
              cell("Check out more of these?"),
              cell({
                child: createElement("button", {
                  textContent: "Check Out",
                  onClick: makeQuantityChangeDialog(item),
                }),
              })
            )
          ),
        ],
      });
    }

    function makeQuantityHandler(item, newQuantityInput) {
      return () => {
        const quantity = +newQuantityInput.value;
        const savedItem = form.items.find(
          ({ description }) => description === item.description
        );
        if (!item.checkedOutAgain && savedItem) {
          const savedQuantity = savedItem.getQuantity();
          if (quantity < savedQuantity) {
            window.alert(
              quantity +
                " is less than the previous quantity " +
                savedQuantity +
                ". You can only enter a larger amount " +
                "or check in this item."
            );
            return;
          }
        }
        try {
          item.setQuantity(quantity);
        } catch (error) {
          window.alert(error);
          return;
        }
        handlers.onItemChange({
          target: {
            name: "items",
            value: `${item.description} qty ${item.quantity} to ${quantity}`,
          },
        });
      };
    }

    /**
     * parse examines the current value of the omnibox text input element
     * and returns an object that should always be checked for an error key.
     * {
     *   type?: "itemArray" |
     *               "item" |
     *            "student" |
     *         "newCodabar" | // codabar detected but not found in roster
     *        "manualEntry" | // magic number for manual item entry detected
     *              "query" |, // no exact match; search through roster & inventory
     *   value?: Item[] | Item | Student | string,
     *   error?: Error,
     * }
     */
    function parse(element) {
      if (!element.value)
        return { error: new Error("Enter a barcode, NetID, or item ID") };

      // see the "Copy items to clipboard" button
      if (/^\s*\[\s*{\s*"/.test(element.value)) {
        // JSON array of objects: "[{}]"
        const items = tryJsonParse(element.value);
        if (!items || !Array.isArray(items))
          return {
            type: "itemArray",
            error: new Error(
              "Input appears to be JSON but I couldn't parse it."
            ),
          };
        return { type: "itemArray", value: items };
      }

      const value = element.value.toLowerCase(); // case insensitive input
      const codabarRegex = /^[a-d][0-9]{5,}[a-d]$/; // "a123...789b" pattern
      if (codabarRegex.test(value)) {
        // Check student id
        const foundStudent = roster.find(({ id }) => id.toLowerCase() == value);
        if (foundStudent) {
          return { type: "student", value: foundStudent };
        }
        return { type: "newCodabar", value };
      }

      const idType = /^[a-z]+[0-9]+/.test(value) ? "netId" : "name"; // Check student name and id
      const foundStudent = roster.find(
        (student) => student[idType].toLowerCase() === value
      );
      if (foundStudent) {
        return { type: "student", value: foundStudent };
      }

      // two special cases: magic number for manual entry and generated "manual" IDs
      if (value === "10000") {
        return { type: "manualEntry" };
      }
      if (/^manual/.test(value))
        return {
          type: "item",
          value: new Item(
            form.items.find(
              ({ id }) => id.toLowerCase().replace(/-0+/, "-") === value
            )
          ),
        };

      const foundItem =
        getById(inventory, value) || getByBarcode(inventory, value);
      if (foundItem) return { type: "item", value: foundItem };

      return { type: "query", value };
    }
  }
</script>
