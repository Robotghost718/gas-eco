<script>
/* global Item */
/* exported Inventory */
/**
 * Inventory wraps an array with specialized functions
 */
function Inventory(array) {
  let items = [];
  this.setItems = function(array) {
    if (! Array.isArray(array)) {
      throw new Error(`${array} (${typeof array}) is not an array`);
    }
    items = array;
    if (! (items[0] instanceof Item)) {
      items.forEach(function (obj, index, array) {
        array[index] = new Item(obj);
      });
    }
  };
  if (array) {
    this.setItems(array.slice());
  }

  // getLength exposes the array length
  this.getLength = function() { return items.length; };

  // this section exposes array functions
  this.every = function(func) {
    items.every(func);
  };
  this.forEach = function(func) {
    items.forEach(func);
  };
  /**
   * @returns Item[] - NOT Inventory!
   */
  this.filter = function(func) {
    return items.filter(func);
  };
  this.find = function(func) {
    return items.find(func);
  };
  this.push = function(item) {
    items.push(item);
  };
  /**
   * non-mutating wrapper for reverse
   * returns a copy (slice) of the private variable
   */
  this.reverse = function() {
    return items.slice().reverse();
  };
  /**
   * TODO confirm we want to return Item[] and not new Inventory!
   *      users may expect to get a copy of an Inventory, not a downgraded array
   */
  this.slice = function() {
    return items.slice();
  };
  this.some = function(func) {
    return items.some(func);
  };
  
  // this section has custom methods for the Inventory array
  this.contains = function(query) {
    query = query.replace(/\s/g, '').replace(/-0+/, '-');
    return items.find(item => {
      const id = item.id.replace(/\s/g, '').replace(/-0+/, '-');
      return query === id || item.description.toUpperCase().includes(query);
    });
  };
  this.getByBarcode = function(barcode) {
    return items.find(item => {
      if (! item.barcode) {
        return false;
      }
      return item.barcode.toLowerCase() == barcode;
    });
  };
  this.getById = function(id) {
    id = id.toLowerCase().replace(/-0+/, '-');
    return items.find(item => {
      if (! item.id) {
        return false;
      }
      return item.id.toLowerCase().replace(/-0+/, '-') === id;
    });
  };
  this.getByItem = function(item) {
    return items.find(i => {
      if (i.id && i.id == item.id) {
        return true;
      }
      if (i.barcode && i.barcode == item.barcode) {
        return true;
      }
      return false;
    });
  };
  this.getStripped = function() {
    const copy = [];
    items.forEach(item => {
      copy.push({
        id: item.id,
        description: item.description,
        quantity: item.getQuantity(),
        barcode: item.barcode
      });
    });
    return copy;
  };
  this.archive = function() {
    const copy = [];
    items.forEach(item => copy.push(item.archive()));
    return copy;
  };
}
</script>
