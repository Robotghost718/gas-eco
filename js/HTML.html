<script>
  /* global Utility */
  /* exported HTML */
  const HTML = (function () {
    return {
      attributes,
      br,
      button,
      cell,
      createElement,
      dateTimeInputs,
      documentIcon,
      empty,
      getFirstChild,
      getNextSibling,
      getRadioValue,
      headerCell,
      heading1,
      labeledCheckbox,
      labeledDateInput,
      labeledInput,
      labeledRadio,
      modal,
      page,
      paragraph,
      option,
      radio,
      row,
      spinner,
      table,
      tableBody,
      tableHead,
      toast,
    };

    function attributes(el, attrs) {
      for (const key in attrs) {
        if (key === "class") el.classList.add(...attrs[key].split(/\s+/));
        else if (key === "removeClass") el.classList.remove(attrs[key]);
        else if (key === "child") el.appendChild(attrs[key]);
        else if (key === "children")
          attrs[key].forEach((child) => el.appendChild(child));
        else if (key === "innerHTML") el.innerHTML = attrs[key];
        else if (key === "textContent") el.textContent = attrs[key];
        else if (/^on[A-Z]/.test(key))
          // onClick, onKeydown, etc
          attrs[key] &&
            el.addEventListener(
              key.replace(/^on([A-Z])/, (_, c) => c.toLowerCase()),
              attrs[key]
            );
        else if (["selected", "checked"].includes(key)) {
          // only create attribute if true
          attrs[key] && el.setAttribute(key, attrs[key]);
        } else el.setAttribute(key, attrs[key]);
      }
      return el;
    }

    function br() {
      return createElement("br");
    }

    function createElement(name, attrs) {
      return attributes(document.createElement(name), attrs);
    }

    function documentIcon() {
      return createElement("img", {
        src:
          "data:image/png;base64," +
          "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABCElEQVR4XmNgoCbQ0tJiU5S" +
          "Vb1aUl2+BYSU5hU5FWUU3dLVYgYKCgoCCnPxROTk5LSDbAITl5eUVFeXkPyjKyYWiq8cAIA" +
          "OU5OXXo4sDDfgFxJ+U5OSc0eVQAMgARTmFVUCFPgpycnlKsvJFKioqfEDN/6H4L1DOBV0fH" +
          "IC9ICu/VklJSQ7odENlOTljqLgGkK8J8hrQkNfo+uAA4gL5RUBX7ALS/9DwfwVZBX8g/QNd" +
          "HxxADVijJCOjCww0V2QM1OwOlOcAyv9E1wcH1DKAMi8gByIaNgKpIcIFiGhExkqyCoVAeQk" +
          "iDJBfjS6ODPAaoCUqygNU8BLogSfYMFDuKTCp30HXN7AAAKarYBD/VuTqAAAAAElFTkSuQm" +
          "CC",
        width: "16",
        height: "16",
      });
    }

    function empty(el) {
      while (el && el.firstChild) el.removeChild(el.firstChild);
    }

    function getFirstChild(element) {
      let firstChild = element.firstChild;
      while (firstChild != null && firstChild.nodeType == 3) {
        firstChild = firstChild.nextSibling;
      }
      return firstChild;
    }

    function getNextSibling(element) {
      let nextSibling = element.nextSibling;
      while (nextSibling != null && nextSibling.nodeType == 3) {
        nextSibling = nextSibling.nextSibling;
      }
      return nextSibling;
    }

    function labeledRadio(name) {
      return (textContent, value, checked = false) =>
        createElement("label", {
          textContent,
          child: createElement("input", {
            type: radio,
            name,
            value,
            checked,
          }),
        });
    }

    function radio(name) {
      return (value, checked = false) =>
        createElement("input", {
          type: "radio",
          name,
          value,
          checked,
        });
    }

    function getRadioValue(container = document) {
      const found = Array.from(
        container.querySelectorAll('input[type="radio"]')
      ).find((el) => el.checked);
      return found ? found.value : null;
    }

    function spinner() {
      return createElement("div", { class: "spinner" });
    }

    function table(...children) {
      return HTML.createElement("table", { children });
    }

    function tableBody(...children) {
      return HTML.createElement("tbody", { children });
    }

    function tableHead(...children) {
      return HTML.createElement("thead", { children });
    }

    function row(...cells) {
      return HTML.createElement("tr", { children: cells });
    }

    function headerCell(attrs) {
      return stringShorthand("th", attrs);
    }

    function cell(attrs) {
      return stringShorthand("td", attrs);
    }

    function option(textContent, value) {
      if (value === undefined) value = textContent;
      return createElement("option", { textContent, value });
    }

    function stringShorthand(tagName, attrs) {
      if (typeof attrs === "string")
        return HTML.createElement(tagName, { textContent: attrs });
      else return HTML.createElement(tagName, attrs);
    }

    function modal({
      child,
      children,
      innerHTML,
      onClose = () => {
        return;
      },
      closeText = "Close",
      onOk = null,
      okText = "Ok",
      blocking = true,
      appendToBody = true,
    }) {
      const div = createElement("div", { class: "modal" });
      const buttonDiv = createElement("div");
      if (innerHTML) div.innerHTML = innerHTML;
      if (child) div.appendChild(child);
      if (children) children.forEach((child) => div.appendChild(child));
      if (blocking) div.classList.add("centered");
      const blocker = blocking
        ? createElement("div", { class: "overlay" })
        : null;
      const cleanup = () => {
        div.remove();
        blocker && blocker.remove();
      };
      const closeButton = createElement("button", {
        textContent: closeText,
        onClick: () => {
          onClose();
          cleanup();
        },
      });
      if (typeof onOk === "function") {
        const okButton = createElement("button", {
          class: "create",
          textContent: okText,
          onClick: () => {
            onOk({ modal: div });
            cleanup();
          },
        });
        buttonDiv.appendChild(okButton);
      }
      div.addEventListener("keydown", ({ key }) => {
        if (key === "Escape") cleanup();
        if (key === "Enter") {
          onOk({ modal: div });
          cleanup();
        }
      });
      buttonDiv.appendChild(closeButton);
      div.appendChild(buttonDiv);
      blocker && document.body.appendChild(blocker);
      appendToBody && document.body.appendChild(div);
      closeButton.focus();
      return div;
    }

    function heading1(textContent, attrs = {}) {
      return createElement("h1", { ...attrs, textContent });
    }

    function paragraph(textContent, attrs = {}) {
      return createElement("p", { ...attrs, textContent });
    }

    function toast(textContent) {
      const container = createElement("div", {
        class: "toast",
        textContent,
      });
      document.body.appendChild(container);
      window.setTimeout(() => container.remove(), 5000);
    }

    function page({ name, children, hidden = true, onClick, onKeydown }) {
      const div = createElement("div", {
        class: `${name}Container${hidden ? " hidden" : ""}`,
        children,
        onClick,
        onKeydown,
      });
      return div;
    }

    function labeledInput(textContent, inputAttrs = {}) {
      return createElement("label", {
        textContent,
        child: createElement("input", inputAttrs),
      });
    }

    function labeledDateInput(textContent, name) {
      return labeledInput(textContent, {
        name,
        type: "date",
        placeholder: "yyyy-mm-dd",
      });
    }

    function labeledCheckbox(textContent, name, checked = false) {
      return labeledInput(textContent, { name, type: "checkbox", checked });
    }

    function dateTimeInputs(namePrefix) {
      return [
        HTML.createElement("input", {
          type: "date",
          name: `${namePrefix}Date`,
          autocomplete: "off",
          placeholder: "mm/dd/yyyy",
        }),
        HTML.createElement("select", {
          name: `${namePrefix}Hour`,
          children: Utility.range(12, 1).map(HTML.option),
        }),
        document.createTextNode(":"),
        HTML.createElement("select", {
          name: `${namePrefix}Minute`,
          children: Utility.range(12, 0, 5).map((n) =>
            HTML.createElement("option", {
              textContent: String(n).padStart(2, "0"),
              value: n,
            })
          ),
        }),
        HTML.createElement("select", {
          name: `${namePrefix}AMPM`,
          children: ["AM", "PM"].map(HTML.option),
        }),
      ];
    }

    function button(textContent, attrs) {
      return createElement("button", { ...attrs, textContent });
    }
  })();
</script>
