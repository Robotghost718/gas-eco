<script>
/* exported  Item */
function Item({
  barcode = null,
  id = null,
  checkedOut = false,
  checkIn = null,
  checkOut = null,
  description = null,
  qty = 1,
  notes = null,
  missing = false
}) {
  "use strict";
  if (! (this instanceof Item)) {
    throw new Error("Item() needs to be called with `new`");
  }

  // private properties
  const serialized = Boolean(barcode) && (+barcode < 10000 || +barcode > 10100);
  let quantity = 1;              // {int}
  if (! isNaN(qty) && qty > 1) {
    quantity = qty;
  }

  // public properties
  this.barcode = barcode;        // {string}
  this.id = id;                  // {string}
  this.checkedOut = checkedOut;  // {bool}
  this.checkIn = checkIn;        // {string} formatted date
  this.checkOut = checkOut;      // {string} formatted date
  this.description = description;// {string} make, model, etc
  this.notes = notes;            // {string} saves the notes for the item
  this.missing = missing;        // {bool} true if item cannot be found when form is closed

  this.changeQuantity = function(integer) {
    if (serialized) {
      throw new Error("Cannot change quantity of a serialized item");
    }
    if (! isPositiveInteger(quantity + integer)) {
      throw new Error(`Invalid quantity: ${integer}`);
    }
    quantity += integer;
    return this;
  };
  this.setQuantity = function(integer) {
    if (serialized) {
      throw new Error("Cannot change quantity of a serialized item");
    }
    if (! isPositiveInteger(integer)) {
      throw new Error(`Invalid quantity: ${integer}`);
    }
    quantity = integer;
    return this;
  };
  this.getQuantity = function() {
    return quantity;
  };
  this.isSerialized = function() {
    return serialized;
  };
  // private helper functions
  function isPositiveInteger(integer) {
    return ! isNaN(integer) &&
      Math.floor(integer) === integer &&
      Math.abs(integer) === integer;
  }
}

// Item prototype functions

// shared properties
Item.prototype.cache = []; // Item[]

// getters
Item.prototype.getId = function() { return this.id; };
Item.prototype.getDescription = function() { return this.description; };
Item.prototype.getStripped = function() {
  return {
    id: this.id,
    description: this.description,
    quantity: this.quantity,
    barcode: this.barcode
  };
};
Item.prototype.isCheckedOut = function() { return this.checkedOut; };

// setters
Item.prototype.setBarcode = function(str) { this.barcode = str; return this; };
Item.prototype.setDescription = function(str) { this.description = str; return this; };
Item.prototype.setCheckedOut = function(bool) { this.checkedOut = Boolean(bool); return this; };

// utilities
Item.prototype.match = (item) => {
  if (this.id) {
    return item.id == this.id;
  } else if (! isNaN(+this.barcode) && +this.barcode < 10000) {
    return item.barcode == this.barcode;
  }
  if (this.description) {
    return item.description == this.description;
  }
  return false;
};


Item.prototype.getCached = function() {
  if (/^manual/i.test(this.id)) {
    this.checkedOut = true;
    this.checkIn = null;
    this.checkOut = null;
    this.missing = false;
    this.notes = "";
    return new Item(this);
  }
  const cachedItem = this.cache.find(item => item.match(this));
  if (! cachedItem) {
    throw new Error(`Cannot find ${this.description} ${this.id} in the inventory`);
  }
  return new Item(cachedItem);
};

/**
 * returns a minimal info object for use with JSON exporting
 */
Item.prototype.getStripped = function () {
  return {
    id: this.id,
    description: this.description,
    quantity: this.quantity,
    barcode: this.barcode
  };
};

Item.prototype.stringify = function() {
  const copy = Object.assign({}, this);
  copy.quantity = this.getQuantity();
  return JSON.stringify(copy);
};
</script>
